# Basic Auth Wrapper Added
import os, base64
from functools import wraps
from flask import request, Response

USERNAME = "admin"
PASSWORD = "Aujan123"

def check_auth(auth_header):
    if not auth_header: return False
    try:
        auth_type, creds = auth_header.split()
        if auth_type.lower() != "basic": return False
        decoded = base64.b64decode(creds).decode("utf-8")
        user, pwd = decoded.split(":")
        return user == USERNAME and pwd == PASSWORD
    except:
        return False

def require_basic_auth(server):
    @server.before_request
    def protect():
        auth = request.headers.get("Authorization")
        if not check_auth(auth):
            return Response(
                "Authentication Required", 401,
                {"WWW-Authenticate": 'Basic realm="Dashboard Login"'}
            )
    return server

# ---- User's Dashboard Code Begins ----
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 109,
   "id": "7d519893-16c5-4c9a-9ac5-f33c3bda5e11",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x27872b1f580>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "import re\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# -----------------------------\n",
    "# CONFIG\n",
    "# -----------------------------\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "# -----------------------------\n",
    "# UTIL FUNCTIONS\n",
    "# -----------------------------\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x): return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)): return pd.to_datetime(x)\n",
    "    s = str(x).strip()\n",
    "    fmts = [\"%d-%b-%Y\",\"%d-%b-%y\",\"%d-%b\",\"%Y-%m-%d\",\"%d/%m/%Y\",\"%d/%m/%y\",\"%Y/%m/%d\"]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s,f)\n",
    "            if f==\"%d-%b\": dt=dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except: continue\n",
    "    try: return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except: return pd.NaT\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for idx, row in df.iterrows():\n",
    "        inter = row.get(\"InterRotation\",\"\")\n",
    "        if inter.strip()==\"\":\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\",\"\"))\n",
    "                records.append({\n",
    "                    \"SKU\": row[\"SKU\"],\n",
    "                    \"Brand\": row[\"Brand\"],\n",
    "                    \"Branch\": branch_name,\n",
    "                    \"Cases\": cases\n",
    "                })\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "# -----------------------------\n",
    "# LOAD DATA\n",
    "# -----------------------------\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df.fillna(\"\", inplace=True)\n",
    "    col_map = {\n",
    "        \"Plant\":\"Plant\",\"AI_SKU\":\"SKU\",\"AI_MFGBRND\":\"Brand\",\"AI_BUSINESSUNIT\":\"BusinessUnit\",\n",
    "        \"AI_BRANCH\":\"Branch\",\"Class\":\"Class\",\"<10_Days\":\"DaysLess10\",\"OOS\":\"OOS\",\n",
    "        \"PlantInv %\":\"PlantInvPerc\",\"Upcoming_Plan\":\"UpcomingPlan\",\"Depletion_Date\":\"DepletionDate\",\n",
    "        \"Risk\":\"Risk\",\"BackOrder?\":\"BackOrder\",\"Oversell\":\"Oversell\",\"MTD Sales\":\"MTD_Sales\",\n",
    "        \"Forecast\":\"Forecast\",\"Avg_3MNTH_sales\":\"Avg_3MNTH_sales\",\"Inter_Rotation_Branches\":\"InterRotation\",\n",
    "        \"Balance Supply\":\"BalanceSupply\"  # new column mapping\n",
    "    }\n",
    "    df.rename(columns={c:col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    df[\"PlantInvPerc\"] = pd.to_numeric(df.get(\"PlantInvPerc\",\"0\").str.replace(\"%\",\"\"), errors=\"coerce\")/100.0\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\",\"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\",\"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(df.get(\"Avg_3MNTH_sales\",\"0\"), errors=\"coerce\")\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"Balance_Supply\",\"0\"), errors=\"coerce\")\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(lambda x:1 if str(x).lower() in [\"oos\",\"yes\",\"true\"] else 0)\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(lambda x:1 if str(x).lower() in [\"risk\",\"yes\",\"true\"] else 0)\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\"] else 0)\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\"] else 0)\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\"] else 0)\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (df[\"DepletionDate_parsed\"]-pd.to_datetime(datetime.today().date())).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.fillna(0)\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\",\"Longitude\"])\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# -----------------------------\n",
    "# DASH APP\n",
    "# -----------------------------\n",
    "app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])\n",
    "server = app.server\n",
    "\n",
    "# -----------------------------\n",
    "# FILTER OPTIONS\n",
    "# -----------------------------\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\",\"1-4\",\"5-6\",\"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\",\"No\"]\n",
    "\n",
    "def kpi_card(title,value,color=\"primary\"):\n",
    "    return dbc.Col(dbc.Card(\n",
    "        dbc.CardBody([\n",
    "            html.H6(title,className=\"card-title text-muted\", style={\"fontSize\":\"1rem\"}),\n",
    "            html.H5(value,className=\"card-text\", style={\"whiteSpace\":\"nowrap\",\"overflow\":\"hidden\",\"textOverflow\":\"ellipsis\",\"fontSize\":\"1.2rem\"})\n",
    "        ]),\n",
    "        className=f\"m-1 border-{color}\"\n",
    "    ), xs=6, sm=4, md=2, lg=2)\n",
    "\n",
    "# -----------------------------\n",
    "# DASH LAYOUT\n",
    "# -----------------------------\n",
    "app.layout = dbc.Container([\n",
    "    dbc.Row([\n",
    "        dbc.Col(html.H3(\"Inventory & Supply Dashboard\", style={\"fontSize\":\"2rem\"}), width=8),\n",
    "        dbc.Col(html.Div(id=\"last-refresh\", style={\"textAlign\":\"right\",\"fontSize\":\"0.8rem\"}), width=4)\n",
    "    ]),\n",
    "    dbc.Row([\n",
    "        dbc.Col(dcc.Dropdown(id=\"brand-filter\", options=[{\"label\":b,\"value\":b} for b in BRANDS],\n",
    "                             multi=True, placeholder=\"Select Brand\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"plant-filter\", options=[{\"label\":p,\"value\":p} for p in PLANTS],\n",
    "                             multi=True, placeholder=\"Select Plant\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"branch-filter\", options=[{\"label\":b,\"value\":b} for b in BRANCHES],\n",
    "                             multi=True, placeholder=\"Select Branch\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"class-filter\", options=[{\"label\":c,\"value\":c} for c in CLASSES],\n",
    "                             multi=True, placeholder=\"Select Class\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"busunit-filter\", options=[{\"label\":b,\"value\":b} for b in BUS_UNITS],\n",
    "                             multi=True, placeholder=\"Select BU\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"ai-sku-filter\", options=[{\"label\":s,\"value\":s} for s in AI_SKUS],\n",
    "                             multi=True, placeholder=\"Select SKU\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"branch-dc-filter\", options=[{\"label\":b,\"value\":b} for b in BRANCH_DC_FILTER],\n",
    "                             multi=True, placeholder=\"Select DC Days\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"oversell-filter\", options=[{\"label\":b,\"value\":b} for b in OVERSELL_FILTER],\n",
    "                             multi=True, placeholder=\"Select Oversell\"), md=2),\n",
    "    ], className=\"my-2\"),\n",
    "    dbc.Row(id=\"kpi-row\", className=\"row row-cols-2 row-cols-sm-3 row-cols-md-7 row-cols-lg-7 my-2\"),  # updated for 7th card\n",
    "    dbc.Tabs([\n",
    "        dbc.Tab(label=\"Overview\", tab_id=\"tab-overview\", children=[\n",
    "            dbc.Row([\n",
    "                dbc.Col(dcc.Graph(id=\"plant-inv-chart\", style={\"height\":\"700px\"}), md=6),\n",
    "                dbc.Col(dcc.Graph(id=\"oos-risk-bar\", style={\"height\":\"750px\"}), md=6)\n",
    "            ])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Branch OOS Treemap\", tab_id=\"tab-treemap\", children=[\n",
    "            dbc.Row([dbc.Col(dcc.Graph(id=\"branch-oos-treemap\", style={\"height\":\"600px\"}), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Information\", tab_id=\"tab-info\", children=[\n",
    "            dbc.Row([dbc.Col(dash_table.DataTable(\n",
    "                id=\"info-table\",\n",
    "                columns=[],  # set in callback\n",
    "                data=[],\n",
    "                page_size=15,\n",
    "                export_format='xlsx',\n",
    "                merge_duplicate_headers=True,\n",
    "                style_table={'overflowX':'auto'},\n",
    "                style_cell={'fontSize':10,'padding':'3px','whiteSpace':'nowrap'},\n",
    "                style_header={'position':'sticky','top':0,'backgroundColor':'#f8f9fa','fontWeight':'bold'},\n",
    "                style_data_conditional=[{'if':{'row_index':'odd'},'backgroundColor':'#f2f2f2'}],\n",
    "                row_selectable='multi'\n",
    "            ), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Stock Criticality\", tab_id=\"tab-crit\", children=[\n",
    "            dbc.Row([dbc.Col(dash_table.DataTable(\n",
    "                id=\"crit-table\",\n",
    "                columns=[],\n",
    "                data=[],\n",
    "                page_size=15,\n",
    "                export_format='xlsx',\n",
    "                style_table={'overflowX':'auto'},\n",
    "                style_cell={'fontSize':10,'padding':'3px','whiteSpace':'nowrap'},\n",
    "                style_header={'position':'sticky','top':0,'backgroundColor':'#f8f9fa','fontWeight':'bold'},\n",
    "                style_data_conditional=[{'if':{'row_index':'odd'},'backgroundColor':'#f2f2f2'}]\n",
    "            ), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Inter Rotation\", tab_id=\"tab-inter\", children=[\n",
    "            dbc.Row([dbc.Col(dcc.Graph(id=\"inter-rotation-map\", style={\"height\":\"700px\"}), md=12)])\n",
    "        ])\n",
    "    ], id=\"tabs\", active_tab=\"tab-overview\")\n",
    "])\n",
    "\n",
    "# -----------------------------\n",
    "# CALLBACK\n",
    "# -----------------------------\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\",\"children\"),\n",
    "    Output(\"plant-inv-chart\",\"figure\"),\n",
    "    Output(\"oos-risk-bar\",\"figure\"),\n",
    "    Output(\"branch-oos-treemap\",\"figure\"),\n",
    "    Output(\"info-table\",\"columns\"),\n",
    "    Output(\"info-table\",\"data\"),\n",
    "    Output(\"crit-table\",\"columns\"),\n",
    "    Output(\"crit-table\",\"data\"),\n",
    "    Output(\"inter-rotation-map\",\"figure\"),\n",
    "    Output(\"last-refresh\",\"children\"),\n",
    "    Input(\"brand-filter\",\"value\"),\n",
    "    Input(\"plant-filter\",\"value\"),\n",
    "    Input(\"branch-filter\",\"value\"),\n",
    "    Input(\"class-filter\",\"value\"),\n",
    "    Input(\"busunit-filter\",\"value\"),\n",
    "    Input(\"ai-sku-filter\",\"value\"),\n",
    "    Input(\"branch-dc-filter\",\"value\"),\n",
    "    Input(\"oversell-filter\",\"value\")\n",
    ")\n",
    "def update_dashboard(brands,plants,branches,classes,busunits,ai_skus,branch_dc,oversell):\n",
    "    dff = df_full.copy()\n",
    "    if brands: dff=dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants: dff=dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches: dff=dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes: dff=dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits: dff=dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus: dff=dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v==\"Yes\" else 0 for v in oversell]\n",
    "        dff=dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # Branch DC filter applied only to info/KPIs\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False,index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b==\"0\": mask |= (dff_filtered[\"DaysToDepletion\"]<=0)\n",
    "            if b==\"1-4\": mask |= dff_filtered[\"DaysToDepletion\"].between(1,4)\n",
    "            if b==\"5-6\": mask |= dff_filtered[\"DaysToDepletion\"].between(5,6)\n",
    "            if b==\"7-10\": mask |= dff_filtered[\"DaysToDepletion\"].between(7,10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # KPI Cards\n",
    "    cards = [\n",
    "        kpi_card(\"Total SKUs 0-10 Days Cover\",dff_filtered[\"SKU\"].nunique()),\n",
    "        kpi_card(\"Total OOS SKUs by Branch\",dff_filtered[\"IsOOS\"].sum()),\n",
    "        kpi_card(\"Total Supply Risk SKUs\",dff_filtered[\"IsRisk\"].sum()),\n",
    "        kpi_card(\"Total Backorder SKUs\",dff_filtered[\"IsBackorder\"].sum()),\n",
    "        kpi_card(\"<10d Cover SKUs\",dff_filtered[\"IsLowCover\"].sum()),\n",
    "        kpi_card(\"Oversell SKUs\",dff_filtered[\"IsOversell\"].sum()),\n",
    "        kpi_card(\"Balance Supply - Cases\", f\"{int(dff_filtered['BalanceSupply'].sum()):,}\")  # new card\n",
    "    ]\n",
    "\n",
    "    # Convert date columns to date only\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # -----------------------------\n",
    "    # Plant Inventory Treemap with Balance Supply hover\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered['PlantInvPerc_safe'] = dff_filtered['PlantInvPerc'].replace(0,0.001)\n",
    "        # Aggregate Balance Supply by Plant → Brand → SKU\n",
    "        agg_cols = ['Plant','Brand','SKU']\n",
    "        dff_agg = dff_filtered.groupby(agg_cols).agg({\n",
    "        'PlantInvPerc_safe':'sum',\n",
    "        'PlantInvPerc':'mean',  # keep original % color scale\n",
    "        'BalanceSupply':'sum'   # sum up Balance Supply per SKU per Plant\n",
    "    }).reset_index()\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg, path=['Plant','Brand','SKU'], values='PlantInvPerc_safe',\n",
    "            color='PlantInvPerc', color_continuous_scale='RdYlGn',\n",
    "            hover_data={'SKU':True, 'PlantInvPerc':':.1%', 'BalanceSupply': True}\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate='%{label}<br>%{value:.0%}',\n",
    "            hovertemplate='<b>%{label}</b><br>PlantInvPerc: %{customdata[1]:.1%}<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>'\n",
    "        )\n",
    "        fig_inv.update_layout(title=\"Plant Inventory\", margin=dict(t=50,l=25,r=25,b=25))\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # OOS & Risk Bar Chart\n",
    "    summary_df = dff_filtered.groupby(\"Brand\").agg(OOS_Count=(\"IsOOS\",\"sum\"), Risk_Count=(\"IsRisk\",\"sum\")).reset_index()\n",
    "    fig_bar = go.Figure()\n",
    "    fig_bar.add_trace(go.Bar(name=\"OOS SKUs\", x=summary_df[\"Brand\"], y=summary_df[\"OOS_Count\"], marker_color='red', text=summary_df[\"OOS_Count\"], textposition='outside'))\n",
    "    fig_bar.add_trace(go.Bar(name=\"Risk SKUs\", x=summary_df[\"Brand\"], y=summary_df[\"Risk_Count\"], marker_color='orange', text=summary_df[\"Risk_Count\"], textposition='outside'))\n",
    "    fig_bar.update_layout(barmode='group', title=\"OOS & Risk SKUs by Brand\", height=650, margin=dict(t=80,b=150))\n",
    "\n",
    "    # Branch OOS Treemap\n",
    "    treemap_df = dff.groupby([\"Branch\",\"Brand\",\"SKU\"])[\"BalanceSupply\"].sum().reset_index(name=\"BalanceSupply\")\n",
    "\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\",\"Brand\",\"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\",\"BalanceSupply\"]  # only what you want to show\n",
    "    )\n",
    "\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate='<b>SKU:</b> %{customdata[0]}'\n",
    "                      '<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>'\n",
    "    )\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "        fig_treemap.update_layout(height=600)\n",
    "\n",
    "    # Info Table with Balance Supply column\n",
    "    info_columns = [\n",
    "        {\"name\":\"Plant\",\"id\":\"Plant\",\"type\":\"text\"},\n",
    "        {\"name\":\"SKU\",\"id\":\"SKU\",\"type\":\"text\"},\n",
    "        {\"name\":\"Brand\",\"id\":\"Brand\",\"type\":\"text\"},\n",
    "        {\"name\":\"BusinessUnit\",\"id\":\"BusinessUnit\",\"type\":\"text\"},\n",
    "        {\"name\":\"Branch\",\"id\":\"Branch\",\"type\":\"text\"},\n",
    "        {\"name\":\"Class\",\"id\":\"Class\",\"type\":\"text\"},\n",
    "        {\"name\":\"DaysLess10\",\"id\":\"DaysLess10\",\"type\":\"text\"},\n",
    "        {\"name\":\"OOS\",\"id\":\"OOS\",\"type\":\"text\"},\n",
    "        {\"name\":\"PlantInvPerc\",\"id\":\"PlantInvPerc\",\"type\":\"numeric\", \"format\": FormatTemplate.percentage(1)},\n",
    "        {\"name\":\"Oversell\",\"id\":\"Oversell\",\"type\":\"text\"},\n",
    "        {\"name\":\"Risk\",\"id\":\"Risk\",\"type\":\"text\"},\n",
    "        {\"name\":\"MTD_Sales\",\"id\":\"MTD_Sales\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"Forecast\",\"id\":\"Forecast\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"Avg_3MNTH_sales\",\"id\":\"Avg_3MNTH_sales\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"BalanceSupply\",\"id\":\"BalanceSupply\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},  # new column\n",
    "        {\"name\":\"UpcomingPlan\",\"id\":\"UpcomingPlan\",\"type\":\"text\"},\n",
    "        {\"name\":\"DepletionDate\",\"id\":\"DepletionDate\",\"type\":\"text\"}\n",
    "    ]\n",
    "    table_data = dff_filtered[ [c[\"id\"] for c in info_columns] ].to_dict(\"records\")\n",
    "\n",
    "    # Stock Criticality Table\n",
    "    if not df_crit.empty:\n",
    "        crit_pivot = df_crit.melt(id_vars=[\"AI_SKU\",\"AI_MFGBRND\",\"Class\",\"Country\"], var_name=\"Branch\", value_name=\"DaysCover\")\n",
    "        crit_table = crit_pivot.pivot_table(index=[\"AI_SKU\",\"AI_MFGBRND\"], columns=\"Branch\", values=\"DaysCover\", fill_value=0).reset_index()\n",
    "        crit_columns = []\n",
    "        for c in crit_table.columns:\n",
    "            if c in [\"AI_SKU\",\"AI_MFGBRND\"]:\n",
    "                crit_columns.append({\"name\":c,\"id\":c,\"type\":\"text\"})\n",
    "            else:\n",
    "                crit_columns.append({\"name\":c,\"id\":c,\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)})\n",
    "        crit_data = crit_table.to_dict(\"records\")\n",
    "    else:\n",
    "        crit_columns, crit_data = [], []\n",
    "\n",
    "    # Inter Rotation Map\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\").dropna(subset=[\"Latitude\",\"Longitude\"])\n",
    "        df_map[\"Label\"] = df_map.apply(lambda x: f\"{x['Branch']} ({x['Cases']}) - {x['Brand']}\", axis=1)\n",
    "        fig_inter = px.scatter_mapbox(df_map, lat=\"Latitude\", lon=\"Longitude\",\n",
    "                                      size=\"Cases\", color=\"Cases\", text=\"Label\",\n",
    "                                      hover_name=\"Label\", hover_data={\"Cases\":True,\"Latitude\": False, \"Longitude\": False},\n",
    "                                      zoom=4, mapbox_style=\"carto-positron\",\n",
    "                                      title=\"Inter Rotation Map\", size_max=30)\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    return cards, fig_inv, fig_bar, fig_treemap, info_columns, table_data, crit_columns, crit_data, fig_inter, f\"Last refresh: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\"\n",
    "\n",
    "# -----------------------------\n",
    "# RUN DASH\n",
    "# -----------------------------\n",
    "if __name__==\"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "69c05e11-2e58-4c40-b7fe-1a8d9ed8a706",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c76b0fa0>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "---------------------------------------------------------------------------\n",
      "TypeError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\728016296.py in update_dashboard(\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None\n",
      ")\n",
      "    272             return row[\"BalanceSupply\"] - row[\"Total_SKU_Plant_Inventory\"]\n",
      "    273 \n",
      "--> 274     oos_calc[\"OOS_Cases\"] = oos_calc.apply(compute_oos, axis=1)\n",
      "        oos_calc =                                                   SKU Plant  BalanceSupply  \\\n",
      "0                               0106 VIMTO COR 710x12  ASDI        31527.0   \n",
      "1                 0117 VIMTO LMN BERRY CAN 250ML X 30  ASDI           79.0   \n",
      "2           0161 VIMTO CSD FRUIT FLAVOR CAN 330MLX6X4  ASDI          439.0   \n",
      "3                   0191 VIMTO CAN BLUE RAS 250X6X4MP  ASDI          229.0   \n",
      "4              0210 VIMTO FIZZY ZERO CSD CAN 250MLX30  ASDI           24.4   \n",
      "..                                                ...   ...            ...   \n",
      "73                       263 VIMTO CORDIAL 650ML X 12  ASDI         6380.0   \n",
      "74  2878 BBN TURBO CARBONATED MAL T DRINK BERRY 24...  ASDI         1101.0   \n",
      "75  2880 BBN TURBO CARBONATED MAL T DRINK KIWI LIM...  ASDI          143.0   \n",
      "76  2881 BBN TURBO CARBONATED MAL T DRINK ORIGINAL...  ASDI         1262.0   \n",
      "77               2902 VIMTO 250ML PET BLACK FORT X 24  ASDI         3037.0   \n",
      "\n",
      "   Total_SKU_Plant_Inventory  \n",
      "0                     194709  \n",
      "1                          0  \n",
      "2                          0  \n",
      "3                       2992  \n",
      "4                       1200  \n",
      "..                       ...  \n",
      "73                     14614  \n",
      "74                         0  \n",
      "75                      2640  \n",
      "76                      1171  \n",
      "77                     42739  \n",
      "\n",
      "[78 rows x 4 columns]\n",
      "        oos_calc.apply = <bound method DataFrame.apply of                                                   SKU Plant  BalanceSupply  \\\n",
      "0                               0106 VIMTO COR 710x12  ASDI        31527.0   \n",
      "1                 0117 VIMTO LMN BERRY CAN 250ML X 30  ASDI           79.0   \n",
      "2           0161 VIMTO CSD FRUIT FLAVOR CAN 330MLX6X4  ASDI          439.0   \n",
      "3                   0191 VIMTO CAN BLUE RAS 250X6X4MP  ASDI          229.0   \n",
      "4              0210 VIMTO FIZZY ZERO CSD CAN 250MLX30  ASDI           24.4   \n",
      "..                                                ...   ...            ...   \n",
      "73                       263 VIMTO CORDIAL 650ML X 12  ASDI         6380.0   \n",
      "74  2878 BBN TURBO CARBONATED MAL T DRINK BERRY 24...  ASDI         1101.0   \n",
      "75  2880 BBN TURBO CARBONATED MAL T DRINK KIWI LIM...  ASDI          143.0   \n",
      "76  2881 BBN TURBO CARBONATED MAL T DRINK ORIGINAL...  ASDI         1262.0   \n",
      "77               2902 VIMTO 250ML PET BLACK FORT X 24  ASDI         3037.0   \n",
      "\n",
      "   Total_SKU_Plant_Inventory  \n",
      "0                     194709  \n",
      "1                          0  \n",
      "2                          0  \n",
      "3                       2992  \n",
      "4                       1200  \n",
      "..                       ...  \n",
      "73                     14614  \n",
      "74                         0  \n",
      "75                      2640  \n",
      "76                      1171  \n",
      "77                     42739  \n",
      "\n",
      "[78 rows x 4 columns]>\n",
      "        compute_oos = <function update_dashboard.<locals>.compute_oos at 0x00000223C74248B0>\n",
      "        global axis = undefined\n",
      "    275 \n",
      "    276 # Total OOS cases across all SKU × Plant\n",
      "\n",
      "~\\Anaconda3\\lib\\site-packages\\pandas\\core\\frame.py in apply(\n",
      "    self=                                                ...                   42739  \n",
      "\n",
      "[78 rows x 4 columns],\n",
      "    func=<function update_dashboard.<locals>.compute_oos>,\n",
      "    axis=1,\n",
      "    raw=False,\n",
      "    result_type=None,\n",
      "    args=(),\n",
      "    by_row='compat',\n",
      "    engine='python',\n",
      "    engine_kwargs=None,\n",
      "    **kwargs={}\n",
      ")\n",
      "  10379             kwargs=kwargs,\n",
      "  10380         )\n",
      "> 10381         return op.apply().__finalize__(self, method=\"apply\")\n",
      "        op.apply.__finalize__ = undefined\n",
      "        self =                                                   SKU Plant  BalanceSupply  \\\n",
      "0                               0106 VIMTO COR 710x12  ASDI        31527.0   \n",
      "1                 0117 VIMTO LMN BERRY CAN 250ML X 30  ASDI           79.0   \n",
      "2           0161 VIMTO CSD FRUIT FLAVOR CAN 330MLX6X4  ASDI          439.0   \n",
      "3                   0191 VIMTO CAN BLUE RAS 250X6X4MP  ASDI          229.0   \n",
      "4              0210 VIMTO FIZZY ZERO CSD CAN 250MLX30  ASDI           24.4   \n",
      "..                                                ...   ...            ...   \n",
      "73                       263 VIMTO CORDIAL 650ML X 12  ASDI         6380.0   \n",
      "74  2878 BBN TURBO CARBONATED MAL T DRINK BERRY 24...  ASDI         1101.0   \n",
      "75  2880 BBN TURBO CARBONATED MAL T DRINK KIWI LIM...  ASDI          143.0   \n",
      "76  2881 BBN TURBO CARBONATED MAL T DRINK ORIGINAL...  ASDI         1262.0   \n",
      "77               2902 VIMTO 250ML PET BLACK FORT X 24  ASDI         3037.0   \n",
      "\n",
      "   Total_SKU_Plant_Inventory  \n",
      "0                     194709  \n",
      "1                          0  \n",
      "2                          0  \n",
      "3                       2992  \n",
      "4                       1200  \n",
      "..                       ...  \n",
      "73                     14614  \n",
      "74                         0  \n",
      "75                      2640  \n",
      "76                      1171  \n",
      "77                     42739  \n",
      "\n",
      "[78 rows x 4 columns]\n",
      "        global method = undefined\n",
      "  10382 \n",
      "  10383     def map(\n",
      "\n",
      "~\\Anaconda3\\lib\\site-packages\\pandas\\core\\apply.py in apply(\n",
      "    self=<pandas.core.apply.FrameColumnApply object>\n",
      ")\n",
      "    914             return self.apply_raw(engine=self.engine, engine_kwargs=self.engine_kwargs)\n",
      "    915 \n",
      "--> 916         return self.apply_standard()\n",
      "        self.apply_standard = <bound method FrameApply.apply_standard of <pandas.core.apply.FrameColumnApply object at 0x00000223C763B100>>\n",
      "    917 \n",
      "    918     def agg(self):\n",
      "\n",
      "~\\Anaconda3\\lib\\site-packages\\pandas\\core\\apply.py in apply_standard(\n",
      "    self=<pandas.core.apply.FrameColumnApply object>\n",
      ")\n",
      "   1061     def apply_standard(self):\n",
      "   1062         if self.engine == \"python\":\n",
      "-> 1063             results, res_index = self.apply_series_generator()\n",
      "        results = undefined\n",
      "        res_index = undefined\n",
      "        self.apply_series_generator = <bound method FrameApply.apply_series_generator of <pandas.core.apply.FrameColumnApply object at 0x00000223C763B100>>\n",
      "   1064         else:\n",
      "   1065             results, res_index = self.apply_series_numba()\n",
      "\n",
      "~\\Anaconda3\\lib\\site-packages\\pandas\\core\\apply.py in apply_series_generator(\n",
      "    self=<pandas.core.apply.FrameColumnApply object>\n",
      ")\n",
      "   1079             for i, v in enumerate(series_gen):\n",
      "   1080                 # ignore SettingWithCopy here in case the user mutates\n",
      "-> 1081                 results[i] = self.func(v, *self.args, **self.kwargs)\n",
      "        results = {}\n",
      "        i = 0\n",
      "        self.func = <function update_dashboard.<locals>.compute_oos at 0x00000223C74248B0>\n",
      "        v = SKU                          0106 VIMTO COR 710x12\n",
      "Plant                                         ASDI\n",
      "BalanceSupply                              31527.0\n",
      "Total_SKU_Plant_Inventory                   194709\n",
      "Name: 0, dtype: object\n",
      "        self.args = ()\n",
      "        self.kwargs = {}\n",
      "   1082                 if isinstance(results[i], ABCSeries):\n",
      "   1083                     # If we have a view on v, we need to make a copy because\n",
      "\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\728016296.py in compute_oos(\n",
      "    row=SKU                          0106 VIMTO COR 710x...y                   194709\n",
      "Name: 0, dtype: object\n",
      ")\n",
      "    267 # Apply final check logic\n",
      "    268     def compute_oos(row):\n",
      "--> 269         if row[\"BalanceSupply\"] < row[\"Total_SKU_Plant_Inventory\"]:\n",
      "        row = SKU                          0106 VIMTO COR 710x12\n",
      "Plant                                         ASDI\n",
      "BalanceSupply                              31527.0\n",
      "Total_SKU_Plant_Inventory                   194709\n",
      "Name: 0, dtype: object\n",
      "    270             return 0\n",
      "    271         else:\n",
      "\n",
      "TypeError: '<' not supported between instances of 'float' and 'str'\n",
      "\n",
      "20632.013375999995\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\thahasin.javath\\AppData\\Local\\Temp\\ipykernel_28612\\728016296.py:256: UserWarning:\n",
      "\n",
      "Boolean Series key will be reindexed to match DataFrame index.\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "555.25\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\thahasin.javath\\AppData\\Local\\Temp\\ipykernel_28612\\728016296.py:256: UserWarning:\n",
      "\n",
      "Boolean Series key will be reindexed to match DataFrame index.\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "2634.25\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\thahasin.javath\\AppData\\Local\\Temp\\ipykernel_28612\\728016296.py:256: UserWarning:\n",
      "\n",
      "Boolean Series key will be reindexed to match DataFrame index.\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "4328.5\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "import re\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# -----------------------------\n",
    "# CONFIG\n",
    "# -----------------------------\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "# -----------------------------\n",
    "# UTIL FUNCTIONS\n",
    "# -----------------------------\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x): return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)): return pd.to_datetime(x)\n",
    "    s = str(x).strip()\n",
    "    fmts = [\"%d-%b-%Y\",\"%d-%b-%y\",\"%d-%b\",\"%Y-%m-%d\",\"%d/%m/%Y\",\"%d/%m/%y\",\"%Y/%m/%d\"]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s,f)\n",
    "            if f==\"%d-%b\": dt=dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except: continue\n",
    "    try: return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except: return pd.NaT\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for idx, row in df.iterrows():\n",
    "        inter = row.get(\"InterRotation\",\"\")\n",
    "        if inter.strip()==\"\":\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\",\"\"))\n",
    "                records.append({\n",
    "                    \"SKU\": row[\"SKU\"],\n",
    "                    \"Brand\": row[\"Brand\"],\n",
    "                    \"Branch\": branch_name,\n",
    "                    \"Cases\": cases\n",
    "                })\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "# -----------------------------\n",
    "# LOAD DATA\n",
    "# -----------------------------\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df.fillna(\"\", inplace=True)\n",
    "    col_map = {\n",
    "        \"Plant\":\"Plant\",\"AI_SKU\":\"SKU\",\"AI_MFGBRND\":\"Brand\",\"AI_BUSINESSUNIT\":\"BusinessUnit\",\n",
    "        \"AI_BRANCH\":\"Branch\",\"Class\":\"Class\",\"<10_Days\":\"DaysLess10\",\"OOS\":\"OOS\",\n",
    "        \"PlantInv %\":\"PlantInvPerc\",\"Upcoming_Plan\":\"UpcomingPlan\",\"Depletion_Date\":\"DepletionDate\",\n",
    "        \"Risk\":\"Risk\",\"BackOrder?\":\"BackOrder\",\"Oversell\":\"Oversell\",\"MTD Sales\":\"MTD_Sales\",\n",
    "        \"Forecast\":\"Forecast\",\"Avg_3MNTH_sales\":\"Avg_3MNTH_sales\",\"Inter_Rotation_Branches\":\"InterRotation\",\n",
    "        \"Balance Supply\":\"BalanceSupply\"  # new column mapping\n",
    "    }\n",
    "    df.rename(columns={c:col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    df[\"PlantInvPerc\"] = pd.to_numeric(df.get(\"PlantInvPerc\",\"0\").str.replace(\"%\",\"\"), errors=\"coerce\")/100.0\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\",\"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\",\"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(df.get(\"Avg_3MNTH_sales\",\"0\"), errors=\"coerce\")\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"Balance_Supply\",\"0\"), errors=\"coerce\")\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(lambda x:1 if str(x).lower() in [\"oos\",\"yes\",\"true\"] else 0)\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(lambda x:1 if str(x).lower() in [\"risk\",\"yes\",\"true\"] else 0)\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\"] else 0)\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\"] else 0)\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\"] else 0)\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (df[\"DepletionDate_parsed\"]-pd.to_datetime(datetime.today().date())).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.fillna(0)\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\",\"Longitude\"])\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# -----------------------------\n",
    "# DASH APP\n",
    "# -----------------------------\n",
    "app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])\n",
    "server = app.server\n",
    "\n",
    "# -----------------------------\n",
    "# FILTER OPTIONS\n",
    "# -----------------------------\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\",\"1-4\",\"5-6\",\"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\",\"No\"]\n",
    "\n",
    "def kpi_card(title,value,color=\"primary\"):\n",
    "    return dbc.Col(dbc.Card(\n",
    "        dbc.CardBody([\n",
    "            html.H6(title,className=\"card-title text-muted\", style={\"fontSize\":\"1rem\"}),\n",
    "            html.H5(value,className=\"card-text\", style={\"whiteSpace\":\"nowrap\",\"overflow\":\"hidden\",\"textOverflow\":\"ellipsis\",\"fontSize\":\"1.2rem\"})\n",
    "        ]),\n",
    "        className=f\"m-1 border-{color}\"\n",
    "    ), xs=6, sm=4, md=2, lg=2)\n",
    "\n",
    "# -----------------------------\n",
    "# DASH LAYOUT\n",
    "# -----------------------------\n",
    "app.layout = dbc.Container([\n",
    "    dbc.Row([\n",
    "        dbc.Col(html.H3(\"Inventory & Supply Dashboard\", style={\"fontSize\":\"2rem\"}), width=8),\n",
    "        dbc.Col(html.Div(id=\"last-refresh\", style={\"textAlign\":\"right\",\"fontSize\":\"0.8rem\"}), width=4)\n",
    "    ]),\n",
    "    dbc.Row([\n",
    "        dbc.Col(dcc.Dropdown(id=\"brand-filter\", options=[{\"label\":b,\"value\":b} for b in BRANDS],\n",
    "                             multi=True, placeholder=\"Select Brand\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"plant-filter\", options=[{\"label\":p,\"value\":p} for p in PLANTS],\n",
    "                             multi=True, placeholder=\"Select Plant\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"branch-filter\", options=[{\"label\":b,\"value\":b} for b in BRANCHES],\n",
    "                             multi=True, placeholder=\"Select Branch\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"class-filter\", options=[{\"label\":c,\"value\":c} for c in CLASSES],\n",
    "                             multi=True, placeholder=\"Select Class\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"busunit-filter\", options=[{\"label\":b,\"value\":b} for b in BUS_UNITS],\n",
    "                             multi=True, placeholder=\"Select BU\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"ai-sku-filter\", options=[{\"label\":s,\"value\":s} for s in AI_SKUS],\n",
    "                             multi=True, placeholder=\"Select SKU\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"branch-dc-filter\", options=[{\"label\":b,\"value\":b} for b in BRANCH_DC_FILTER],\n",
    "                             multi=True, placeholder=\"Select DC Days\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"oversell-filter\", options=[{\"label\":b,\"value\":b} for b in OVERSELL_FILTER],\n",
    "                             multi=True, placeholder=\"Select Oversell\"), md=2),\n",
    "    ], className=\"my-2\"),\n",
    "    dbc.Row(id=\"kpi-row\", className=\"row row-cols-2 row-cols-sm-3 row-cols-md-7 row-cols-lg-7 my-2\"),  # updated for 7th card\n",
    "    dbc.Tabs([\n",
    "        dbc.Tab(label=\"Overview\", tab_id=\"tab-overview\", children=[\n",
    "            dbc.Row([\n",
    "                dbc.Col(dcc.Graph(id=\"plant-inv-chart\", style={\"height\":\"700px\"}), md=6),\n",
    "                dbc.Col(dcc.Graph(id=\"oos-risk-bar\", style={\"height\":\"750px\"}), md=6)\n",
    "            ])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Branch OOS Treemap\", tab_id=\"tab-treemap\", children=[\n",
    "            dbc.Row([dbc.Col(dcc.Graph(id=\"branch-oos-treemap\", style={\"height\":\"600px\"}), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Information\", tab_id=\"tab-info\", children=[\n",
    "            dbc.Row([dbc.Col(dash_table.DataTable(\n",
    "                id=\"info-table\",\n",
    "                columns=[],  # set in callback\n",
    "                data=[],\n",
    "                page_size=15,\n",
    "                export_format='xlsx',\n",
    "                merge_duplicate_headers=True,\n",
    "                style_table={'overflowX':'auto'},\n",
    "                style_cell={'fontSize':10,'padding':'3px','whiteSpace':'nowrap'},\n",
    "                style_header={'position':'sticky','top':0,'backgroundColor':'#f8f9fa','fontWeight':'bold'},\n",
    "                style_data_conditional=[{'if':{'row_index':'odd'},'backgroundColor':'#f2f2f2'}],\n",
    "                row_selectable='multi'\n",
    "            ), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Stock Criticality\", tab_id=\"tab-crit\", children=[\n",
    "            dbc.Row([dbc.Col(dash_table.DataTable(\n",
    "                id=\"crit-table\",\n",
    "                columns=[],\n",
    "                data=[],\n",
    "                page_size=15,\n",
    "                export_format='xlsx',\n",
    "                style_table={'overflowX':'auto'},\n",
    "                style_cell={'fontSize':10,'padding':'3px','whiteSpace':'nowrap'},\n",
    "                style_header={'position':'sticky','top':0,'backgroundColor':'#f8f9fa','fontWeight':'bold'},\n",
    "                style_data_conditional=[{'if':{'row_index':'odd'},'backgroundColor':'#f2f2f2'}]\n",
    "            ), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Inter Rotation\", tab_id=\"tab-inter\", children=[\n",
    "            dbc.Row([dbc.Col(dcc.Graph(id=\"inter-rotation-map\", style={\"height\":\"700px\"}), md=12)])\n",
    "        ])\n",
    "    ], id=\"tabs\", active_tab=\"tab-overview\")\n",
    "])\n",
    "\n",
    "# -----------------------------\n",
    "# CALLBACK\n",
    "# -----------------------------\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\",\"children\"),\n",
    "    Output(\"plant-inv-chart\",\"figure\"),\n",
    "    Output(\"oos-risk-bar\",\"figure\"),\n",
    "    Output(\"branch-oos-treemap\",\"figure\"),\n",
    "    Output(\"info-table\",\"columns\"),\n",
    "    Output(\"info-table\",\"data\"),\n",
    "    Output(\"crit-table\",\"columns\"),\n",
    "    Output(\"crit-table\",\"data\"),\n",
    "    Output(\"inter-rotation-map\",\"figure\"),\n",
    "    Output(\"last-refresh\",\"children\"),\n",
    "    Input(\"brand-filter\",\"value\"),\n",
    "    Input(\"plant-filter\",\"value\"),\n",
    "    Input(\"branch-filter\",\"value\"),\n",
    "    Input(\"class-filter\",\"value\"),\n",
    "    Input(\"busunit-filter\",\"value\"),\n",
    "    Input(\"ai-sku-filter\",\"value\"),\n",
    "    Input(\"branch-dc-filter\",\"value\"),\n",
    "    Input(\"oversell-filter\",\"value\")\n",
    ")\n",
    "def update_dashboard(brands,plants,branches,classes,busunits,ai_skus,branch_dc,oversell):\n",
    "    dff = df_full.copy()\n",
    "    if brands: dff=dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants: dff=dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches: dff=dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes: dff=dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits: dff=dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus: dff=dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v==\"Yes\" else 0 for v in oversell]\n",
    "        dff=dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # Branch DC filter applied only to info/KPIs\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False,index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b==\"0\": mask |= (dff_filtered[\"DaysToDepletion\"]<=0)\n",
    "            if b==\"1-4\": mask |= dff_filtered[\"DaysToDepletion\"].between(1,4)\n",
    "            if b==\"5-6\": mask |= dff_filtered[\"DaysToDepletion\"].between(5,6)\n",
    "            if b==\"7-10\": mask |= dff_filtered[\"DaysToDepletion\"].between(7,10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # Ensure numeric\n",
    "    df_full[\"BalanceSupply\"] = pd.to_numeric(df_full[\"BalanceSupply\"], errors=\"coerce\").fillna(0)\n",
    "    df_full[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(df_full[\"Total_SKU_Plant_Inventory\"], errors=\"coerce\").fillna(0)\n",
    "\n",
    "# Filter rows with positive BalanceSupply\n",
    "    dff_oos = dff_filtered[df_full[\"BalanceSupply\"] > 0]\n",
    "\n",
    "# Sum BalanceSupply across all branches per SKU per Plant\n",
    "    balance_supply_per_sku_plant = dff_oos.groupby([\"SKU\",\"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "\n",
    "# Take max Plant Inventory per SKU per Plant\n",
    "    plant_max_inv = dff_oos.groupby([\"SKU\",\"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "\n",
    "# Merge\n",
    "    oos_calc = balance_supply_per_sku_plant.merge(plant_max_inv, on=[\"SKU\",\"Plant\"], how=\"left\")\n",
    "\n",
    "# Apply final check logic\n",
    "    def compute_oos(row):\n",
    "        if row[\"BalanceSupply\"] < row[\"Total_SKU_Plant_Inventory\"]:\n",
    "            return 0\n",
    "        else:\n",
    "            return row[\"BalanceSupply\"] - row[\"Total_SKU_Plant_Inventory\"]\n",
    "\n",
    "    oos_calc[\"OOS_Cases\"] = oos_calc.apply(compute_oos, axis=1)\n",
    "\n",
    "# Total OOS cases across all SKU × Plant\n",
    "    total_oos_cases = oos_calc[\"OOS_Cases\"].sum()\n",
    "    print(total_oos_cases)\n",
    "\n",
    "\n",
    "    # KPI Cards\n",
    "    cards = [\n",
    "        kpi_card(\"Total SKUs 0-10 Days Cover\", dff_filtered[\"SKU\"].nunique()),\n",
    "        kpi_card(\"Balance Supply - Cases\", f\"{int(dff_filtered['BalanceSupply'].sum()):,}\"),\n",
    "        kpi_card(\"Total OOS Cases\", f\"{int(total_oos_cases):,}\", color=\"danger\"),\n",
    "        kpi_card(\"Total Supply Risk SKUs\", dff_filtered[\"IsRisk\"].sum()),\n",
    "        kpi_card(\"Total Backorder SKUs\", dff_filtered[\"IsBackorder\"].sum()),\n",
    "        kpi_card(\"<10d Cover SKUs\", dff_filtered[\"IsLowCover\"].sum()),\n",
    "        kpi_card(\"Oversell SKUs\", dff_filtered[\"IsOversell\"].sum()),\n",
    "        \n",
    "    ]\n",
    "\n",
    "    # Convert date columns to date only\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # -----------------------------\n",
    "    # Plant Inventory Treemap\n",
    "    # -----------------------------\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered['PlantInvPerc_safe'] = dff_filtered['PlantInvPerc'].replace(0,0.001)\n",
    "        agg_cols = ['Plant','Brand','SKU']\n",
    "        dff_agg = dff_filtered.groupby(agg_cols).agg({\n",
    "            'PlantInvPerc_safe':'sum',\n",
    "            'PlantInvPerc':'mean',\n",
    "            'BalanceSupply':'sum'\n",
    "        }).reset_index()\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg, path=['Plant','Brand','SKU'], values='PlantInvPerc_safe',\n",
    "            color='PlantInvPerc', color_continuous_scale='RdYlGn',\n",
    "            hover_data={'SKU':True, 'PlantInvPerc':':.1%', 'BalanceSupply': True}\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate='%{label}<br>%{value:.0%}',\n",
    "            hovertemplate='<b>%{label}</b><br>PlantInvPerc: %{customdata[1]:.1%}<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>'\n",
    "        )\n",
    "        fig_inv.update_layout(title=\"Plant Inventory\", margin=dict(t=50,l=25,r=25,b=25))\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # -----------------------------\n",
    "    # OOS & Risk Bar Chart\n",
    "    # -----------------------------\n",
    "    summary_df = dff_filtered.groupby(\"Brand\").agg(OOS_Count=(\"IsOOS\",\"sum\"), Risk_Count=(\"IsRisk\",\"sum\")).reset_index()\n",
    "    fig_bar = go.Figure()\n",
    "    fig_bar.add_trace(go.Bar(name=\"OOS SKUs\", x=summary_df[\"Brand\"], y=summary_df[\"OOS_Count\"], marker_color='red', text=summary_df[\"OOS_Count\"], textposition='outside'))\n",
    "    fig_bar.add_trace(go.Bar(name=\"Risk SKUs\", x=summary_df[\"Brand\"], y=summary_df[\"Risk_Count\"], marker_color='orange', text=summary_df[\"Risk_Count\"], textposition='outside'))\n",
    "    fig_bar.update_layout(barmode='group', title=\"OOS & Risk SKUs by Brand\", height=650, margin=dict(t=80,b=150))\n",
    "\n",
    "    # -----------------------------\n",
    "    # Branch OOS Treemap\n",
    "    # -----------------------------\n",
    "    treemap_df = dff.groupby([\"Branch\",\"Brand\",\"SKU\"])[\"BalanceSupply\"].sum().reset_index(name=\"BalanceSupply\")\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df, path=[\"Branch\",\"Brand\",\"SKU\"], values=\"BalanceSupply\",\n",
    "            color=\"Brand\", hover_data=[\"SKU\",\"BalanceSupply\"]\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate='<b>SKU:</b> %{customdata[0]}<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>'\n",
    "        )\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "        fig_treemap.update_layout(height=600)\n",
    "\n",
    "    # -----------------------------\n",
    "    # Info Table\n",
    "    # -----------------------------\n",
    "    info_columns = [\n",
    "        {\"name\":\"Plant\",\"id\":\"Plant\",\"type\":\"text\"},\n",
    "        {\"name\":\"SKU\",\"id\":\"SKU\",\"type\":\"text\"},\n",
    "        {\"name\":\"Brand\",\"id\":\"Brand\",\"type\":\"text\"},\n",
    "        {\"name\":\"BusinessUnit\",\"id\":\"BusinessUnit\",\"type\":\"text\"},\n",
    "        {\"name\":\"Branch\",\"id\":\"Branch\",\"type\":\"text\"},\n",
    "        {\"name\":\"Class\",\"id\":\"Class\",\"type\":\"text\"},\n",
    "        {\"name\":\"DaysLess10\",\"id\":\"DaysLess10\",\"type\":\"text\"},\n",
    "        {\"name\":\"OOS\",\"id\":\"OOS\",\"type\":\"text\"},\n",
    "        {\"name\":\"PlantInvPerc\",\"id\":\"PlantInvPerc\",\"type\":\"numeric\", \"format\": FormatTemplate.percentage(1)},\n",
    "        {\"name\":\"Oversell\",\"id\":\"Oversell\",\"type\":\"text\"},\n",
    "        {\"name\":\"Risk\",\"id\":\"Risk\",\"type\":\"text\"},\n",
    "        {\"name\":\"MTD_Sales\",\"id\":\"MTD_Sales\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"Forecast\",\"id\":\"Forecast\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"Avg_3MNTH_sales\",\"id\":\"Avg_3MNTH_sales\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"BalanceSupply\",\"id\":\"BalanceSupply\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"UpcomingPlan\",\"id\":\"UpcomingPlan\",\"type\":\"text\"},\n",
    "        {\"name\":\"DepletionDate\",\"id\":\"DepletionDate\",\"type\":\"text\"}\n",
    "    ]\n",
    "    table_data = dff_filtered[ [c[\"id\"] for c in info_columns] ].to_dict(\"records\")\n",
    "\n",
    "    # -----------------------------\n",
    "    # Stock Criticality Table\n",
    "    # -----------------------------\n",
    "    if not df_crit.empty:\n",
    "        crit_pivot = df_crit.melt(id_vars=[\"AI_SKU\",\"AI_MFGBRND\",\"Class\",\"Country\"], var_name=\"Branch\", value_name=\"DaysCover\")\n",
    "        crit_table = crit_pivot.pivot_table(index=[\"AI_SKU\",\"AI_MFGBRND\"], columns=\"Branch\", values=\"DaysCover\", fill_value=0).reset_index()\n",
    "        crit_columns = [{\"name\":c,\"id\":c,\"type\":\"text\"} if c in [\"AI_SKU\",\"AI_MFGBRND\"] else {\"name\":c,\"id\":c,\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)} for c in crit_table.columns]\n",
    "        crit_data = crit_table.to_dict(\"records\")\n",
    "    else:\n",
    "        crit_columns, crit_data = [], []\n",
    "\n",
    "    # -----------------------------\n",
    "    # Inter Rotation Map\n",
    "    # -----------------------------\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\").dropna(subset=[\"Latitude\",\"Longitude\"])\n",
    "        df_map[\"Label\"] = df_map.apply(lambda x: f\"{x['Branch']} ({x['Cases']}) - {x['Brand']}\", axis=1)\n",
    "        fig_inter = px.scatter_mapbox(df_map, lat=\"Latitude\", lon=\"Longitude\",\n",
    "                                      size=\"Cases\", color=\"Cases\", text=\"Label\",\n",
    "                                      hover_name=\"Label\", hover_data={\"Cases\":True,\"Latitude\": False, \"Longitude\": False},\n",
    "                                      zoom=4, mapbox_style=\"carto-positron\",\n",
    "                                      title=\"Inter Rotation Map\", size_max=30)\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    return cards, fig_inv, fig_bar, fig_treemap, info_columns, table_data, crit_columns, crit_data, fig_inter, f\"Last refresh: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\"\n",
    "\n",
    "# -----------------------------\n",
    "# RUN DASH\n",
    "# -----------------------------\n",
    "if __name__==\"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "cb73c765-2467-444f-a8ce-fcc1292fd969",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c76dce50>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "import re\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# -----------------------------\n",
    "# CONFIG\n",
    "# -----------------------------\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "# -----------------------------\n",
    "# UTIL FUNCTIONS\n",
    "# -----------------------------\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x): return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)): return pd.to_datetime(x)\n",
    "    s = str(x).strip()\n",
    "    fmts = [\"%d-%b-%Y\",\"%d-%b-%y\",\"%d-%b\",\"%Y-%m-%d\",\"%d/%m/%Y\",\"%d/%m/%y\",\"%Y/%m/%d\"]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s,f)\n",
    "            if f==\"%d-%b\": dt=dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except: continue\n",
    "    try: return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except: return pd.NaT\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for idx, row in df.iterrows():\n",
    "        inter = row.get(\"InterRotation\",\"\")\n",
    "        if not isinstance(inter, str) or inter.strip()==\"\":\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\") if b.strip()]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\",\"\"))\n",
    "                records.append({\n",
    "                    \"SKU\": row.get(\"SKU\", \"\"),\n",
    "                    \"Brand\": row.get(\"Brand\", \"\"),\n",
    "                    \"Branch\": branch_name,\n",
    "                    \"Cases\": cases\n",
    "                })\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "# -----------------------------\n",
    "# LOAD DATA\n",
    "# -----------------------------\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df.fillna(\"\", inplace=True)\n",
    "    col_map = {\n",
    "        \"Plant\":\"Plant\",\"AI_SKU\":\"SKU\",\"AI_MFGBRND\":\"Brand\",\"AI_BUSINESSUNIT\":\"BusinessUnit\",\n",
    "        \"AI_BRANCH\":\"Branch\",\"Class\":\"Class\",\"<10_Days\":\"DaysLess10\",\"OOS\":\"OOS\",\n",
    "        \"PlantInv %\":\"PlantInvPerc\",\"Upcoming_Plan\":\"UpcomingPlan\",\"Depletion_Date\":\"DepletionDate\",\n",
    "        \"Risk\":\"Risk\",\"BackOrder?\":\"BackOrder\",\"Oversell\":\"Oversell\",\"MTD Sales\":\"MTD_Sales\",\n",
    "        \"Forecast\":\"Forecast\",\"Avg_3MNTH_sales\":\"Avg_3MNTH_sales\",\"Inter_Rotation_Branches\":\"InterRotation\",\n",
    "        \"Balance Supply\":\"BalanceSupply\",  # normalized key\n",
    "        # keep other original columns (e.g. Total_SKU_Plant_Inventory) as-is\n",
    "    }\n",
    "    df.rename(columns={c:col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    # numeric conversions (keep original df field names if missing fallback to 0)\n",
    "    df[\"PlantInvPerc\"] = pd.to_numeric(df.get(\"PlantInvPerc\",\"0\").astype(str).str.replace(\"%\",\"\"), errors=\"coerce\").fillna(0)/100.0\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\",\"0\").replace(\"\",\"0\"), errors=\"coerce\").fillna(0)\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\",\"0\").replace(\"\",\"0\"), errors=\"coerce\").fillna(0)\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(df.get(\"Avg_3MNTH_sales\",\"0\").replace(\"\",\"0\"), errors=\"coerce\").fillna(0)\n",
    "    # Make sure BalanceSupply exists as numeric\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"BalanceSupply\", df.get(\"Balance_Supply\", 0)), errors=\"coerce\").fillna(0)\n",
    "    # Total_SKU_Plant_Inventory might exist in original file (if not, create with 0)\n",
    "    if \"Total_SKU_Plant_Inventory\" not in df.columns:\n",
    "        df[\"Total_SKU_Plant_Inventory\"] = 0\n",
    "    else:\n",
    "        df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(df[\"Total_SKU_Plant_Inventory\"], errors=\"coerce\").fillna(0)\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(lambda x:1 if str(x).lower() in [\"oos\",\"yes\",\"true\",\"1\"] else 0)\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(lambda x:1 if str(x).lower() in [\"risk\",\"yes\",\"true\",\"1\"] else 0)\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\",\"1\"] else 0)\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\",\"1\"] else 0)\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(lambda x:1 if str(x).lower() in [\"yes\",\"true\",\"1\"] else 0)\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    try:\n",
    "        df = pd.read_excel(path, sheet_name=sheet)\n",
    "    except Exception:\n",
    "        df = pd.DataFrame()\n",
    "    return df.fillna(0)\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    try:\n",
    "        df = pd.read_excel(path, sheet_name=sheet)\n",
    "    except Exception:\n",
    "        df = pd.DataFrame()\n",
    "    if df.empty:\n",
    "        return df\n",
    "    # Expect columns like AI_BRANCH, Latitude, Longitude\n",
    "    df = df.dropna(subset=[\"Latitude\",\"Longitude\"])\n",
    "    return df\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# -----------------------------\n",
    "# DASH APP\n",
    "# -----------------------------\n",
    "app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])\n",
    "server = app.server\n",
    "\n",
    "# -----------------------------\n",
    "# FILTER OPTIONS\n",
    "# -----------------------------\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique()) if not df_full.empty else []\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique()) if not df_full.empty else []\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique()) if not df_full.empty else []\n",
    "CLASSES = sorted(df_full[\"Class\"].unique()) if not df_full.empty else []\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique()) if not df_full.empty else []\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique()) if not df_full.empty else []\n",
    "BRANCH_DC_FILTER = [\"0\",\"1-4\",\"5-6\",\"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\",\"No\"]\n",
    "\n",
    "def kpi_card(title,value,color=\"primary\"):\n",
    "    return dbc.Col(dbc.Card(\n",
    "        dbc.CardBody([\n",
    "            html.H6(title,className=\"card-title text-muted\", style={\"fontSize\":\"1rem\"}),\n",
    "            html.H5(value,className=\"card-text\", style={\"whiteSpace\":\"nowrap\",\"overflow\":\"hidden\",\"textOverflow\":\"ellipsis\",\"fontSize\":\"1.2rem\"})\n",
    "        ]),\n",
    "        className=f\"m-1 border-{color}\"\n",
    "    ), xs=6, sm=4, md=2, lg=2)\n",
    "\n",
    "# -----------------------------\n",
    "# DASH LAYOUT\n",
    "# -----------------------------\n",
    "app.layout = dbc.Container([\n",
    "    dbc.Row([\n",
    "        dbc.Col(html.H3(\"Inventory & Supply Dashboard\", style={\"fontSize\":\"2rem\"}), width=8),\n",
    "        dbc.Col(html.Div(id=\"last-refresh\", style={\"textAlign\":\"right\",\"fontSize\":\"0.8rem\"}), width=4)\n",
    "    ]),\n",
    "    dbc.Row([\n",
    "        dbc.Col(dcc.Dropdown(id=\"brand-filter\", options=[{\"label\":b,\"value\":b} for b in BRANDS],\n",
    "                             multi=True, placeholder=\"Select Brand\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"plant-filter\", options=[{\"label\":p,\"value\":p} for p in PLANTS],\n",
    "                             multi=True, placeholder=\"Select Plant\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"branch-filter\", options=[{\"label\":b,\"value\":b} for b in BRANCHES],\n",
    "                             multi=True, placeholder=\"Select Branch\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"class-filter\", options=[{\"label\":c,\"value\":c} for c in CLASSES],\n",
    "                             multi=True, placeholder=\"Select Class\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"busunit-filter\", options=[{\"label\":b,\"value\":b} for b in BUS_UNITS],\n",
    "                             multi=True, placeholder=\"Select BU\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"ai-sku-filter\", options=[{\"label\":s,\"value\":s} for s in AI_SKUS],\n",
    "                             multi=True, placeholder=\"Select SKU\"), md=3),\n",
    "        dbc.Col(dcc.Dropdown(id=\"branch-dc-filter\", options=[{\"label\":b,\"value\":b} for b in BRANCH_DC_FILTER],\n",
    "                             multi=True, placeholder=\"Select DC Days\"), md=2),\n",
    "        dbc.Col(dcc.Dropdown(id=\"oversell-filter\", options=[{\"label\":b,\"value\":b} for b in OVERSELL_FILTER],\n",
    "                             multi=True, placeholder=\"Select Oversell\"), md=2),\n",
    "    ], className=\"my-2\"),\n",
    "    dbc.Row(id=\"kpi-row\", className=\"row row-cols-2 row-cols-sm-3 row-cols-md-7 row-cols-lg-7 my-2\"),\n",
    "    dbc.Tabs([\n",
    "        dbc.Tab(label=\"Overview\", tab_id=\"tab-overview\", children=[\n",
    "            dbc.Row([\n",
    "                dbc.Col(dcc.Graph(id=\"plant-inv-chart\", style={\"height\":\"700px\"}), md=6),\n",
    "                dbc.Col(dcc.Graph(id=\"oos-risk-bar\", style={\"height\":\"750px\"}), md=6)\n",
    "            ])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Branch OOS Treemap\", tab_id=\"tab-treemap\", children=[\n",
    "            dbc.Row([dbc.Col(dcc.Graph(id=\"branch-oos-treemap\", style={\"height\":\"600px\"}), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Information\", tab_id=\"tab-info\", children=[\n",
    "            dbc.Row([dbc.Col(dash_table.DataTable(\n",
    "                id=\"info-table\",\n",
    "                columns=[],  # set in callback\n",
    "                data=[],\n",
    "                page_size=15,\n",
    "                export_format='xlsx',\n",
    "                merge_duplicate_headers=True,\n",
    "                style_table={'overflowX':'auto'},\n",
    "                style_cell={'fontSize':10,'padding':'3px','whiteSpace':'nowrap'},\n",
    "                style_header={'position':'sticky','top':0,'backgroundColor':'#f8f9fa','fontWeight':'bold'},\n",
    "                style_data_conditional=[{'if':{'row_index':'odd'},'backgroundColor':'#f2f2f2'}],\n",
    "                row_selectable='multi'\n",
    "            ), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Stock Criticality\", tab_id=\"tab-crit\", children=[\n",
    "            dbc.Row([dbc.Col(dash_table.DataTable(\n",
    "                id=\"crit-table\",\n",
    "                columns=[],\n",
    "                data=[],\n",
    "                page_size=15,\n",
    "                export_format='xlsx',\n",
    "                style_table={'overflowX':'auto'},\n",
    "                style_cell={'fontSize':10,'padding':'3px','whiteSpace':'nowrap'},\n",
    "                style_header={'position':'sticky','top':0,'backgroundColor':'#f8f9fa','fontWeight':'bold'},\n",
    "                style_data_conditional=[{'if':{'row_index':'odd'},'backgroundColor':'#f2f2f2'}]\n",
    "            ), md=12)])\n",
    "        ]),\n",
    "        dbc.Tab(label=\"Inter Rotation\", tab_id=\"tab-inter\", children=[\n",
    "            dbc.Row([dbc.Col(dcc.Graph(id=\"inter-rotation-map\", style={\"height\":\"700px\"}), md=12)])\n",
    "        ])\n",
    "    ], id=\"tabs\", active_tab=\"tab-overview\")\n",
    "])\n",
    "\n",
    "# -----------------------------\n",
    "# CALLBACK\n",
    "# -----------------------------\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\",\"children\"),\n",
    "    Output(\"plant-inv-chart\",\"figure\"),\n",
    "    Output(\"oos-risk-bar\",\"figure\"),\n",
    "    Output(\"branch-oos-treemap\",\"figure\"),\n",
    "    Output(\"info-table\",\"columns\"),\n",
    "    Output(\"info-table\",\"data\"),\n",
    "    Output(\"crit-table\",\"columns\"),\n",
    "    Output(\"crit-table\",\"data\"),\n",
    "    Output(\"inter-rotation-map\",\"figure\"),\n",
    "    Output(\"last-refresh\",\"children\"),\n",
    "    Input(\"brand-filter\",\"value\"),\n",
    "    Input(\"plant-filter\",\"value\"),\n",
    "    Input(\"branch-filter\",\"value\"),\n",
    "    Input(\"class-filter\",\"value\"),\n",
    "    Input(\"busunit-filter\",\"value\"),\n",
    "    Input(\"ai-sku-filter\",\"value\"),\n",
    "    Input(\"branch-dc-filter\",\"value\"),\n",
    "    Input(\"oversell-filter\",\"value\")\n",
    ")\n",
    "def update_dashboard(brands,plants,branches,classes,busunits,ai_skus,branch_dc,oversell):\n",
    "    dff = df_full.copy()\n",
    "    if brands: dff = dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants: dff = dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches: dff = dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes: dff = dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits: dff = dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus: dff = dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v==\"Yes\" else 0 for v in oversell]\n",
    "        dff = dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # Branch DC filter applied only to info/KPIs\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False, index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b==\"0\": mask |= (dff_filtered[\"DaysToDepletion\"]<=0)\n",
    "            if b==\"1-4\": mask |= dff_filtered[\"DaysToDepletion\"].between(1,4)\n",
    "            if b==\"5-6\": mask |= dff_filtered[\"DaysToDepletion\"].between(5,6)\n",
    "            if b==\"7-10\": mask |= dff_filtered[\"DaysToDepletion\"].between(7,10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # Ensure numeric conversions on the filtered set (do not mutate original df_full)\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\").fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\").fillna(0)\n",
    "\n",
    "    # Filter rows with positive BalanceSupply (use dff_filtered, not df_full)\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "\n",
    "    # Sum BalanceSupply across all branches per SKU per Plant\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = dff_oos.groupby([\"SKU\",\"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        # Take max Plant Inventory per SKU per Plant\n",
    "        plant_max_inv = dff_oos.groupby([\"SKU\",\"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "        # Merge\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(plant_max_inv, on=[\"SKU\",\"Plant\"], how=\"left\")\n",
    "        # Apply final check logic\n",
    "        oos_calc[\"OOS_Cases\"] = (oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # KPI Cards\n",
    "    cards = [\n",
    "        kpi_card(\"Total SKUs 0-10 Days Cover\", dff_filtered[\"SKU\"].nunique()),\n",
    "        kpi_card(\"Balance Supply - Cases\", f\"{int(dff_filtered['BalanceSupply'].sum()):,}\"),\n",
    "        kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "        kpi_card(\"Total Supply Risk SKUs\", int(dff_filtered[\"IsRisk\"].sum())),\n",
    "        kpi_card(\"Total Backorder SKUs\", int(dff_filtered[\"IsBackorder\"].sum())),\n",
    "        kpi_card(\"<10d Cover SKUs\", int(dff_filtered[\"IsLowCover\"].sum())),\n",
    "        kpi_card(\"Oversell SKUs\", int(dff_filtered[\"IsOversell\"].sum())),\n",
    "    ]\n",
    "\n",
    "    # Convert date columns to date only (safe)\n",
    "    if not dff_filtered.empty:\n",
    "        if \"DepletionDate_parsed\" in dff_filtered.columns:\n",
    "            dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "        else:\n",
    "            dff_filtered[\"DepletionDate\"] = \"\"\n",
    "        if \"UpcomingPlan_parsed\" in dff_filtered.columns:\n",
    "            dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "        else:\n",
    "            dff_filtered[\"UpcomingPlan\"] = \"\"\n",
    "\n",
    "    # -----------------------------\n",
    "    # Plant Inventory Treemap\n",
    "    # -----------------------------\n",
    "    if not dff_filtered.empty:\n",
    "        # avoid zeros causing unwieldy treemap; keep a tiny positive for layout\n",
    "        dff_filtered['PlantInvPerc_safe'] = dff_filtered['PlantInvPerc'].replace(0, 0.0001)\n",
    "        agg_cols = ['Plant','Brand','SKU']\n",
    "        dff_agg = dff_filtered.groupby(agg_cols).agg({\n",
    "            'PlantInvPerc_safe':'sum',\n",
    "            'PlantInvPerc':'mean',\n",
    "            'BalanceSupply':'sum'\n",
    "        }).reset_index()\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg, path=['Plant','Brand','SKU'], values='PlantInvPerc_safe',\n",
    "            color='PlantInvPerc', color_continuous_scale='RdYlGn',\n",
    "            hover_data={'SKU':True, 'PlantInvPerc':':.1%', 'BalanceSupply': True}\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            # show label and pretty percent if relevant\n",
    "            texttemplate='%{label}<br>%{value:.2f}',\n",
    "            hovertemplate='<b>%{label}</b><br>PlantInvPerc: %{customdata[1]:.1%}<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>'\n",
    "        )\n",
    "        fig_inv.update_layout(title=\"Plant Inventory\", margin=dict(t=50,l=25,r=25,b=25))\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # -----------------------------\n",
    "    # OOS & Risk Bar Chart\n",
    "    # -----------------------------\n",
    "    if not dff_filtered.empty:\n",
    "        summary_df = dff_filtered.groupby(\"Brand\").agg(OOS_Count=(\"IsOOS\",\"sum\"), Risk_Count=(\"IsRisk\",\"sum\")).reset_index()\n",
    "        fig_bar = go.Figure()\n",
    "        fig_bar.add_trace(go.Bar(name=\"OOS SKUs\", x=summary_df[\"Brand\"], y=summary_df[\"OOS_Count\"], text=summary_df[\"OOS_Count\"], textposition='outside'))\n",
    "        fig_bar.add_trace(go.Bar(name=\"Risk SKUs\", x=summary_df[\"Brand\"], y=summary_df[\"Risk_Count\"], text=summary_df[\"Risk_Count\"], textposition='outside'))\n",
    "        fig_bar.update_layout(barmode='group', title=\"OOS & Risk SKUs by Brand\", height=650, margin=dict(t=80,b=150))\n",
    "    else:\n",
    "        fig_bar = go.Figure()\n",
    "\n",
    "    # -----------------------------\n",
    "    # Branch OOS Treemap\n",
    "    # -----------------------------\n",
    "    treemap_df = dff.groupby([\"Branch\",\"Brand\",\"SKU\"])[\"BalanceSupply\"].sum().reset_index(name=\"BalanceSupply\")\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df, path=[\"Branch\",\"Brand\",\"SKU\"], values=\"BalanceSupply\",\n",
    "            color=\"Brand\", hover_data=[\"SKU\",\"BalanceSupply\"]\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate='<b>SKU:</b> %{customdata[0]}<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>'\n",
    "        )\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "        fig_treemap.update_layout(height=600)\n",
    "\n",
    "    # -----------------------------\n",
    "    # Info Table\n",
    "    # -----------------------------\n",
    "    info_columns = [\n",
    "        {\"name\":\"Plant\",\"id\":\"Plant\",\"type\":\"text\"},\n",
    "        {\"name\":\"SKU\",\"id\":\"SKU\",\"type\":\"text\"},\n",
    "        {\"name\":\"Brand\",\"id\":\"Brand\",\"type\":\"text\"},\n",
    "        {\"name\":\"BusinessUnit\",\"id\":\"BusinessUnit\",\"type\":\"text\"},\n",
    "        {\"name\":\"Branch\",\"id\":\"Branch\",\"type\":\"text\"},\n",
    "        {\"name\":\"Class\",\"id\":\"Class\",\"type\":\"text\"},\n",
    "        {\"name\":\"DaysLess10\",\"id\":\"DaysLess10\",\"type\":\"text\"},\n",
    "        {\"name\":\"OOS\",\"id\":\"OOS\",\"type\":\"text\"},\n",
    "        {\"name\":\"PlantInvPerc\",\"id\":\"PlantInvPerc\",\"type\":\"numeric\", \"format\": FormatTemplate.percentage(1)},\n",
    "        {\"name\":\"Oversell\",\"id\":\"Oversell\",\"type\":\"text\"},\n",
    "        {\"name\":\"Risk\",\"id\":\"Risk\",\"type\":\"text\"},\n",
    "        {\"name\":\"MTD_Sales\",\"id\":\"MTD_Sales\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"Forecast\",\"id\":\"Forecast\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"Avg_3MNTH_sales\",\"id\":\"Avg_3MNTH_sales\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"BalanceSupply\",\"id\":\"BalanceSupply\",\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)},\n",
    "        {\"name\":\"UpcomingPlan\",\"id\":\"UpcomingPlan\",\"type\":\"text\"},\n",
    "        {\"name\":\"DepletionDate\",\"id\":\"DepletionDate\",\"type\":\"text\"}\n",
    "    ]\n",
    "    table_data = dff_filtered[ [c[\"id\"] for c in info_columns if c[\"id\"] in dff_filtered.columns] ].to_dict(\"records\")\n",
    "\n",
    "    # -----------------------------\n",
    "    # Stock Criticality Table\n",
    "    # -----------------------------\n",
    "    if not df_crit.empty:\n",
    "        # try to handle different column namings conservatively\n",
    "        crit_pivot = df_crit.melt(id_vars=[c for c in [\"AI_SKU\",\"AI_MFGBRND\",\"Class\",\"Country\"] if c in df_crit.columns],\n",
    "                                  var_name=\"Branch\", value_name=\"DaysCover\")\n",
    "        crit_table = crit_pivot.pivot_table(index=[\"AI_SKU\",\"AI_MFGBRND\"], columns=\"Branch\", values=\"DaysCover\", fill_value=0).reset_index()\n",
    "        crit_columns = []\n",
    "        for c in crit_table.columns:\n",
    "            if c in [\"AI_SKU\",\"AI_MFGBRND\"]:\n",
    "                crit_columns.append({\"name\":c,\"id\":c,\"type\":\"text\"})\n",
    "            else:\n",
    "                crit_columns.append({\"name\":c,\"id\":c,\"type\":\"numeric\", \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0)})\n",
    "        crit_data = crit_table.to_dict(\"records\")\n",
    "    else:\n",
    "        crit_columns, crit_data = [], []\n",
    "\n",
    "    # -----------------------------\n",
    "    # Inter Rotation Map\n",
    "    # -----------------------------\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty and not df_coord.empty:\n",
    "        df_map = df_inter.merge(df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\").dropna(subset=[\"Latitude\",\"Longitude\"])\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(lambda x: f\"{x['Branch']} ({x['Cases']}) - {x['Brand']}\", axis=1)\n",
    "            fig_inter = px.scatter_mapbox(df_map, lat=\"Latitude\", lon=\"Longitude\",\n",
    "                                          size=\"Cases\", color=\"Cases\", text=\"Label\",\n",
    "                                          hover_name=\"Label\", hover_data={\"Cases\":True,\"Latitude\": False, \"Longitude\": False},\n",
    "                                          zoom=4, mapbox_style=\"carto-positron\",\n",
    "                                          title=\"Inter Rotation Map\", size_max=30)\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = f\"Last refresh: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\"\n",
    "    return cards, fig_inv, fig_bar, fig_treemap, info_columns, table_data, crit_columns, crit_data, fig_inter, last_refresh\n",
    "\n",
    "# -----------------------------\n",
    "# RUN DASH\n",
    "# -----------------------------\n",
    "if __name__==\"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "78f04c44-8be1-49cd-b3cf-cbdb53b9b11d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c7cccf40>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":  # no year -> assume this year\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    \"\"\"Turn Inter_Rotation_Branches into rows.\"\"\"\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(\n",
    "        columns={c: col_map[c] for c in df.columns if c in col_map},\n",
    "        inplace=True,\n",
    "    )\n",
    "\n",
    "    # numeric conversions\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(\n",
    "            df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\"\n",
    "        )\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    # flags\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(\n",
    "        df[\"UpcomingPlan\"], errors=\"coerce\"\n",
    "    )\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.fillna(0)\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def nice_dropdown(id_, options, placeholder):\n",
    "    return dcc.Dropdown(\n",
    "        id=id_,\n",
    "        options=[{\"label\": o, \"value\": o} for o in options],\n",
    "        multi=True,\n",
    "        placeholder=placeholder,\n",
    "        className=\"fixed-multi-dropdown\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\"):\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(\n",
    "                        title,\n",
    "                        className=\"text-muted\",\n",
    "                        style={\"fontSize\": \"0.9rem\"},\n",
    "                    ),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# DASH APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "# ---- inject CSS dynamically ----\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        /* ---------- Multi dropdown styling (Power BI slicer-ish) ---------- */\n",
    "        .fixed-multi-dropdown {\n",
    "            font-size: 11px;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow-y: hidden;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-multi-value-wrapper {\n",
    "            max-height: 36px;\n",
    "            overflow-y: auto;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-placeholder {\n",
    "            font-size: 11px;\n",
    "        }\n",
    "\n",
    "        /* ---------- DataTable tweaks ---------- */\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container th {\n",
    "            text-transform: none;\n",
    "        }\n",
    "\n",
    "        .global-search {\n",
    "            font-size: 11px;\n",
    "            height: 32px;\n",
    "        }\n",
    "\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # ---- HEADER ----\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\n",
    "                                \"Inventory & Supply Dashboard\",\n",
    "                                className=\"mt-2 mb-0\",\n",
    "                            ),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\",\n",
    "                                className=\"text-muted small\",\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=8,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\n",
    "                                            \"label\": \" Executive\",\n",
    "                                            \"value\": \"executive\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"label\": \" Analyst\",\n",
    "                                            \"value\": \"analyst\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"justify-content-end\",\n",
    "                    ),\n",
    "                    md=4,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # ---- FILTERS (collapsible) ----\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        BRANDS,\n",
    "                                        \"Select Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        PLANTS,\n",
    "                                        \"Select Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Select Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        CLASSES,\n",
    "                                        \"Select Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"Select BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"Select SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"Select DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    nice_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Select Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # ---- KPI BAR (sticky) ----\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # ---- TABS ----\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\n",
    "                                                \"row_index\": \"odd\",\n",
    "                                            },\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACKS\n",
    "# =========================================================\n",
    "# Collapse / expand filter panel\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # ---- base filtering ----\n",
    "    dff = df_full.copy()\n",
    "    if brands:\n",
    "        dff = dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants:\n",
    "        dff = dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches:\n",
    "        dff = dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes:\n",
    "        dff = dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits:\n",
    "        dff = dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus:\n",
    "        dff = dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        dff = dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # global search across multiple key columns\n",
    "    if global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=dff.index)\n",
    "        for col in search_cols:\n",
    "            mask |= dff[col].astype(str).str.lower().str.contains(gs)\n",
    "        dff = dff[mask]\n",
    "\n",
    "    # ---- Branch DC filter ----\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False, index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(7, 10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # ---- OOS calculation ----\n",
    "    tmp = dff_filtered.copy()\n",
    "    tmp[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        tmp[\"BalanceSupply\"], errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    tmp[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        tmp[\"Total_SKU_Plant_Inventory\"], errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    dff_oos = tmp[tmp[\"BalanceSupply\"] > 0]\n",
    "\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = dff_oos.groupby(\n",
    "            [\"SKU\", \"Plant\"], as_index=False\n",
    "        )[\"BalanceSupply\"].sum()\n",
    "        plant_max_inv = dff_oos.groupby(\n",
    "            [\"SKU\", \"Plant\"], as_index=False\n",
    "        )[\"Total_SKU_Plant_Inventory\"].max()\n",
    "\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "\n",
    "        def compute_oos(row):\n",
    "            if row[\"BalanceSupply\"] < row[\"Total_SKU_Plant_Inventory\"]:\n",
    "                return 0\n",
    "            return row[\"BalanceSupply\"] - row[\"Total_SKU_Plant_Inventory\"]\n",
    "\n",
    "        oos_calc[\"OOS_Cases\"] = oos_calc.apply(compute_oos, axis=1)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # ---- KPI CARDS (Executive vs Analyst) ----\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Supply Risk SKUs\", risk_count, color=\"warning\"),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\"),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\"),\n",
    "        ]\n",
    "    else:  # analyst\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count),\n",
    "        ]\n",
    "\n",
    "    # date columns for tables\n",
    "    dff_filtered = dff_filtered.copy()\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # ---- Plant Inventory Treemap ----\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                PlantInvPerc=(\"PlantInvPerc\", \"mean\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"PlantInvPerc\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"PlantInvPerc\": \":.1%\",\n",
    "                \"BalanceSupply\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}<br>%{value:.0%}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>PlantInv: %{customdata[1]:.1%}\"\n",
    "            \"<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"PlantInv %\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # ---- OOS & Risk Bar ----\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(\n",
    "                OOS_Count=(\"IsOOS\", \"sum\"),\n",
    "                Risk_Count=(\"IsRisk\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col = \"Group\"\n",
    "        title = \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "\n",
    "    # ---- Branch OOS Treemap ----\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "\n",
    "    # ---- Information Table (Executive vs Analyst) ----\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\n",
    "        \"records\"\n",
    "    )\n",
    "\n",
    "    # ---- Stock Criticality Table + Gradient ----\n",
    "    if not df_crit.empty:\n",
    "        crit_pivot = df_crit.melt(\n",
    "            id_vars=[\"AI_SKU\", \"AI_MFGBRND\", \"Class\", \"Country\"],\n",
    "            var_name=\"Branch\",\n",
    "            value_name=\"DaysCover\",\n",
    "        )\n",
    "        crit_table = (\n",
    "            crit_pivot.pivot_table(\n",
    "                index=[\"AI_SKU\", \"AI_MFGBRND\"],\n",
    "                columns=\"Branch\",\n",
    "                values=\"DaysCover\",\n",
    "                fill_value=0,\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "\n",
    "        crit_columns = []\n",
    "        for c in crit_table.columns:\n",
    "            if c in [\"AI_SKU\", \"AI_MFGBRND\"]:\n",
    "                crit_columns.append({\"name\": c, \"id\": c, \"type\": \"text\"})\n",
    "            else:\n",
    "                crit_columns.append(\n",
    "                    {\n",
    "                        \"name\": c,\n",
    "                        \"id\": c,\n",
    "                        \"type\": \"numeric\",\n",
    "                        \"format\": Format(\n",
    "                            group=Group.no,\n",
    "                            scheme=Scheme.fixed,\n",
    "                            precision=0,\n",
    "                        ),\n",
    "                    }\n",
    "                )\n",
    "\n",
    "        crit_data = crit_table.to_dict(\"records\")\n",
    "\n",
    "        # gradient style 0–10 from dark red to light green\n",
    "        numeric_cols = [\n",
    "            c for c in crit_table.columns if c not in [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "        ]\n",
    "        style_data_conditional = []\n",
    "        bands = [\n",
    "            (0, 0, \"#8b0000\", \"white\"),\n",
    "            (1, 3, \"#d73027\", \"white\"),\n",
    "            (4, 6, \"#fc8d59\", \"black\"),\n",
    "            (7, 10, \"#d9ef8b\", \"black\"),\n",
    "            (11, 9999, \"#1a9850\", \"white\"),\n",
    "        ]\n",
    "        for col in numeric_cols:\n",
    "            for low, high, color, font_color in bands:\n",
    "                style_data_conditional.append(\n",
    "                    {\n",
    "                        \"if\": {\n",
    "                            \"filter_query\": (\n",
    "                                f\"{{{col}}} >= {low} && {{{col}}} <= {high}\"\n",
    "                            ),\n",
    "                            \"column_id\": col,\n",
    "                        },\n",
    "                        \"backgroundColor\": color,\n",
    "                        \"color\": font_color,\n",
    "                    }\n",
    "                )\n",
    "    else:\n",
    "        crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "\n",
    "    # ---- Inter Rotation Map ----\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord,\n",
    "            left_on=\"Branch\",\n",
    "            right_on=\"AI_BRANCH\",\n",
    "            how=\"left\",\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\",\n",
    "                axis=1,\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\n",
    "        \"%Y-%m-%d %H:%M:%S\"\n",
    "    )\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "32445a48-6eac-4e82-ba2f-1c1c864042ab",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c6f16c70>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":  # no year -> assume this year\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    \"\"\"Turn Inter_Rotation_Branches into rows.\"\"\"\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(\n",
    "        columns={c: col_map[c] for c in df.columns if c in col_map},\n",
    "        inplace=True,\n",
    "    )\n",
    "\n",
    "    # numeric conversions\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(\n",
    "            df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\"\n",
    "        )\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    # flags\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(\n",
    "        df[\"UpcomingPlan\"], errors=\"coerce\"\n",
    "    )\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    # keep blanks as NaN\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, placeholder):\n",
    "    \"\"\"Dropdown with overlay label that shows 'Select X' or 'n selected'.\"\"\"\n",
    "    return html.Div(\n",
    "        [\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                className=\"fixed-multi-dropdown\",\n",
    "            ),\n",
    "            html.Div(placeholder, id=count_id, className=\"dropdown-count-label\"),\n",
    "        ],\n",
    "        className=\"dropdown-count-wrapper\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\"):\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(\n",
    "                        title,\n",
    "                        className=\"text-muted\",\n",
    "                        style={\"fontSize\": \"0.9rem\"},\n",
    "                    ),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# DASH APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "# ---- inject CSS dynamically ----\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        /* ---------- Multi dropdown styling (Power BI slicer-ish) ---------- */\n",
    "        .fixed-multi-dropdown {\n",
    "            font-size: 11px;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow-y: hidden;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "\n",
    "        /* hide built-in placeholder + chips, we show our own label */\n",
    "        .fixed-multi-dropdown .Select-placeholder {\n",
    "            opacity: 0;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-multi-value-wrapper {\n",
    "            display: none;\n",
    "        }\n",
    "\n",
    "        /* wrapper overlay label */\n",
    "        .dropdown-count-wrapper {\n",
    "            position: relative;\n",
    "        }\n",
    "        .dropdown-count-label {\n",
    "            position: absolute;\n",
    "            top: 6px;\n",
    "            left: 10px;\n",
    "            pointer-events: none;\n",
    "            font-size: 11px;\n",
    "            color: #6c757d;\n",
    "        }\n",
    "\n",
    "        /* dropdown arrow zone alignment */\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "\n",
    "        .global-search {\n",
    "            font-size: 11px;\n",
    "            height: 32px;\n",
    "        }\n",
    "\n",
    "        /* ---------- DataTable tweaks ---------- */\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container th {\n",
    "            text-transform: none;\n",
    "        }\n",
    "\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # ---- HEADER ----\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\n",
    "                                \"Inventory & Supply Dashboard\",\n",
    "                                className=\"mt-2 mb-0\",\n",
    "                            ),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\",\n",
    "                                className=\"text-muted small\",\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=8,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\n",
    "                                            \"label\": \" Executive\",\n",
    "                                            \"value\": \"executive\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"label\": \" Analyst\",\n",
    "                                            \"value\": \"analyst\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"justify-content-end\",\n",
    "                    ),\n",
    "                    md=4,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # ---- FILTERS (collapsible) ----\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Select Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Select Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Select Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Select Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"Select BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"Select SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"Select DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Select Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # ---- KPI BAR (sticky) ----\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # ---- TABS ----\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACKS\n",
    "# =========================================================\n",
    "# Collapse / expand filter panel\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # ---- base filtering ----\n",
    "    dff = df_full.copy()\n",
    "    if brands:\n",
    "        dff = dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants:\n",
    "        dff = dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches:\n",
    "        dff = dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes:\n",
    "        dff = dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits:\n",
    "        dff = dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus:\n",
    "        dff = dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        dff = dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # global search across multiple key columns\n",
    "    if global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=dff.index)\n",
    "        for col in search_cols:\n",
    "            mask |= dff[col].astype(str).str.lower().str.contains(gs)\n",
    "        dff = dff[mask]\n",
    "\n",
    "    # ---- Branch DC filter ----\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False, index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(7, 10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # ------------------------------------------------------\n",
    "    # OOS calculation based on BalanceSupply vs Plant Inv\n",
    "    # (your original working logic)\n",
    "    # ------------------------------------------------------\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    # Filter rows with positive BalanceSupply (use dff_filtered)\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "\n",
    "    if not dff_oos.empty:\n",
    "        # Sum BalanceSupply across all branches per SKU per Plant\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        # Take max Plant Inventory per SKU per Plant\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "        )\n",
    "        # Merge\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        # Final check logic: OOS only when demand > plant inv\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # ---- KPI CARDS ----\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Supply Risk SKUs\", risk_count, color=\"warning\"),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\"),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\"),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count),\n",
    "        ]\n",
    "\n",
    "    # date columns for tables\n",
    "    dff_filtered = dff_filtered.copy()\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # ---- Plant Inventory Treemap ----\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                PlantInvPerc=(\"PlantInvPerc\", \"mean\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"PlantInvPerc\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"PlantInvPerc\": \":.1%\",\n",
    "                \"BalanceSupply\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}<br>%{value:.0%}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>PlantInv: %{customdata[1]:.1%}\"\n",
    "            \"<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"PlantInv %\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # ---- OOS & Risk Bar ----\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(\n",
    "                OOS_Count=(\"IsOOS\", \"sum\"),\n",
    "                Risk_Count=(\"IsRisk\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col = \"Group\"\n",
    "        title = \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "\n",
    "    # ---- Branch OOS Treemap ----\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "\n",
    "    # ---- Information Table ----\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\n",
    "        \"records\"\n",
    "    )\n",
    "\n",
    "    # ---- Stock Criticality table (filters + blanks grey) ----\n",
    "    if not df_crit.empty:\n",
    "        df_crit_filtered = df_crit.copy()\n",
    "        if brands:\n",
    "            df_crit_filtered = df_crit_filtered[\n",
    "                df_crit_filtered[\"AI_MFGBRND\"].isin(brands)\n",
    "            ]\n",
    "        if ai_skus:\n",
    "            df_crit_filtered = df_crit_filtered[\n",
    "                df_crit_filtered[\"AI_SKU\"].isin(ai_skus)\n",
    "            ]\n",
    "        if busunits and \"Country\" in df_crit_filtered.columns:\n",
    "            df_crit_filtered = df_crit_filtered[\n",
    "                df_crit_filtered[\"Country\"].isin(busunits)\n",
    "            ]\n",
    "\n",
    "        crit_pivot = df_crit_filtered.melt(\n",
    "            id_vars=[\"AI_SKU\", \"AI_MFGBRND\", \"Class\", \"Country\"],\n",
    "            var_name=\"Branch\",\n",
    "            value_name=\"DaysCover\",\n",
    "        )\n",
    "        crit_table = crit_pivot.pivot_table(\n",
    "            index=[\"AI_SKU\", \"AI_MFGBRND\"],\n",
    "            columns=\"Branch\",\n",
    "            values=\"DaysCover\",\n",
    "            aggfunc=\"first\",\n",
    "        ).reset_index()\n",
    "\n",
    "        crit_columns = []\n",
    "        for c in crit_table.columns:\n",
    "            if c in [\"AI_SKU\", \"AI_MFGBRND\"]:\n",
    "                crit_columns.append({\"name\": c, \"id\": c, \"type\": \"text\"})\n",
    "            else:\n",
    "                crit_columns.append(\n",
    "                    {\n",
    "                        \"name\": c,\n",
    "                        \"id\": c,\n",
    "                        \"type\": \"numeric\",\n",
    "                        # NaN -> blank\n",
    "                        \"format\": Format(\n",
    "                            group=Group.no,\n",
    "                            scheme=Scheme.fixed,\n",
    "                            precision=0,\n",
    "                            nully=\"\",\n",
    "                        ),\n",
    "                    }\n",
    "                )\n",
    "\n",
    "        crit_data = crit_table.to_dict(\"records\")\n",
    "\n",
    "        numeric_cols = [\n",
    "            c for c in crit_table.columns if c not in [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "        ]\n",
    "        style_data_conditional = []\n",
    "        bands = [\n",
    "            (0, 0, \"#8b0000\", \"white\"),\n",
    "            (1, 3, \"#d73027\", \"white\"),\n",
    "            (4, 6, \"#fc8d59\", \"black\"),\n",
    "            (7, 10, \"#d9ef8b\", \"black\"),\n",
    "            (11, 9999, \"#1a9850\", \"white\"),\n",
    "        ]\n",
    "        for col in numeric_cols:\n",
    "            for low, high, color, font_color in bands:\n",
    "                style_data_conditional.append(\n",
    "                    {\n",
    "                        \"if\": {\n",
    "                            \"filter_query\": (\n",
    "                                f\"{{{col}}} >= {low} && {{{col}}} <= {high}\"\n",
    "                            ),\n",
    "                            \"column_id\": col,\n",
    "                        },\n",
    "                        \"backgroundColor\": color,\n",
    "                        \"color\": font_color,\n",
    "                    }\n",
    "                )\n",
    "            # blanks (no forecast) -> grey\n",
    "            style_data_conditional.append(\n",
    "                {\n",
    "                    \"if\": {\n",
    "                        \"filter_query\": f\"{{{col}}} = ''\",\n",
    "                        \"column_id\": col,\n",
    "                    },\n",
    "                    \"backgroundColor\": \"#e6e6e6\",\n",
    "                    \"color\": \"#6c757d\",\n",
    "                }\n",
    "            )\n",
    "    else:\n",
    "        crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "\n",
    "    # ---- Inter Rotation Map ----\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord,\n",
    "            left_on=\"Branch\",\n",
    "            right_on=\"AI_BRANCH\",\n",
    "            how=\"left\",\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\",\n",
    "                axis=1,\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\n",
    "        \"%Y-%m-%d %H:%M:%S\"\n",
    "    )\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# ---------- small helper for \"n selected\" labels ----------\n",
    "def _count_text(values, placeholder):\n",
    "    if values:\n",
    "        return f\"{len(values)} selected\"\n",
    "    return placeholder\n",
    "\n",
    "\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_text(v, \"Select Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_text(v, \"Select Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_text(v, \"Select Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_text(v, \"Select Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_text(v, \"Select BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_text(v, \"Select SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_text(v, \"Select DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_text(v, \"Select Oversell\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "1af687f5-69ec-4eea-ae69-7ba2e7d71c50",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c6f39f10>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(\n",
    "        columns={c: col_map[c] for c in df.columns if c in col_map},\n",
    "        inplace=True,\n",
    "    )\n",
    "\n",
    "    # numeric conversions\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(\n",
    "            df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\"\n",
    "        )\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    # flags\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(\n",
    "        df[\"UpcomingPlan\"], errors=\"coerce\"\n",
    "    )\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    \"\"\"Standard multi dropdown with a label that shows 'n selected' above.\"\"\"\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\"):\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(\n",
    "                        title,\n",
    "                        className=\"text-muted\",\n",
    "                        style={\"fontSize\": \"0.9rem\"},\n",
    "                    ),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# DASH APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        /* Dropdowns */\n",
    "        .fixed-multi-dropdown {\n",
    "            font-size: 11px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "\n",
    "        .global-search {\n",
    "            font-size: 11px;\n",
    "            height: 32px;\n",
    "        }\n",
    "\n",
    "        /* DataTable */\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th {\n",
    "            text-transform: none;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # HEADER\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\n",
    "                                \"Inventory & Supply Dashboard\",\n",
    "                                className=\"mt-2 mb-0\",\n",
    "                            ),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\",\n",
    "                                className=\"text-muted small\",\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=8,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\n",
    "                                            \"label\": \" Executive\",\n",
    "                                            \"value\": \"executive\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"label\": \" Analyst\",\n",
    "                                            \"value\": \"analyst\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"justify-content-end\",\n",
    "                    ),\n",
    "                    md=4,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # FILTERS\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI BAR\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # TABS\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACKS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # -------- Base filtering on Summary --------\n",
    "    dff = df_full.copy()\n",
    "    if brands:\n",
    "        dff = dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants:\n",
    "        dff = dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches:\n",
    "        dff = dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes:\n",
    "        dff = dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits:\n",
    "        dff = dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus:\n",
    "        dff = dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        dff = dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # Global search\n",
    "    if global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=dff.index)\n",
    "        for col in search_cols:\n",
    "            mask |= dff[col].astype(str).str.lower().str.contains(gs)\n",
    "        dff = dff[mask]\n",
    "\n",
    "    # Branch DC filter\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False, index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(7, 10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # -------- OOS calculation (your logic) --------\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # KPI numbers\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Supply Risk SKUs\", risk_count, color=\"warning\"),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\"),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\"),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count),\n",
    "        ]\n",
    "\n",
    "    # Dates for table display\n",
    "    dff_filtered = dff_filtered.copy()\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # Plant Inventory Treemap\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                PlantInvPerc=(\"PlantInvPerc\", \"mean\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"PlantInvPerc\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"PlantInvPerc\": \":.1%\",\n",
    "                \"BalanceSupply\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}<br>%{value:.0%}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>PlantInv: %{customdata[1]:.1%}\"\n",
    "            \"<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"PlantInv %\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # OOS & Risk Bar\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(\n",
    "                OOS_Count=(\"IsOOS\", \"sum\"),\n",
    "                Risk_Count=(\"IsRisk\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col = \"Group\"\n",
    "        title = \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "\n",
    "    # Branch OOS Treemap\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "\n",
    "    # Information Table\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\n",
    "        \"records\"\n",
    "    )\n",
    "\n",
    "    # -------- Stock Criticality (with filters) --------\n",
    "    if not df_crit.empty:\n",
    "        dfc = df_crit.copy()\n",
    "\n",
    "        # clean helper columns for robust matching\n",
    "        dfc[\"AI_MFGBRND_clean\"] = dfc[\"AI_MFGBRND\"].astype(str).str.strip().str.upper()\n",
    "        dfc[\"AI_SKU_clean\"] = dfc[\"AI_SKU\"].astype(str).str.strip().str.upper()\n",
    "        if \"Country\" in dfc.columns:\n",
    "            dfc[\"Country_clean\"] = dfc[\"Country\"].astype(str).str.strip().str.upper()\n",
    "        else:\n",
    "            dfc[\"Country_clean\"] = \"\"\n",
    "\n",
    "        if brands:\n",
    "            bset = [b.strip().upper() for b in brands]\n",
    "            dfc = dfc[dfc[\"AI_MFGBRND_clean\"].isin(bset)]\n",
    "        if ai_skus:\n",
    "            sset = [s.strip().upper() for s in ai_skus]\n",
    "            dfc = dfc[dfc[\"AI_SKU_clean\"].isin(sset)]\n",
    "        if busunits:\n",
    "            bus = [bu.strip().upper() for bu in busunits]\n",
    "            dfc = dfc[dfc[\"Country_clean\"].isin(bus)]\n",
    "\n",
    "        crit_pivot = dfc.melt(\n",
    "            id_vars=[\"AI_SKU\", \"AI_MFGBRND\", \"Class\", \"Country\"],\n",
    "            var_name=\"Branch\",\n",
    "            value_name=\"DaysCover\",\n",
    "        )\n",
    "        crit_table = crit_pivot.pivot_table(\n",
    "            index=[\"AI_SKU\", \"AI_MFGBRND\"],\n",
    "            columns=\"Branch\",\n",
    "            values=\"DaysCover\",\n",
    "            aggfunc=\"first\",\n",
    "        ).reset_index()\n",
    "\n",
    "        crit_columns = []\n",
    "        for c in crit_table.columns:\n",
    "            if c in [\"AI_SKU\", \"AI_MFGBRND\"]:\n",
    "                crit_columns.append({\"name\": c, \"id\": c, \"type\": \"text\"})\n",
    "            else:\n",
    "                crit_columns.append(\n",
    "                    {\n",
    "                        \"name\": c,\n",
    "                        \"id\": c,\n",
    "                        \"type\": \"numeric\",\n",
    "                        \"format\": Format(\n",
    "                            group=Group.no,\n",
    "                            scheme=Scheme.fixed,\n",
    "                            precision=0,\n",
    "                            nully=\"\",\n",
    "                        ),\n",
    "                    }\n",
    "                )\n",
    "\n",
    "        crit_data = crit_table.to_dict(\"records\")\n",
    "\n",
    "        numeric_cols = [\n",
    "            c for c in crit_table.columns if c not in [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "        ]\n",
    "        style_data_conditional = []\n",
    "        bands = [\n",
    "            (0, 0, \"#8b0000\", \"white\"),\n",
    "            (1, 3, \"#d73027\", \"white\"),\n",
    "            (4, 6, \"#fc8d59\", \"black\"),\n",
    "            (7, 10, \"#d9ef8b\", \"black\"),\n",
    "            (11, 9999, \"#1a9850\", \"white\"),\n",
    "        ]\n",
    "        for col in numeric_cols:\n",
    "            for low, high, color, font_color in bands:\n",
    "                style_data_conditional.append(\n",
    "                    {\n",
    "                        \"if\": {\n",
    "                            \"filter_query\": (\n",
    "                                f\"{{{col}}} >= {low} && {{{col}}} <= {high}\"\n",
    "                            ),\n",
    "                            \"column_id\": col,\n",
    "                        },\n",
    "                        \"backgroundColor\": color,\n",
    "                        \"color\": font_color,\n",
    "                    }\n",
    "                )\n",
    "            # blanks (no forecast) -> grey\n",
    "            style_data_conditional.append(\n",
    "                {\n",
    "                    \"if\": {\n",
    "                        \"filter_query\": f\"{{{col}}} = ''\",\n",
    "                        \"column_id\": col,\n",
    "                    },\n",
    "                    \"backgroundColor\": \"#e6e6e6\",\n",
    "                    \"color\": \"#6c757d\",\n",
    "                }\n",
    "            )\n",
    "    else:\n",
    "        crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "\n",
    "    # Inter Rotation Map\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord,\n",
    "            left_on=\"Branch\",\n",
    "            right_on=\"AI_BRANCH\",\n",
    "            how=\"left\",\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\",\n",
    "                axis=1,\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\n",
    "        \"%Y-%m-%d %H:%M:%S\"\n",
    "    )\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# ---------- helper for \"n selected\" labels ----------\n",
    "def _count_label(values, base):\n",
    "    if values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "55806d3d-22f4-4770-8d26-409352383ab1",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c6f39f10>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(\n",
    "        columns={c: col_map[c] for c in df.columns if c in col_map},\n",
    "        inplace=True,\n",
    "    )\n",
    "\n",
    "    # numeric conversions\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(\n",
    "            df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\"\n",
    "        )\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    # flags\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(\n",
    "        df[\"UpcomingPlan\"], errors=\"coerce\"\n",
    "    )\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    \"\"\"Standard multi dropdown with a label that shows 'n selected' above.\"\"\"\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\"):\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(\n",
    "                        title,\n",
    "                        className=\"text-muted\",\n",
    "                        style={\"fontSize\": \"0.9rem\"},\n",
    "                    ),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# DASH APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        /* Dropdowns */\n",
    "        .fixed-multi-dropdown {\n",
    "            font-size: 11px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "\n",
    "        .global-search {\n",
    "            font-size: 11px;\n",
    "            height: 32px;\n",
    "        }\n",
    "\n",
    "        /* DataTable */\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th {\n",
    "            text-transform: none;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # HEADER\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\n",
    "                                \"Inventory & Supply Dashboard\",\n",
    "                                className=\"mt-2 mb-0\",\n",
    "                            ),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\",\n",
    "                                className=\"text-muted small\",\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=7,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\n",
    "                                            \"label\": \" Executive\",\n",
    "                                            \"value\": \"executive\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"label\": \" Analyst\",\n",
    "                                            \"value\": \"analyst\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Img(\n",
    "                                    src=\"/assets/aujan_logo.png\",\n",
    "                                    style={\n",
    "                                        \"height\": \"48px\",\n",
    "                                        \"objectFit\": \"contain\",\n",
    "                                    },\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=5,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # FILTERS\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI BAR\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # TABS\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACKS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # -------- Base filtering on Summary --------\n",
    "    dff = df_full.copy()\n",
    "    if brands:\n",
    "        dff = dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants:\n",
    "        dff = dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches:\n",
    "        dff = dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes:\n",
    "        dff = dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits:\n",
    "        dff = dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus:\n",
    "        dff = dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        dff = dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # Global search\n",
    "    if global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=dff.index)\n",
    "        for col in search_cols:\n",
    "            mask |= dff[col].astype(str).str.lower().str.contains(gs)\n",
    "        dff = dff[mask]\n",
    "\n",
    "    # Branch DC filter (for summary / KPIs)\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False, index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(7, 10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # -------- OOS calculation (your logic) --------\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # KPI numbers\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Supply Risk SKUs\", risk_count, color=\"warning\"),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\"),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\"),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count),\n",
    "        ]\n",
    "\n",
    "    # Dates for table display\n",
    "    dff_filtered = dff_filtered.copy()\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # Plant Inventory Treemap\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                PlantInvPerc=(\"PlantInvPerc\", \"mean\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"PlantInvPerc\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"PlantInvPerc\": \":.1%\",\n",
    "                \"BalanceSupply\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}<br>%{value:.0%}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>PlantInv: %{customdata[1]:.1%}\"\n",
    "            \"<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"PlantInv %\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # OOS & Risk Bar\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(\n",
    "                OOS_Count=(\"IsOOS\", \"sum\"),\n",
    "                Risk_Count=(\"IsRisk\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col = \"Group\"\n",
    "        title = \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "\n",
    "    # Branch OOS Treemap\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "\n",
    "    # Information Table\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\n",
    "        \"records\"\n",
    "    )\n",
    "\n",
    "    # -------- Stock Criticality (filtered by SKUs in dff) --------\n",
    "    if not df_crit.empty:\n",
    "        valid_skus = dff[\"SKU\"].unique()\n",
    "        dfc = df_crit[df_crit[\"AI_SKU\"].isin(valid_skus)].copy()\n",
    "\n",
    "        if not dfc.empty:\n",
    "            crit_pivot = dfc.melt(\n",
    "                id_vars=[\"AI_SKU\", \"AI_MFGBRND\"],\n",
    "                var_name=\"Branch\",\n",
    "                value_name=\"DaysCover\",\n",
    "            )\n",
    "            crit_table = crit_pivot.pivot_table(\n",
    "                index=[\"AI_SKU\", \"AI_MFGBRND\"],\n",
    "                columns=\"Branch\",\n",
    "                values=\"DaysCover\",\n",
    "                aggfunc=\"first\",\n",
    "            ).reset_index()\n",
    "\n",
    "            crit_columns = []\n",
    "            for c in crit_table.columns:\n",
    "                if c in [\"AI_SKU\", \"AI_MFGBRND\"]:\n",
    "                    crit_columns.append({\"name\": c, \"id\": c, \"type\": \"text\"})\n",
    "                else:\n",
    "                    crit_columns.append(\n",
    "                        {\n",
    "                            \"name\": c,\n",
    "                            \"id\": c,\n",
    "                            \"type\": \"numeric\",\n",
    "                            \"format\": Format(\n",
    "                                group=Group.no,\n",
    "                                scheme=Scheme.fixed,\n",
    "                                precision=0,\n",
    "                                nully=\"\",\n",
    "                            ),\n",
    "                        }\n",
    "                    )\n",
    "\n",
    "            crit_data = crit_table.to_dict(\"records\")\n",
    "\n",
    "            numeric_cols = [\n",
    "                c for c in crit_table.columns if c not in [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "            ]\n",
    "            style_data_conditional = []\n",
    "\n",
    "            # gradient 0–10, >10 green, blanks grey\n",
    "            bands = [\n",
    "                (0, 0, \"#7f0000\", \"white\"),\n",
    "                (1, 2, \"#b30000\", \"white\"),\n",
    "                (3, 4, \"#e31a1c\", \"white\"),\n",
    "                (5, 6, \"#fb9a99\", \"black\"),\n",
    "                (7, 8, \"#d9f0a3\", \"black\"),\n",
    "                (9, 10, \"#78c679\", \"black\"),\n",
    "                (11, 9999, \"#238443\", \"white\"),\n",
    "            ]\n",
    "            for col in numeric_cols:\n",
    "                for low, high, color, font_color in bands:\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\n",
    "                                \"filter_query\": (\n",
    "                                    f\"{{{col}}} >= {low} && {{{col}}} <= {high}\"\n",
    "                                ),\n",
    "                                \"column_id\": col,\n",
    "                            },\n",
    "                            \"backgroundColor\": color,\n",
    "                            \"color\": font_color,\n",
    "                        }\n",
    "                    )\n",
    "                # blanks (no forecast) -> grey\n",
    "                style_data_conditional.append(\n",
    "                    {\n",
    "                        \"if\": {\n",
    "                            \"filter_query\": f\"{{{col}}} = ''\",\n",
    "                            \"column_id\": col,\n",
    "                        },\n",
    "                        \"backgroundColor\": \"#e6e6e6\",\n",
    "                        \"color\": \"#6c757d\",\n",
    "                    }\n",
    "                )\n",
    "        else:\n",
    "            crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "    else:\n",
    "        crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "\n",
    "    # Inter Rotation Map\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord,\n",
    "            left_on=\"Branch\",\n",
    "            right_on=\"AI_BRANCH\",\n",
    "            how=\"left\",\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\",\n",
    "                axis=1,\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\n",
    "        \"%Y-%m-%d %H:%M:%S\"\n",
    "    )\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# ---------- helper for \"n selected\" labels ----------\n",
    "def _count_label(values, base):\n",
    "    if values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "8a64bab3-5106-4e0f-9e6f-329bfe38770b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c7645e80>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(\n",
    "        columns={c: col_map[c] for c in df.columns if c in col_map},\n",
    "        inplace=True,\n",
    "    )\n",
    "\n",
    "    # numeric conversions\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(\n",
    "            df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\"\n",
    "        )\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    # flags\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(\n",
    "        df[\"UpcomingPlan\"], errors=\"coerce\"\n",
    "    )\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    \"\"\"Standard multi dropdown with a label that shows 'n selected' above.\"\"\"\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\"):\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(\n",
    "                        title,\n",
    "                        className=\"text-muted\",\n",
    "                        style={\"fontSize\": \"0.9rem\"},\n",
    "                    ),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# DASH APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "\n",
    "        /* Dropdowns */\n",
    "        .fixed-multi-dropdown {\n",
    "            font-size: 11px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow: hidden;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "        /* hide chips in multi-select */\n",
    "        .fixed-multi-dropdown .Select-value {\n",
    "            display: none !important;\n",
    "        }\n",
    "\n",
    "        .global-search {\n",
    "            font-size: 11px;\n",
    "            height: 32px;\n",
    "        }\n",
    "\n",
    "        /* DataTable base style */\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th {\n",
    "            text-transform: none;\n",
    "        }\n",
    "        /* Hover effect for all tables */\n",
    "        .dash-table-container .dash-spreadsheet-container td:hover {\n",
    "            background-color: #eef4ff !important;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # HEADER\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\n",
    "                                \"Inventory & Supply Dashboard\",\n",
    "                                className=\"mt-2 mb-0\",\n",
    "                            ),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\",\n",
    "                                className=\"text-muted small\",\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=7,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\n",
    "                                            \"label\": \" Executive\",\n",
    "                                            \"value\": \"executive\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"label\": \" Analyst\",\n",
    "                                            \"value\": \"analyst\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    html.Img(\n",
    "                                        src=\"/assets/aujan_logo.png\",\n",
    "                                        style={\n",
    "                                            \"height\": \"65px\",\n",
    "                                            \"width\": \"180px\",\n",
    "                                            \"objectFit\": \"cover\",\n",
    "                                        },\n",
    "                                    ),\n",
    "                                    className=\"d-flex justify-content-end\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=5,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # FILTERS\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI BAR\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # TABS\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACKS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # -------- Base filtering on Summary --------\n",
    "    dff = df_full.copy()\n",
    "    if brands:\n",
    "        dff = dff[dff[\"Brand\"].isin(brands)]\n",
    "    if plants:\n",
    "        dff = dff[dff[\"Plant\"].isin(plants)]\n",
    "    if branches:\n",
    "        dff = dff[dff[\"Branch\"].isin(branches)]\n",
    "    if classes:\n",
    "        dff = dff[dff[\"Class\"].isin(classes)]\n",
    "    if busunits:\n",
    "        dff = dff[dff[\"BusinessUnit\"].isin(busunits)]\n",
    "    if ai_skus:\n",
    "        dff = dff[dff[\"SKU\"].isin(ai_skus)]\n",
    "    if oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        dff = dff[dff[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # Global search\n",
    "    if global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=dff.index)\n",
    "        for col in search_cols:\n",
    "            mask |= dff[col].astype(str).str.lower().str.contains(gs)\n",
    "        dff = dff[mask]\n",
    "\n",
    "    # Branch DC filter (for summary / KPIs)\n",
    "    dff_filtered = dff.copy()\n",
    "    if branch_dc:\n",
    "        mask = pd.Series(False, index=dff_filtered.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= dff_filtered[\"DaysToDepletion\"].between(7, 10)\n",
    "        dff_filtered = dff_filtered[mask]\n",
    "\n",
    "    # -------- OOS calculation (your logic) --------\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # KPI numbers\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Supply Risk SKUs\", risk_count, color=\"warning\"),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\"),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\"),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count),\n",
    "        ]\n",
    "\n",
    "    # Dates for table display\n",
    "    dff_filtered = dff_filtered.copy()\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "\n",
    "    # Plant Inventory Treemap\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                PlantInvPerc=(\"PlantInvPerc\", \"mean\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"PlantInvPerc\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"PlantInvPerc\": \":.1%\",\n",
    "                \"BalanceSupply\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}<br>%{value:.0%}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>PlantInv: %{customdata[1]:.1%}\"\n",
    "            \"<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"PlantInv %\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "\n",
    "    # OOS & Risk Bar\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(\n",
    "                OOS_Count=(\"IsOOS\", \"sum\"),\n",
    "                Risk_Count=(\"IsRisk\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col = \"Group\"\n",
    "        title = \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "\n",
    "    # Branch OOS Treemap\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "\n",
    "    # Information Table\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(\n",
    "                    group=Group.yes, scheme=Scheme.fixed, precision=0\n",
    "                ),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\n",
    "        \"records\"\n",
    "    )\n",
    "\n",
    "    # -------- Stock Criticality (filtered by SKUs & BU branches) --------\n",
    "    if not df_crit.empty:\n",
    "        valid_skus = dff[\"SKU\"].unique()\n",
    "        valid_branches = dff[\"Branch\"].unique()\n",
    "        dfc = df_crit[df_crit[\"AI_SKU\"].isin(valid_skus)].copy()\n",
    "\n",
    "        if not dfc.empty:\n",
    "            # Melt; Country & Class only used as id_vars (not in final table)\n",
    "            id_vars = [c for c in [\"AI_SKU\", \"AI_MFGBRND\", \"Class\", \"Country\"] if c in dfc.columns]\n",
    "            crit_pivot = dfc.melt(\n",
    "                id_vars=id_vars,\n",
    "                var_name=\"Branch\",\n",
    "                value_name=\"DaysCover\",\n",
    "            )\n",
    "\n",
    "            # keep only branches belonging to the filtered dataset (BU etc.)\n",
    "            if len(valid_branches) > 0:\n",
    "                crit_pivot = crit_pivot[crit_pivot[\"Branch\"].isin(valid_branches)]\n",
    "\n",
    "            # pivot back to wide; index only on AI_SKU & AI_MFGBRND (no Country)\n",
    "            crit_table = crit_pivot.pivot_table(\n",
    "                index=[\"AI_SKU\", \"AI_MFGBRND\"],\n",
    "                columns=\"Branch\",\n",
    "                values=\"DaysCover\",\n",
    "                aggfunc=\"first\",\n",
    "            ).reset_index()\n",
    "\n",
    "            # Ensure numeric branch columns & NaNs preserved\n",
    "            numeric_cols = [\n",
    "                c for c in crit_table.columns if c not in [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "            ]\n",
    "            crit_table[numeric_cols] = crit_table[numeric_cols].apply(\n",
    "                pd.to_numeric, errors=\"coerce\"\n",
    "            )\n",
    "\n",
    "            # Build columns definition\n",
    "            crit_columns = []\n",
    "            for c in crit_table.columns:\n",
    "                if c in [\"AI_SKU\", \"AI_MFGBRND\"]:\n",
    "                    crit_columns.append({\"name\": c, \"id\": c, \"type\": \"text\"})\n",
    "                else:\n",
    "                    crit_columns.append(\n",
    "                        {\n",
    "                            \"name\": c,\n",
    "                            \"id\": c,\n",
    "                            \"type\": \"numeric\",\n",
    "                            \"format\": Format(\n",
    "                                group=Group.no,\n",
    "                                scheme=Scheme.fixed,\n",
    "                                precision=0,\n",
    "                                nully=\"\",\n",
    "                            ),\n",
    "                        }\n",
    "                    )\n",
    "\n",
    "            crit_data = crit_table.to_dict(\"records\")\n",
    "\n",
    "            # Conditional formatting for gradient\n",
    "            style_data_conditional = []\n",
    "            # bands: (low, high, background, font)\n",
    "            bands = [\n",
    "                (0, 0, \"#7f0000\", \"white\"),    # darkest red\n",
    "                (1, 2, \"#b30000\", \"white\"),\n",
    "                (3, 4, \"#e31a1c\", \"white\"),\n",
    "                (5, 6, \"#fb9a99\", \"black\"),\n",
    "                (7, 8, \"#d9f0a3\", \"black\"),\n",
    "                (9, 10, \"#78c679\", \"black\"),\n",
    "                (11, 9999, \"#238443\", \"white\"),  # >10 dark green\n",
    "            ]\n",
    "            for col in numeric_cols:\n",
    "                for low, high, bg, font in bands:\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\n",
    "                                \"filter_query\": f\"{{{col}}} >= {low} && {{{col}}} <= {high}\",\n",
    "                                \"column_id\": col,\n",
    "                            },\n",
    "                            \"backgroundColor\": bg,\n",
    "                            \"color\": font,\n",
    "                        }\n",
    "                    )\n",
    "                # blanks / NaN -> grey\n",
    "                style_data_conditional.append(\n",
    "                    {\n",
    "                        \"if\": {\n",
    "                            \"filter_query\": f\"is nan {{{col}}}\",\n",
    "                            \"column_id\": col,\n",
    "                        },\n",
    "                        \"backgroundColor\": \"#e0e0e0\",\n",
    "                        \"color\": \"#6c757d\",\n",
    "                    }\n",
    "                )\n",
    "        else:\n",
    "            crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "    else:\n",
    "        crit_columns, crit_data, style_data_conditional = [], [], []\n",
    "\n",
    "    # Inter Rotation Map\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord,\n",
    "            left_on=\"Branch\",\n",
    "            right_on=\"AI_BRANCH\",\n",
    "            how=\"left\",\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\",\n",
    "                axis=1,\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\n",
    "        \"%Y-%m-%d %H:%M:%S\"\n",
    "    )\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# ---------- helper for \"n selected\" labels ----------\n",
    "def _count_label(values, base):\n",
    "    if values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "09e26656-d32a-44c6-9c7e-c3552238eaf2",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x223c9036c40>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n",
      "---------------------------------------------------------------------------\n",
      "NameError                                 Traceback (most recent call last)\n",
      "~\\AppData\\Local\\Temp\\ipykernel_28612\\1108935168.py in update_dashboard(\n",
      "    view_mode='executive',\n",
      "    brands=None,\n",
      "    plants=None,\n",
      "    branches=None,\n",
      "    classes=None,\n",
      "    busunits=None,\n",
      "    ai_skus=None,\n",
      "    branch_dc=None,\n",
      "    oversell=None,\n",
      "    global_search=None\n",
      ")\n",
      "   1071     dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
      "   1072     dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
      "-> 1073     info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
      "        info_data = undefined\n",
      "        dff_filtered =     Plant                                   SKU               Brand  \\\n",
      "0    ASDI             1212 BBN CAN APL 250MLX24  BARBICAN CAN 250ML   \n",
      "1    ASDI             1213 BBN CAN STB 250MLX24  BARBICAN CAN 250ML   \n",
      "2    ASDI                 0106 VIMTO COR 710x12       VIMTO CORDIAL   \n",
      "3    ASDI             1214 BBN CAN POM 250MLX24  BARBICAN CAN 250ML   \n",
      "4    ASDI          1237 BBN CAN STB 250MLX6X4MP  BARBICAN CAN 250ML   \n",
      "..    ...                                   ...                 ...   \n",
      "278  ASDI  2902 VIMTO 250ML PET BLACK FORT X 24            VIMTOPET   \n",
      "279  ASDI          263 VIMTO CORDIAL 650ML X 12       VIMTO CORDIAL   \n",
      "280  ASDI         2078 BBN POM CAN 330MLX24 OMN  BARBICAN CAN 330ML   \n",
      "281  ASDI    2075 BBN CAN REG 330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "282  ASDI     2081 BBN PCH CAN330ML MP(6X4) OMN  BARBICAN CAN 330ML   \n",
      "\n",
      "    BusinessUnit  Branch    Class DaysLess10  OOS PlantInv_>50%  \\\n",
      "0            KSA   HOFUF  Class A        Yes                Yes   \n",
      "1            KSA   HOFUF  Class A        Yes                Yes   \n",
      "2            KSA  RIYADH  Class A        Yes  OOS           Yes   \n",
      "3            KSA   HOFUF  Class A        Yes                 No   \n",
      "4            KSA  DAMMAM  Class B        Yes                Yes   \n",
      "..           ...     ...      ...        ...  ...           ...   \n",
      "278         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "279       KUWAIT  KUWAIT  Class C        Yes  OOS           Yes   \n",
      "280         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "281         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "282         GULF   SAHAM  Class C        Yes  OOS           Yes   \n",
      "\n",
      "     Total_SKU_Plant_Inventory  ...  Branch_DC_incl_GIT  \\\n",
      "0                        23792  ...   6.863309352517986   \n",
      "1                        20142  ...                5.85   \n",
      "2                       194709  ...   2.769274318064848   \n",
      "3                        32216  ...   6.386352598348713   \n",
      "4                         6160  ...    8.17449956483899   \n",
      "..                         ...  ...                 ...   \n",
      "278                      42739  ...   1.539473684210526   \n",
      "279                      14614  ...              7.9326   \n",
      "280                        720  ...  0.3779069767441861   \n",
      "281                        360  ...                   0   \n",
      "282                        878  ...                   0   \n",
      "\n",
      "                                         InterRotation IsOOS IsRisk  \\\n",
      "0    RIYADH (6910 CS), JIZAN (790 CS), KHAMIS (1364...     0      0   \n",
      "1    JIZAN (1002 CS), KHAMIS (2138 CS), MADINAH (17...     0      0   \n",
      "2    KHAMIS (11425 CS), MADINAH (5467 CS), TAIF (32...     1      0   \n",
      "3    KHAMIS (2196 CS), JEDDAH (7128 CS), TAIF (1644...     0      1   \n",
      "4    JIZAN (259 CS), MADINAH (319 CS), HOFUF (300 C...     0      0   \n",
      "..                                                 ...   ...    ...   \n",
      "278                         No inter-rotation possible     1      0   \n",
      "279                         No inter-rotation possible     1      0   \n",
      "280                                    MUSCAT (105 CS)     1      0   \n",
      "281                                   MUSCAT (1071 CS)     1      0   \n",
      "282                         No inter-rotation possible     1      0   \n",
      "\n",
      "    IsLowCover  IsBackorder IsOversell DepletionDate_parsed  \\\n",
      "0            1            1          0           2025-12-05   \n",
      "1            1            1          1           2025-12-04   \n",
      "2            1            1          0           2025-11-28   \n",
      "3            1            1          1           2025-12-01   \n",
      "4            1            1          1           2025-12-02   \n",
      "..         ...          ...        ...                  ...   \n",
      "278          1            0          1           2025-11-28   \n",
      "279          1            0          0           2025-11-27   \n",
      "280          1            0          0           2025-11-27   \n",
      "281          1            0          0           2025-11-26   \n",
      "282          1            0          0           2025-11-26   \n",
      "\n",
      "    UpcomingPlan_parsed  DaysToDepletion  \n",
      "0            2025-03-12                3  \n",
      "1            2025-03-12                2  \n",
      "2            2025-02-12               -4  \n",
      "3            2025-04-12               -1  \n",
      "4            2025-04-12                0  \n",
      "..                  ...              ...  \n",
      "278                 NaT               -4  \n",
      "279          2025-01-12               -5  \n",
      "280                 NaT               -5  \n",
      "281                 NaT               -6  \n",
      "282                 NaT               -6  \n",
      "\n",
      "[283 rows x 32 columns]\n",
      "        global c = undefined\n",
      "        global info_columns.to_dict = undefined\n",
      "   1074 \n",
      "   1075     # ============================\n",
      "\n",
      "NameError: name 'info_columns' is not defined\n",
      "\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(columns={c: col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\")\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    return pd.read_excel(path, sheet_name=sheet)\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown hide-chips\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\"):\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(title, className=\"text-muted\", style={\"fontSize\": \"0.9rem\"}),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "def _count_label(values, base):\n",
    "    if values and len(values) == 1:\n",
    "        return f\"{base} (1 selected)\"\n",
    "    elif values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        /* Dropdown styles */\n",
    "        .fixed-multi-dropdown { font-size: 11px; }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow: hidden;\n",
    "            position: relative;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "        /* Clear (x) button aligned right */\n",
    "        .fixed-multi-dropdown .Select-control .Select-clear-zone {\n",
    "            position: absolute;\n",
    "            right: 22px;\n",
    "            top: 0;\n",
    "            bottom: 0;\n",
    "            display: flex;\n",
    "            align-items: center;\n",
    "        }\n",
    "        /* chip visibility control */\n",
    "        .fixed-multi-dropdown.hide-chips .Select-value {\n",
    "            display: none !important;\n",
    "        }\n",
    "        .fixed-multi-dropdown.show-chips .Select-value {\n",
    "            display: inline-flex !important;\n",
    "        }\n",
    "\n",
    "        .global-search { font-size: 11px; height: 32px; }\n",
    "\n",
    "        /* DataTable styling */\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container td:hover {\n",
    "            background-color: #eef4ff !important;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "def normalize_branch(x):\n",
    "    return str(x).strip().replace(\"–\", \"-\").upper()\n",
    "\n",
    "df_full[\"Branch\"] = df_full[\"Branch\"].apply(normalize_branch)\n",
    "df_full[\"BusinessUnit\"] = df_full[\"BusinessUnit\"].str.upper()\n",
    "df_full[\"Brand\"] = df_full[\"Brand\"].str.upper()\n",
    "\n",
    "df_crit.rename(columns=lambda x: normalize_branch(x), inplace=True)\n",
    "df_crit[\"AI_SKU\"] = df_crit[\"AI_SKU\"].astype(str)\n",
    "df_crit[\"AI_MFGBRND\"] = df_crit[\"AI_MFGBRND\"].astype(str).str.upper()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # Header row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\"Inventory & Supply Dashboard\", className=\"mt-2 mb-0\"),\n",
    "                            html.Div(\"Executive & Analyst Views\", className=\"text-muted small\"),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=7,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\"label\": \" Executive\", \"value\": \"executive\"},\n",
    "                                        {\"label\": \" Analyst\", \"value\": \"analyst\"},\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    html.Img(\n",
    "                                        src=\"/assets/aujan_logo.png\",\n",
    "                                        style={\n",
    "                                            \"height\": \"65px\",\n",
    "                                            \"width\": \"180px\",\n",
    "                                            \"objectFit\": \"cover\",\n",
    "                                        },\n",
    "                                    ),\n",
    "                                    className=\"d-flex justify-content-end\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=5,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # Filters\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI row\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # Tabs\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# HELPER: APPLY FILTERS (used by multiple callbacks)\n",
    "# =========================================================\n",
    "def apply_filters(\n",
    "    base_df,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "    ignore=None,\n",
    "):\n",
    "    ignore = ignore or set()\n",
    "    df = base_df.copy()\n",
    "\n",
    "    if \"brand\" not in ignore and brands:\n",
    "        df = df[df[\"Brand\"].isin(brands)]\n",
    "    if \"plant\" not in ignore and plants:\n",
    "        df = df[df[\"Plant\"].isin(plants)]\n",
    "    if \"branch\" not in ignore and branches:\n",
    "        df = df[df[\"Branch\"].isin(branches)]\n",
    "    if \"class\" not in ignore and classes:\n",
    "        df = df[df[\"Class\"].isin(classes)]\n",
    "    if \"bu\" not in ignore and busunits:\n",
    "        df = df[df[\"BusinessUnit\"].isin(busunits)]\n",
    "    if \"sku\" not in ignore and ai_skus:\n",
    "        df = df[df[\"SKU\"].isin(ai_skus)]\n",
    "    if \"oversell\" not in ignore and oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        df = df[df[\"IsOversell\"].isin(flags)]\n",
    "\n",
    "    # branch DC band filtering\n",
    "    if \"dc\" not in ignore and branch_dc:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= df[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(7, 10)\n",
    "        df = df[mask]\n",
    "\n",
    "    # global search\n",
    "    if \"global\" not in ignore and global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for col in search_cols:\n",
    "            mask |= df[col].astype(str).str.lower().str.contains(gs)\n",
    "        df = df[mask]\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: SHOW/HIDE FILTERS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: CASCADING FILTER OPTIONS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"options\"),\n",
    "    Output(\"plant-filter\", \"options\"),\n",
    "    Output(\"branch-filter\", \"options\"),\n",
    "    Output(\"class-filter\", \"options\"),\n",
    "    Output(\"busunit-filter\", \"options\"),\n",
    "    Output(\"ai-sku-filter\", \"options\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_filter_options(\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # Brand options: ignore brand filter itself\n",
    "    df_brand = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "        ignore={\"brand\"},\n",
    "    )\n",
    "    brand_opts = [{\"label\": b, \"value\": b} for b in sorted(df_brand[\"Brand\"].unique())]\n",
    "\n",
    "    # Plant options\n",
    "    df_plant = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "        ignore={\"plant\"},\n",
    "    )\n",
    "    plant_opts = [{\"label\": p, \"value\": p} for p in sorted(df_plant[\"Plant\"].unique())]\n",
    "\n",
    "    # Branch options\n",
    "    df_branch = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "        ignore={\"branch\"},\n",
    "    )\n",
    "    branch_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_branch[\"Branch\"].unique())\n",
    "    ]\n",
    "\n",
    "    # Class options\n",
    "    df_class = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "        ignore={\"class\"},\n",
    "    )\n",
    "    class_opts = [\n",
    "        {\"label\": c, \"value\": c} for c in sorted(df_class[\"Class\"].unique())\n",
    "    ]\n",
    "\n",
    "    # BU options\n",
    "    df_bu = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "        ignore={\"bu\"},\n",
    "    )\n",
    "    bu_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_bu[\"BusinessUnit\"].unique())\n",
    "    ]\n",
    "\n",
    "    # SKU options (Option 1 – only SKUs inside filtered dataset)\n",
    "    df_sku = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "        ignore={\"sku\"},\n",
    "    )\n",
    "    sku_opts = [{\"label\": s, \"value\": s} for s in sorted(df_sku[\"SKU\"].unique())]\n",
    "\n",
    "    return brand_opts, plant_opts, branch_opts, class_opts, bu_opts, sku_opts\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: CLASSNAME FOR CHIPS (show for 1, hide for >1)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"className\"),\n",
    "    Output(\"plant-filter\", \"className\"),\n",
    "    Output(\"branch-filter\", \"className\"),\n",
    "    Output(\"class-filter\", \"className\"),\n",
    "    Output(\"busunit-filter\", \"className\"),\n",
    "    Output(\"ai-sku-filter\", \"className\"),\n",
    "    Output(\"branch-dc-filter\", \"className\"),\n",
    "    Output(\"oversell-filter\", \"className\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    ")\n",
    "def update_dropdown_classes(\n",
    "    brand_v,\n",
    "    plant_v,\n",
    "    branch_v,\n",
    "    class_v,\n",
    "    bu_v,\n",
    "    sku_v,\n",
    "    dc_v,\n",
    "    oversell_v,\n",
    "):\n",
    "    def cls(v):\n",
    "        if v and len(v) == 1:\n",
    "            return \"fixed-multi-dropdown show-chips\"\n",
    "        return \"fixed-multi-dropdown hide-chips\"\n",
    "\n",
    "    return (\n",
    "        cls(brand_v),\n",
    "        cls(plant_v),\n",
    "        cls(branch_v),\n",
    "        cls(class_v),\n",
    "        cls(bu_v),\n",
    "        cls(sku_v),\n",
    "        cls(dc_v),\n",
    "        cls(oversell_v),\n",
    "    )\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    global_search,\n",
    "):\n",
    "    # ============================\n",
    "    # 1. FILTER BASE DATA\n",
    "    # ============================\n",
    "    dff = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        global_search,\n",
    "    )\n",
    "\n",
    "    dff_filtered = dff.copy()\n",
    "\n",
    "    # — numeric handling\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    # ============================\n",
    "    # 2. KPI CALCULATION\n",
    "    # ============================\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"Total_SKU_Plant_Inventory\"].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Supply Risk SKUs\", risk_count, color=\"warning\"),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\"),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\"),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\"),\n",
    "            kpi_card(\"Total OOS Cases\", f\"{total_oos_cases:,}\", color=\"danger\"),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count),\n",
    "        ]\n",
    "\n",
    "    # ============================\n",
    "    # 3. INFO TABLE DATA\n",
    "    # ============================\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
    "\n",
    "    # ============================\n",
    "    # 4. STOCK CRITICALITY TABLE\n",
    "    # ============================\n",
    "    crit_columns = []\n",
    "    crit_data = []\n",
    "    style_data_conditional = []\n",
    "\n",
    "    try:\n",
    "        if not df_crit.empty:\n",
    "            crit = df_crit.copy()\n",
    "            crit.rename(columns=lambda x: normalize_branch(x), inplace=True)\n",
    "            full_filtered_branches = dff_filtered[\"Branch\"].unique()\n",
    "\n",
    "            crit_filtered = crit.copy()\n",
    "            base_cols = [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "            branch_cols = [c for c in crit_filtered.columns if c in full_filtered_branches]\n",
    "            final_cols = base_cols + branch_cols\n",
    "\n",
    "            if len(branch_cols) > 0:\n",
    "                crit_filtered = crit_filtered[final_cols]\n",
    "                crit_columns = [{\"name\": c, \"id\": c} for c in final_cols]\n",
    "                crit_data = crit_filtered.to_dict(\"records\")\n",
    "\n",
    "                numeric_cols = branch_cols\n",
    "                bands = [\n",
    "                    (0, 0, \"#7f0000\", \"white\"),\n",
    "                    (1, 2, \"#b30000\", \"white\"),\n",
    "                    (3, 4, \"#e31a1c\", \"white\"),\n",
    "                    (5, 6, \"#fb9a99\", \"black\"),\n",
    "                    (7, 8, \"#d9f0a3\", \"black\"),\n",
    "                    (9, 10, \"#78c679\", \"black\"),\n",
    "                    (11, 9999, \"#238443\", \"white\"),\n",
    "                ]\n",
    "                for col in numeric_cols:\n",
    "                    for low, high, bg, font in bands:\n",
    "                        style_data_conditional.append(\n",
    "                            {\n",
    "                                \"if\": {\n",
    "                                    \"filter_query\": f\"{{{col}}} >= {low} && {{{col}}} <= {high}\",\n",
    "                                    \"column_id\": col,\n",
    "                                },\n",
    "                                \"backgroundColor\": bg,\n",
    "                                \"color\": font,\n",
    "                            }\n",
    "                        )\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\"filter_query\": f\"is nan {{{col}}}\", \"column_id\": col},\n",
    "                            \"backgroundColor\": \"#e0e0e0\",\n",
    "                            \"color\": \"#6c757d\",\n",
    "                        }\n",
    "                    )\n",
    "    except Exception as e:\n",
    "        print(\"CRIT TABLE ERROR:\", e)\n",
    "\n",
    "    # ============================\n",
    "    # 5. INTER-ROTATION MAP\n",
    "    # ============================\n",
    "    df_inter = explode_interrotation(dff)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\").dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "        df_map[\"Label\"] = df_map.apply(lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\", axis=1)\n",
    "        fig_inter = px.scatter_mapbox(df_map, lat=\"Latitude\", lon=\"Longitude\", size=\"Cases\",\n",
    "                                      color=\"Cases\", text=\"Label\",\n",
    "                                      hover_name=\"Label\",\n",
    "                                      hover_data={\"Cases\": True},\n",
    "                                      zoom=4, mapbox_style=\"carto-positron\")\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n",
    "\n",
    "    # ============================\n",
    "    # 6. FINAL RETURN\n",
    "    # ============================\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "# =========================================================\n",
    "# LABEL COUNTS\n",
    "# =========================================================\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN APP\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "666981dc-cc82-47a8-a40a-2bb1d1bddcd9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x2a4c07f2850>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "import io\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "from dash.dcc import send_bytes\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "def normalize_branch(x):\n",
    "    return str(x).strip().replace(\"–\", \"-\").upper()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(columns={c: col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\")\n",
    "        \n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    return pd.read_excel(path, sheet_name=sheet)\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# Normalise names for joins and filters\n",
    "df_full[\"Branch\"] = df_full[\"Branch\"].apply(normalize_branch)\n",
    "df_full[\"BusinessUnit\"] = df_full[\"BusinessUnit\"].str.upper()\n",
    "df_full[\"Brand\"] = df_full[\"Brand\"].str.upper()\n",
    "\n",
    "df_crit.rename(columns=lambda x: normalize_branch(x), inplace=True)\n",
    "df_crit[\"AI_SKU\"] = df_crit[\"AI_SKU\"].astype(str)\n",
    "df_crit[\"AI_MFGBRND\"] = df_crit[\"AI_MFGBRND\"].astype(str).str.upper()\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "RISK_FILTER = [\"Yes\", \"No\"]  # Yes/No based on IsRisk\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown hide-chips\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\", trend=None):\n",
    "    icon = \"\"\n",
    "    if trend == \"up\":\n",
    "        icon = \"▲ \"\n",
    "    elif trend == \"down\":\n",
    "        icon = \"▼ \"\n",
    "    elif trend == \"flat\":\n",
    "        icon = \"■ \"\n",
    "    label = icon + title if icon else title\n",
    "\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(label, className=\"text-muted\", style={\"fontSize\": \"0.9rem\"}),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "def _count_label(values, base):\n",
    "    if values and len(values) == 1:\n",
    "        return f\"{base} (1 selected)\"\n",
    "    elif values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        /* Dropdown styles */\n",
    "        .fixed-multi-dropdown { font-size: 11px; }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow: hidden;\n",
    "            position: relative;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control .Select-clear-zone {\n",
    "            position: absolute;\n",
    "            right: 22px;\n",
    "            top: 0;\n",
    "            bottom: 0;\n",
    "            display: flex;\n",
    "            align-items: center;\n",
    "        }\n",
    "        .fixed-multi-dropdown.hide-chips .Select-value {\n",
    "            display: none !important;\n",
    "        }\n",
    "        .fixed-multi-dropdown.show-chips .Select-value {\n",
    "            display: inline-flex !important;\n",
    "        }\n",
    "\n",
    "        .global-search { font-size: 11px; height: 32px; }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container td:hover {\n",
    "            background-color: #eef4ff !important;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # Header row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\"Inventory & Supply Dashboard\", className=\"mt-2 mb-0\"),\n",
    "                            html.Div(\"Executive & Analyst Views\", className=\"text-muted small\"),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\"label\": \" Executive\", \"value\": \"executive\"},\n",
    "                                        {\"label\": \" Analyst\", \"value\": \"analyst\"},\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"theme-mode\",\n",
    "                                    options=[\n",
    "                                        {\"label\": \" Light\", \"value\": \"light\"},\n",
    "                                        {\"label\": \" Dark\", \"value\": \"dark\"},\n",
    "                                        {\"label\": \" Corporate\", \"value\": \"corp\"},\n",
    "                                    ],\n",
    "                                    value=\"light\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    html.Img(\n",
    "                                        src=\"/assets/aujan_logo.png\",\n",
    "                                        style={\n",
    "                                            \"height\": \"90px\",\n",
    "                                            \"width\": \"220px\",\n",
    "                                            \"objectFit\": \"contain\",\n",
    "                                        },\n",
    "                                    ),\n",
    "                                    className=\"d-flex justify-content-end\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # Auto-refresh interval (2 minutes)\n",
    "        dcc.Interval(id=\"refresh-interval\", interval=120000, n_intervals=0),\n",
    "\n",
    "        # Filters row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "\n",
    "        # Filter panel\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"risk-filter\",\n",
    "                                        \"risk-count-label\",\n",
    "                                        RISK_FILTER,\n",
    "                                        \"Risk\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI row\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # Tabs\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Criticality.xlsx\",\n",
    "                                                id=\"crit-export-btn\",\n",
    "                                                color=\"success\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"crit-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"WhiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                ),\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# HELPER: APPLY FILTERS\n",
    "# =========================================================\n",
    "def apply_filters(\n",
    "    base_df,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    ignore=None,\n",
    "):\n",
    "    ignore = ignore or set()\n",
    "    df = base_df.copy()\n",
    "\n",
    "    if \"brand\" not in ignore and brands:\n",
    "        df = df[df[\"Brand\"].isin(brands)]\n",
    "    if \"plant\" not in ignore and plants:\n",
    "        df = df[df[\"Plant\"].isin(plants)]\n",
    "    if \"branch\" not in ignore and branches:\n",
    "        df = df[df[\"Branch\"].isin(branches)]\n",
    "    if \"class\" not in ignore and classes:\n",
    "        df = df[df[\"Class\"].isin(classes)]\n",
    "    if \"bu\" not in ignore and busunits:\n",
    "        df = df[df[\"BusinessUnit\"].isin(busunits)]\n",
    "    if \"sku\" not in ignore and ai_skus:\n",
    "        df = df[df[\"SKU\"].isin(ai_skus)]\n",
    "    if \"oversell\" not in ignore and oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        df = df[df[\"IsOversell\"].isin(flags)]\n",
    "    if \"risk\" not in ignore and risk:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        if \"Yes\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 1\n",
    "        if \"No\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 0\n",
    "        df = df[mask]\n",
    "\n",
    "    # branch DC band filtering\n",
    "    if \"dc\" not in ignore and branch_dc:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= df[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(7, 10)\n",
    "        df = df[mask]\n",
    "\n",
    "    # global search\n",
    "    if \"global\" not in ignore and global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for col in search_cols:\n",
    "            mask |= df[col].astype(str).str.lower().str.contains(gs)\n",
    "        df = df[mask]\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: SHOW/HIDE FILTERS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: CASCADING FILTER OPTIONS (BU → Branch restricted)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"options\"),\n",
    "    Output(\"plant-filter\", \"options\"),\n",
    "    Output(\"branch-filter\", \"options\"),\n",
    "    Output(\"class-filter\", \"options\"),\n",
    "    Output(\"busunit-filter\", \"options\"),\n",
    "    Output(\"ai-sku-filter\", \"options\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_filter_options(\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "):\n",
    "    # Brand options\n",
    "    df_brand = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"brand\"},\n",
    "    )\n",
    "    brand_opts = [{\"label\": b, \"value\": b} for b in sorted(df_brand[\"Brand\"].unique())]\n",
    "\n",
    "    # Plant options\n",
    "    df_plant = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"plant\"},\n",
    "    )\n",
    "    plant_opts = [{\"label\": p, \"value\": p} for p in sorted(df_plant[\"Plant\"].unique())]\n",
    "\n",
    "    # Branch options (respect BU filter automatically)\n",
    "    df_branch = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"branch\"},\n",
    "    )\n",
    "    branch_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_branch[\"Branch\"].unique())\n",
    "    ]\n",
    "\n",
    "    # Class options\n",
    "    df_class = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"class\"},\n",
    "    )\n",
    "    class_opts = [\n",
    "        {\"label\": c, \"value\": c} for c in sorted(df_class[\"Class\"].unique())\n",
    "    ]\n",
    "\n",
    "    # BU options\n",
    "    df_bu = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"bu\"},\n",
    "    )\n",
    "    bu_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_bu[\"BusinessUnit\"].unique())\n",
    "    ]\n",
    "\n",
    "    # SKU options\n",
    "    df_sku = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"sku\"},\n",
    "    )\n",
    "    sku_opts = [{\"label\": s, \"value\": s} for s in sorted(df_sku[\"SKU\"].unique())]\n",
    "\n",
    "    return brand_opts, plant_opts, branch_opts, class_opts, bu_opts, sku_opts\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: DROPDOWN CLASS (chip display logic)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"className\"),\n",
    "    Output(\"plant-filter\", \"className\"),\n",
    "    Output(\"branch-filter\", \"className\"),\n",
    "    Output(\"class-filter\", \"className\"),\n",
    "    Output(\"busunit-filter\", \"className\"),\n",
    "    Output(\"ai-sku-filter\", \"className\"),\n",
    "    Output(\"branch-dc-filter\", \"className\"),\n",
    "    Output(\"oversell-filter\", \"className\"),\n",
    "    Output(\"risk-filter\", \"className\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    ")\n",
    "def update_dropdown_classes(\n",
    "    brand_v,\n",
    "    plant_v,\n",
    "    branch_v,\n",
    "    class_v,\n",
    "    bu_v,\n",
    "    sku_v,\n",
    "    dc_v,\n",
    "    oversell_v,\n",
    "    risk_v,\n",
    "):\n",
    "    def cls(v):\n",
    "        if v and len(v) == 1:\n",
    "            return \"fixed-multi-dropdown show-chips\"\n",
    "        return \"fixed-multi-dropdown hide-chips\"\n",
    "\n",
    "    return (\n",
    "        cls(brand_v),\n",
    "        cls(plant_v),\n",
    "        cls(branch_v),\n",
    "        cls(class_v),\n",
    "        cls(bu_v),\n",
    "        cls(sku_v),\n",
    "        cls(dc_v),\n",
    "        cls(oversell_v),\n",
    "        cls(risk_v),\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# MAIN DASHBOARD CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"theme-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    "    Input(\"refresh-interval\", \"n_intervals\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    theme_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    n_intervals,\n",
    "):\n",
    "    # ---- Filter summary\n",
    "    dff = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "    )\n",
    "    dff_filtered = dff.copy()\n",
    "\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    # ---- OOS logic\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\n",
    "                \"Total_SKU_Plant_Inventory\"\n",
    "            ].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    # KPI trend directions (simple: up if >0, else flat)\n",
    "    oos_trend = \"up\" if total_oos_cases > 0 else \"flat\"\n",
    "    risk_trend = \"up\" if risk_count > 0 else \"flat\"\n",
    "    bo_trend = \"up\" if bo_count > 0 else \"flat\"\n",
    "    oversell_trend = \"up\" if oversell_count > 0 else \"flat\"\n",
    "    bal_trend = \"up\" if bal_supply_sum > 0 else \"flat\"\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\n",
    "                \"Supply Risk SKUs\", risk_count, color=\"warning\", trend=risk_trend\n",
    "            ),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\", trend=bo_trend),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count, trend=risk_trend),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count, trend=bo_trend),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover, trend=\"flat\"),\n",
    "            kpi_card(\n",
    "                \"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend\n",
    "            ),\n",
    "        ]\n",
    "\n",
    "    # ---- Info table columns (UpcomingPlan in both views)\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    # dates for table\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
    "\n",
    "    # THEME HELPER\n",
    "    def apply_theme(fig):\n",
    "        if theme_mode == \"dark\":\n",
    "            fig.update_layout(\n",
    "                template=\"plotly_dark\",\n",
    "                paper_bgcolor=\"#121212\",\n",
    "                plot_bgcolor=\"#121212\",\n",
    "                font_color=\"#f8f9fa\",\n",
    "            )\n",
    "        elif theme_mode == \"corp\":\n",
    "            fig.update_layout(\n",
    "                template=\"plotly\",\n",
    "                paper_bgcolor=\"#fffaf3\",\n",
    "                plot_bgcolor=\"#fffaf3\",\n",
    "                font_color=\"#212529\",\n",
    "                title_font_color=\"#b8860b\",\n",
    "            )\n",
    "        else:\n",
    "            fig.update_layout(\n",
    "                template=\"plotly\",\n",
    "                paper_bgcolor=\"#ffffff\",\n",
    "                plot_bgcolor=\"#ffffff\",\n",
    "                font_color=\"#212529\",\n",
    "            )\n",
    "        return fig\n",
    "\n",
    "    # ---- Plant Inventory Treemap\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                PlantInvPerc=(\"PlantInvPerc\", \"mean\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"PlantInvPerc\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"PlantInvPerc\": \":.1%\",\n",
    "                \"BalanceSupply\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}<br>%{value:.0%}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>PlantInv: %{customdata[1]:.1%}\"\n",
    "            \"<br>Balance Supply: %{customdata[2]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"PlantInv %\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "    fig_inv = apply_theme(fig_inv)\n",
    "\n",
    "    # ---- OOS & Risk Bar\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title_bar = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title_bar = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(OOS_Count=(\"IsOOS\", \"sum\"), Risk_Count=(\"IsRisk\", \"sum\"))\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col, title_bar = \"Group\", \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title_bar,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "    fig_bar = apply_theme(fig_bar)\n",
    "\n",
    "    # ---- Branch OOS Treemap\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "    fig_treemap = apply_theme(fig_treemap)\n",
    "\n",
    "    # ---- Stock Criticality Table (Option A: only branches present in filtered data)\n",
    "    crit_columns = []\n",
    "    crit_data = []\n",
    "    style_data_conditional = []\n",
    "\n",
    "    try:\n",
    "        if not dff_filtered.empty and not df_crit.empty:\n",
    "            crit_filtered = df_crit.copy()\n",
    "            base_cols = [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "\n",
    "            # branch columns = intersection of crit sheet columns and filtered branches\n",
    "            branch_set = set(dff_filtered[\"Branch\"].unique())\n",
    "            branch_cols = [\n",
    "                c for c in crit_filtered.columns if c not in base_cols and c in branch_set\n",
    "            ]\n",
    "\n",
    "            if branch_cols:\n",
    "                # convert only these branch columns to numeric\n",
    "                for col in branch_cols:\n",
    "                    crit_filtered[col] = pd.to_numeric(crit_filtered[col], errors=\"coerce\").round(0).astype('Int64')\n",
    "\n",
    "                final_cols = base_cols + branch_cols\n",
    "                crit_filtered = crit_filtered[final_cols]\n",
    "\n",
    "                # replace NaN with None (shows as blank in Dash)\n",
    "                crit_filtered = crit_filtered.replace({np.nan: None})\n",
    "\n",
    "                crit_columns = [{\"name\": c, \"id\": c} for c in final_cols]\n",
    "                crit_data = crit_filtered.to_dict(\"records\")\n",
    "\n",
    "                # Conditional formatting for numeric branch columns\n",
    "                bands = [\n",
    "                    (0, 0, \"#7f0000\", \"white\"),\n",
    "                    (1, 2, \"#b30000\", \"white\"),\n",
    "                    (3, 4, \"#e31a1c\", \"white\"),\n",
    "                    (5, 6, \"#fb9a99\", \"black\"),\n",
    "                    (7, 8, \"#d9f0a3\", \"black\"),\n",
    "                    (9, 10, \"#78c679\", \"black\"),\n",
    "                    (11, 9999, \"#238443\", \"white\"),\n",
    "                ]\n",
    "                for col in branch_cols:\n",
    "                    for low, high, bg, font in bands:\n",
    "                        style_data_conditional.append(\n",
    "                            {\n",
    "                                \"if\": {\n",
    "                                    \"column_id\": col,\n",
    "                                    \"filter_query\": f\"{{{col}}} >= {low} && {{{col}}} <= {high}\",\n",
    "                                },\n",
    "                                \"backgroundColor\": bg,\n",
    "                                \"color\": font,\n",
    "                            }\n",
    "                        )\n",
    "                    # blanks (None) – grey\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\n",
    "                                \"column_id\": col,\n",
    "                                \"filter_query\": f\"{{{col}}} is blank\",\n",
    "                            },\n",
    "                            \"backgroundColor\": \"#e0e0e0\",\n",
    "                            \"color\": \"#6c757d\",\n",
    "                        }\n",
    "                    )\n",
    "\n",
    "            # if branch_cols is empty, crit_columns & crit_data stay empty => empty table, no JS error\n",
    "    except Exception as e:\n",
    "        print(\"CRIT TABLE ERROR:\", e)\n",
    "        crit_columns = []\n",
    "        crit_data = []\n",
    "        style_data_conditional = []\n",
    "\n",
    "    # ---- Inter-rotation Map\n",
    "    df_inter = explode_interrotation(dff_filtered)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\"\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\", axis=1\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "    fig_inter = apply_theme(fig_inter)\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CRITICALITY EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"crit-download\", \"data\"),\n",
    "    Input(\"crit-export-btn\", \"n_clicks\"),\n",
    "    State(\"crit-table\", \"data\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_criticality(n_clicks, rows):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Criticality\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Stock_Criticality.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LABEL COUNTS\n",
    "# =========================================================\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"risk-count-label\", \"children\"), Input(\"risk-filter\", \"value\"))\n",
    "def _risk_count(v):\n",
    "    return _count_label(v, \"Risk\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN APP\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "3069d9a3-c042-44af-ab24-8692e6fb3ca0",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x2a4c3a4c520>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "import io\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "from dash.dcc import send_bytes\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "def normalize_branch(x):\n",
    "    return str(x).strip().replace(\"–\", \"-\").upper()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(columns={c: col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    # PlantInvPerc as fraction (0.953 for 95.3%)\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\")\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    return pd.read_excel(path, sheet_name=sheet)\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# Normalise names for joins and filters\n",
    "df_full[\"Branch\"] = df_full[\"Branch\"].apply(normalize_branch)\n",
    "df_full[\"BusinessUnit\"] = df_full[\"BusinessUnit\"].str.upper()\n",
    "df_full[\"Brand\"] = df_full[\"Brand\"].str.upper()\n",
    "\n",
    "df_crit.rename(columns=lambda x: normalize_branch(x), inplace=True)\n",
    "df_crit[\"AI_SKU\"] = df_crit[\"AI_SKU\"].astype(str)\n",
    "df_crit[\"AI_MFGBRND\"] = df_crit[\"AI_MFGBRND\"].astype(str).str.upper()\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "RISK_FILTER = [\"Yes\", \"No\"]  # Yes/No based on IsRisk\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown hide-chips\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\", trend=None):\n",
    "    icon = \"\"\n",
    "    if trend == \"up\":\n",
    "        icon = \"▲ \"\n",
    "    elif trend == \"down\":\n",
    "        icon = \"▼ \"\n",
    "    elif trend == \"flat\":\n",
    "        icon = \"■ \"\n",
    "    label = icon + title if icon else title\n",
    "\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(label, className=\"text-muted\", style={\"fontSize\": \"0.9rem\"}),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "def _count_label(values, base):\n",
    "    if values and len(values) == 1:\n",
    "        return f\"{base} (1 selected)\"\n",
    "    elif values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        /* Dropdown styles */\n",
    "        .fixed-multi-dropdown { font-size: 11px; }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow: hidden;\n",
    "            position: relative;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control .Select-clear-zone {\n",
    "            position: absolute;\n",
    "            right: 22px;\n",
    "            top: 0;\n",
    "            bottom: 0;\n",
    "            display: flex;\n",
    "            align-items: center;\n",
    "        }\n",
    "        .fixed-multi-dropdown.hide-chips .Select-value {\n",
    "            display: none !important;\n",
    "        }\n",
    "        .fixed-multi-dropdown.show-chips .Select-value {\n",
    "            display: inline-flex !important;\n",
    "        }\n",
    "\n",
    "        .global-search { font-size: 11px; height: 32px; }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container td:hover {\n",
    "            background-color: #eef4ff !important;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # Header row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\"Inventory & Supply Dashboard\", className=\"mt-2 mb-0\"),\n",
    "                            html.Div(\"Executive & Analyst Views\", className=\"text-muted small\"),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\"label\": \" Executive\", \"value\": \"executive\"},\n",
    "                                        {\"label\": \" Analyst\", \"value\": \"analyst\"},\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    html.Img(\n",
    "                                        src=\"/assets/aujan_logo.png\",\n",
    "                                        style={\n",
    "                                            \"height\": \"90px\",\n",
    "                                            \"width\": \"220px\",\n",
    "                                            \"objectFit\": \"contain\",\n",
    "                                        },\n",
    "                                    ),\n",
    "                                    className=\"d-flex justify-content-end\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # Auto-refresh interval (2 minutes)\n",
    "        dcc.Interval(id=\"refresh-interval\", interval=120000, n_intervals=0),\n",
    "\n",
    "        # Filters row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "\n",
    "        # Filter panel\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"risk-filter\",\n",
    "                                        \"risk-count-label\",\n",
    "                                        RISK_FILTER,\n",
    "                                        \"Risk\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI row\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # Tabs\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Information.xlsx\",\n",
    "                                                id=\"info-export-btn\",\n",
    "                                                color=\"primary\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"info-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Criticality.xlsx\",\n",
    "                                                id=\"crit-export-btn\",\n",
    "                                                color=\"success\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"crit-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"WhiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                ),\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# HELPER: APPLY FILTERS\n",
    "# =========================================================\n",
    "def apply_filters(\n",
    "    base_df,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    ignore=None,\n",
    "):\n",
    "    ignore = ignore or set()\n",
    "    df = base_df.copy()\n",
    "\n",
    "    if \"brand\" not in ignore and brands:\n",
    "        df = df[df[\"Brand\"].isin(brands)]\n",
    "    if \"plant\" not in ignore and plants:\n",
    "        df = df[df[\"Plant\"].isin(plants)]\n",
    "    if \"branch\" not in ignore and branches:\n",
    "        df = df[df[\"Branch\"].isin(branches)]\n",
    "    if \"class\" not in ignore and classes:\n",
    "        df = df[df[\"Class\"].isin(classes)]\n",
    "    if \"bu\" not in ignore and busunits:\n",
    "        df = df[df[\"BusinessUnit\"].isin(busunits)]\n",
    "    if \"sku\" not in ignore and ai_skus:\n",
    "        df = df[df[\"SKU\"].isin(ai_skus)]\n",
    "    if \"oversell\" not in ignore and oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        df = df[df[\"IsOversell\"].isin(flags)]\n",
    "    if \"risk\" not in ignore and risk:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        if \"Yes\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 1\n",
    "        if \"No\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 0\n",
    "        df = df[mask]\n",
    "\n",
    "    # branch DC band filtering\n",
    "    if \"dc\" not in ignore and branch_dc:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= df[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(7, 10)\n",
    "        df = df[mask]\n",
    "\n",
    "    # global search\n",
    "    if \"global\" not in ignore and global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for col in search_cols:\n",
    "            mask |= df[col].astype(str).str.lower().str.contains(gs)\n",
    "        df = df[mask]\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: SHOW/HIDE FILTERS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: CASCADING FILTER OPTIONS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"options\"),\n",
    "    Output(\"plant-filter\", \"options\"),\n",
    "    Output(\"branch-filter\", \"options\"),\n",
    "    Output(\"class-filter\", \"options\"),\n",
    "    Output(\"busunit-filter\", \"options\"),\n",
    "    Output(\"ai-sku-filter\", \"options\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_filter_options(\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "):\n",
    "    # Brand options\n",
    "    df_brand = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"brand\"},\n",
    "    )\n",
    "    brand_opts = [{\"label\": b, \"value\": b} for b in sorted(df_brand[\"Brand\"].unique())]\n",
    "\n",
    "    # Plant options\n",
    "    df_plant = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"plant\"},\n",
    "    )\n",
    "    plant_opts = [{\"label\": p, \"value\": p} for p in sorted(df_plant[\"Plant\"].unique())]\n",
    "\n",
    "    # Branch options\n",
    "    df_branch = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"branch\"},\n",
    "    )\n",
    "    branch_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_branch[\"Branch\"].unique())\n",
    "    ]\n",
    "\n",
    "    # Class options\n",
    "    df_class = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"class\"},\n",
    "    )\n",
    "    class_opts = [\n",
    "        {\"label\": c, \"value\": c} for c in sorted(df_class[\"Class\"].unique())\n",
    "    ]\n",
    "\n",
    "    # BU options\n",
    "    df_bu = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"bu\"},\n",
    "    )\n",
    "    bu_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_bu[\"BusinessUnit\"].unique())\n",
    "    ]\n",
    "\n",
    "    # SKU options\n",
    "    df_sku = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"sku\"},\n",
    "    )\n",
    "    sku_opts = [{\"label\": s, \"value\": s} for s in sorted(df_sku[\"SKU\"].unique())]\n",
    "\n",
    "    return brand_opts, plant_opts, branch_opts, class_opts, bu_opts, sku_opts\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: DROPDOWN CLASS (chip display logic)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"className\"),\n",
    "    Output(\"plant-filter\", \"className\"),\n",
    "    Output(\"branch-filter\", \"className\"),\n",
    "    Output(\"class-filter\", \"className\"),\n",
    "    Output(\"busunit-filter\", \"className\"),\n",
    "    Output(\"ai-sku-filter\", \"className\"),\n",
    "    Output(\"branch-dc-filter\", \"className\"),\n",
    "    Output(\"oversell-filter\", \"className\"),\n",
    "    Output(\"risk-filter\", \"className\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    ")\n",
    "def update_dropdown_classes(\n",
    "    brand_v,\n",
    "    plant_v,\n",
    "    branch_v,\n",
    "    class_v,\n",
    "    bu_v,\n",
    "    sku_v,\n",
    "    dc_v,\n",
    "    oversell_v,\n",
    "    risk_v,\n",
    "):\n",
    "    def cls(v):\n",
    "        if v and len(v) == 1:\n",
    "            return \"fixed-multi-dropdown show-chips\"\n",
    "        return \"fixed-multi-dropdown hide-chips\"\n",
    "\n",
    "    return (\n",
    "        cls(brand_v),\n",
    "        cls(plant_v),\n",
    "        cls(branch_v),\n",
    "        cls(class_v),\n",
    "        cls(bu_v),\n",
    "        cls(sku_v),\n",
    "        cls(dc_v),\n",
    "        cls(oversell_v),\n",
    "        cls(risk_v),\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# MAIN DASHBOARD CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    "    Input(\"refresh-interval\", \"n_intervals\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    n_intervals,\n",
    "):\n",
    "    # ---- Filter summary\n",
    "    dff = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "    )\n",
    "    dff_filtered = dff.copy()\n",
    "\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    # ---- OOS logic\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0]\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\n",
    "                \"Total_SKU_Plant_Inventory\"\n",
    "            ].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "    else:\n",
    "        oos_calc = pd.DataFrame(columns=[\"SKU\", \"Plant\", \"OOS_Cases\"])\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    # KPI trend directions (simple: up if >0, else flat)\n",
    "    oos_trend = \"up\" if total_oos_cases > 0 else \"flat\"\n",
    "    risk_trend = \"up\" if risk_count > 0 else \"flat\"\n",
    "    bo_trend = \"up\" if bo_count > 0 else \"flat\"\n",
    "    oversell_trend = \"up\" if oversell_count > 0 else \"flat\"\n",
    "    bal_trend = \"up\" if bal_supply_sum > 0 else \"flat\"\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\n",
    "                \"Supply Risk SKUs\", risk_count, color=\"warning\", trend=risk_trend\n",
    "            ),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\", trend=bo_trend),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count, trend=risk_trend),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count, trend=bo_trend),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover, trend=\"flat\"),\n",
    "            kpi_card(\n",
    "                \"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend\n",
    "            ),\n",
    "        ]\n",
    "\n",
    "    # ---- Info table columns (UpcomingPlan in both views)\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    # dates for table\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
    "\n",
    "    # ---- Plant Inventory Treemap (with OOS details)\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].replace(\n",
    "            0, 0.001\n",
    "        )\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"])\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "            .reset_index()\n",
    "        )\n",
    "\n",
    "        # join OOS_Cases per SKU/Plant\n",
    "        if not oos_calc.empty:\n",
    "            oos_join = oos_calc[[\"SKU\", \"Plant\", \"OOS_Cases\"]].copy()\n",
    "        else:\n",
    "            oos_join = pd.DataFrame(columns=[\"SKU\", \"Plant\", \"OOS_Cases\"])\n",
    "        dff_agg = dff_agg.merge(oos_join, on=[\"SKU\", \"Plant\"], how=\"left\")\n",
    "\n",
    "        dff_agg[\"OOS_Cases\"] = dff_agg[\"OOS_Cases\"].fillna(0).astype(int)\n",
    "        dff_agg[\"IsOOSFlag\"] = np.where(dff_agg[\"OOS_Cases\"] > 0, \"YES\", \"NO\")\n",
    "        dff_agg[\"BalanceSupply\"] = dff_agg[\"BalanceSupply\"].fillna(0)\n",
    "\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"BalanceSupply\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            hover_data={\n",
    "                \"SKU\": True,\n",
    "                \"BalanceSupply\": True,\n",
    "                \"OOS_Cases\": True,\n",
    "                \"IsOOSFlag\": True,\n",
    "            },\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            hovertemplate=\"<b>%{label}</b><br>\"\n",
    "            \"SKU: %{customdata[0]}<br>\"\n",
    "            \"Balance Supply: %{customdata[1]:,.0f}<br>\"\n",
    "            \"OOS Cases: %{customdata[2]:,.0f}<br>\"\n",
    "            \"OOS: %{customdata[3]}<extra></extra>\"\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory (size = PlantInv%, color = Balance Supply)\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"Balance Supply\"},\n",
    "            template=\"plotly_white\",\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "        fig_inv.update_layout(template=\"plotly_white\")\n",
    "\n",
    "    # ---- OOS & Risk Bar\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title_bar = \"OOS & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title_bar = \"OOS & Risk SKUs by Brand\"\n",
    "\n",
    "        summary_df = (\n",
    "            dff_filtered.groupby(group_col)\n",
    "            .agg(OOS_Count=(\"IsOOS\", \"sum\"), Risk_Count=(\"IsRisk\", \"sum\"))\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Count\", \"Risk_Count\"])\n",
    "        group_col, title_bar = \"Group\", \"OOS & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Count\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Count\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_Count\"],\n",
    "            textposition=\"outside\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title_bar,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "        template=\"plotly_white\",\n",
    "    )\n",
    "\n",
    "    # ---- Branch OOS Treemap\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    treemap_df[\"BalanceSupply\"] = treemap_df[\"BalanceSupply\"].fillna(0)\n",
    "\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}\"\n",
    "            \"<br><b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            template=\"plotly_white\",\n",
    "        )\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "        fig_treemap.update_layout(template=\"plotly_white\")\n",
    "\n",
    "    # ---- Stock Criticality Table (Option A: only branches present in filtered data)\n",
    "    crit_columns = []\n",
    "    crit_data = []\n",
    "    style_data_conditional = []\n",
    "\n",
    "    try:\n",
    "        if not dff_filtered.empty and not df_crit.empty:\n",
    "            crit_filtered = df_crit.copy()\n",
    "            base_cols = [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "\n",
    "            # branch columns = intersection of crit sheet columns and filtered branches\n",
    "            branch_set = set(dff_filtered[\"Branch\"].unique())\n",
    "            branch_cols = [\n",
    "                c for c in crit_filtered.columns if c not in base_cols and c in branch_set\n",
    "            ]\n",
    "\n",
    "            if branch_cols:\n",
    "                # convert only these branch columns to numeric, round to whole numbers\n",
    "                for col in branch_cols:\n",
    "                    crit_filtered[col] = (\n",
    "                        pd.to_numeric(crit_filtered[col], errors=\"coerce\")\n",
    "                        .round(0)\n",
    "                        .astype(\"Int64\")\n",
    "                    )\n",
    "\n",
    "                final_cols = base_cols + branch_cols\n",
    "                crit_filtered = crit_filtered[final_cols]\n",
    "\n",
    "                # replace NaN with None (shows as blank in Dash)\n",
    "                crit_filtered = crit_filtered.replace({np.nan: None})\n",
    "\n",
    "                crit_columns = [{\"name\": c, \"id\": c} for c in final_cols]\n",
    "                crit_data = crit_filtered.to_dict(\"records\")\n",
    "\n",
    "                # Conditional formatting for numeric branch columns\n",
    "                bands = [\n",
    "                    (0, 0, \"#7f0000\", \"white\"),\n",
    "                    (1, 2, \"#b30000\", \"white\"),\n",
    "                    (3, 4, \"#e31a1c\", \"white\"),\n",
    "                    (5, 6, \"#fb9a99\", \"black\"),\n",
    "                    (7, 8, \"#d9f0a3\", \"black\"),\n",
    "                    (9, 10, \"#78c679\", \"black\"),\n",
    "                    (11, 9999, \"#238443\", \"white\"),\n",
    "                ]\n",
    "                for col in branch_cols:\n",
    "                    for low, high, bg, font in bands:\n",
    "                        style_data_conditional.append(\n",
    "                            {\n",
    "                                \"if\": {\n",
    "                                    \"column_id\": col,\n",
    "                                    \"filter_query\": f\"{{{col}}} >= {low} && {{{col}}} <= {high}\",\n",
    "                                },\n",
    "                                \"backgroundColor\": bg,\n",
    "                                \"color\": font,\n",
    "                            }\n",
    "                        )\n",
    "                    # blanks (None) – grey\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\n",
    "                                \"column_id\": col,\n",
    "                                \"filter_query\": f\"{{{col}}} is blank\",\n",
    "                            },\n",
    "                            \"backgroundColor\": \"#e0e0e0\",\n",
    "                            \"color\": \"#6c757d\",\n",
    "                        }\n",
    "                    )\n",
    "    except Exception as e:\n",
    "        print(\"CRIT TABLE ERROR:\", e)\n",
    "        crit_columns = []\n",
    "        crit_data = []\n",
    "        style_data_conditional = []\n",
    "\n",
    "    # ---- Inter-rotation Map\n",
    "    df_inter = explode_interrotation(dff_filtered)\n",
    "    if not df_inter.empty:\n",
    "        df_map = df_inter.merge(\n",
    "            df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\"\n",
    "        ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "        if not df_map.empty:\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']}) – {x['Brand']}\", axis=1\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"Label\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=30,\n",
    "            )\n",
    "            fig_inter.update_layout(template=\"plotly_white\")\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "            fig_inter.update_layout(template=\"plotly_white\")\n",
    "    else:\n",
    "        fig_inter = go.Figure()\n",
    "        fig_inter.update_layout(template=\"plotly_white\")\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CRITICALITY EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"crit-download\", \"data\"),\n",
    "    Input(\"crit-export-btn\", \"n_clicks\"),\n",
    "    State(\"crit-table\", \"data\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_criticality(n_clicks, rows):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Criticality\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Stock_Criticality.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# INFORMATION EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"info-download\", \"data\"),\n",
    "    Input(\"info-export-btn\", \"n_clicks\"),\n",
    "    State(\"info-table\", \"data\"),\n",
    "    State(\"info-table\", \"columns\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_information(n_clicks, rows, columns):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "    if columns:\n",
    "        col_ids = [c[\"id\"] for c in columns]\n",
    "        df = df[col_ids]\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Information\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Information.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LABEL COUNTS\n",
    "# =========================================================\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"risk-count-label\", \"children\"), Input(\"risk-filter\", \"value\"))\n",
    "def _risk_count(v):\n",
    "    return _count_label(v, \"Risk\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN APP\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "f8d3a43d-b532-4b90-a952-b0453b5e6d74",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x2a4aea8c1f0>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\thahasin.javath\\AppData\\Local\\Temp\\ipykernel_6396\\1170913375.py:1333: FutureWarning:\n",
      "\n",
      "Passing a dictionary to SeriesGroupBy.agg is deprecated and will raise in a future version of pandas. Pass a list of aggregations instead.\n",
      "\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "import io\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "from dash.dcc import send_bytes\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    \"\"\"\n",
    "    Take Inter_Rotation_Branches like:\n",
    "      'JEDDAH (1,000 CS), DAMMAM (500 CS)'\n",
    "    and create rows with FromBranch -> ToBranch and Cases.\n",
    "    \"\"\"\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                to_branch = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"FromBranch\": row[\"Branch\"],\n",
    "                        \"ToBranch\": to_branch,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "def normalize_branch(x):\n",
    "    return str(x).strip().replace(\"–\", \"-\").upper()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(columns={c: col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    # Keep PlantInvPerc as number (e.g. 95.3); only used for sizing in treemap.\n",
    "    df[\"PlantInvPerc\"] = pd.to_numeric(\n",
    "        df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    return pd.read_excel(path, sheet_name=sheet)\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# Normalise names for joins and filters\n",
    "df_full[\"Branch\"] = df_full[\"Branch\"].apply(normalize_branch)\n",
    "df_full[\"BusinessUnit\"] = df_full[\"BusinessUnit\"].str.upper()\n",
    "df_full[\"Brand\"] = df_full[\"Brand\"].str.upper()\n",
    "\n",
    "df_crit.rename(columns=lambda x: normalize_branch(x), inplace=True)\n",
    "df_crit[\"AI_SKU\"] = df_crit[\"AI_SKU\"].astype(str)\n",
    "df_crit[\"AI_MFGBRND\"] = df_crit[\"AI_MFGBRND\"].astype(str).str.upper()\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "RISK_FILTER = [\"Yes\", \"No\"]  # Yes/No based on IsRisk\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown hide-chips\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\", trend=None):\n",
    "    icon = \"\"\n",
    "    if trend == \"up\":\n",
    "        icon = \"▲ \"\n",
    "    elif trend == \"down\":\n",
    "        icon = \"▼ \"\n",
    "    elif trend == \"flat\":\n",
    "        icon = \"■ \"\n",
    "    label = icon + title if icon else title\n",
    "\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(label, className=\"text-muted\", style={\"fontSize\": \"0.9rem\"}),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "def _count_label(values, base):\n",
    "    if values and len(values) == 1:\n",
    "        return f\"{base} (1 selected)\"\n",
    "    elif values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "def apply_light_theme(fig, title=None):\n",
    "    if title:\n",
    "        fig.update_layout(title=title)\n",
    "    fig.update_layout(\n",
    "        template=\"plotly\",\n",
    "        paper_bgcolor=\"#ffffff\",\n",
    "        plot_bgcolor=\"#ffffff\",\n",
    "        font_color=\"#212529\",\n",
    "    )\n",
    "    return fig\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: \"Segoe UI\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "        }\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        /* Dropdown styles */\n",
    "        .fixed-multi-dropdown { font-size: 11px; }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow: hidden;\n",
    "            position: relative;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #0d6efd;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control .Select-clear-zone {\n",
    "            position: absolute;\n",
    "            right: 22px;\n",
    "            top: 0;\n",
    "            bottom: 0;\n",
    "            display: flex;\n",
    "            align-items: center;\n",
    "        }\n",
    "        .fixed-multi-dropdown.hide-chips .Select-value {\n",
    "            display: none !important;\n",
    "        }\n",
    "        .fixed-multi-dropdown.show-chips .Select-value {\n",
    "            display: inline-flex !important;\n",
    "        }\n",
    "\n",
    "        .global-search { font-size: 11px; height: 32px; }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container th,\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "        }\n",
    "        .dash-table-container .dash-spreadsheet-container td:hover {\n",
    "            background-color: #eef4ff !important;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # Header row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\"Inventory & Supply Dashboard\", className=\"mt-2 mb-0\"),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\", className=\"text-muted small\"\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\"label\": \" Executive\", \"value\": \"executive\"},\n",
    "                                        {\"label\": \" Analyst\", \"value\": \"analyst\"},\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    html.Img(\n",
    "                                        src=\"/assets/aujan_logo.png\",\n",
    "                                        style={\n",
    "                                            \"height\": \"90px\",\n",
    "                                            \"width\": \"220px\",\n",
    "                                            \"objectFit\": \"contain\",\n",
    "                                        },\n",
    "                                    ),\n",
    "                                    className=\"d-flex justify-content-end\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # Auto-refresh interval (2 minutes)\n",
    "        dcc.Interval(id=\"refresh-interval\", interval=120000, n_intervals=0),\n",
    "\n",
    "        # Filters row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "\n",
    "        # Filter panel\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"risk-filter\",\n",
    "                                        \"risk-count-label\",\n",
    "                                        RISK_FILTER,\n",
    "                                        \"Risk\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI row\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # Tabs\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Information.xlsx\",\n",
    "                                                id=\"info-export-btn\",\n",
    "                                                color=\"primary\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"info-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#fafafa\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#e2e6ea\",\n",
    "                                            \"border\": \"1px solid #adb5bd\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                ),\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Criticality.xlsx\",\n",
    "                                                id=\"crit-export-btn\",\n",
    "                                                color=\"success\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"crit-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px\",\n",
    "                                        \"WhiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#f1f3f4\",\n",
    "                                        \"fontWeight\": \"bold\",\n",
    "                                        \"border\": \"1px solid #dee2e6\",\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                ),\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# HELPER: APPLY FILTERS\n",
    "# =========================================================\n",
    "def apply_filters(\n",
    "    base_df,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    ignore=None,\n",
    "):\n",
    "    ignore = ignore or set()\n",
    "    df = base_df.copy()\n",
    "\n",
    "    if \"brand\" not in ignore and brands:\n",
    "        df = df[df[\"Brand\"].isin(brands)]\n",
    "    if \"plant\" not in ignore and plants:\n",
    "        df = df[df[\"Plant\"].isin(plants)]\n",
    "    if \"branch\" not in ignore and branches:\n",
    "        df = df[df[\"Branch\"].isin(branches)]\n",
    "    if \"class\" not in ignore and classes:\n",
    "        df = df[df[\"Class\"].isin(classes)]\n",
    "    if \"bu\" not in ignore and busunits:\n",
    "        df = df[df[\"BusinessUnit\"].isin(busunits)]\n",
    "    if \"sku\" not in ignore and ai_skus:\n",
    "        df = df[df[\"SKU\"].isin(ai_skus)]\n",
    "    if \"oversell\" not in ignore and oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        df = df[df[\"IsOversell\"].isin(flags)]\n",
    "    if \"risk\" not in ignore and risk:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        if \"Yes\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 1\n",
    "        if \"No\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 0\n",
    "        df = df[mask]\n",
    "\n",
    "    # branch DC band filtering\n",
    "    if \"dc\" not in ignore and branch_dc:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= df[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(7, 10)\n",
    "        df = df[mask]\n",
    "\n",
    "    # global search\n",
    "    if \"global\" not in ignore and global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for col in search_cols:\n",
    "            mask |= df[col].astype(str).str.lower().str.contains(gs)\n",
    "        df = df[mask]\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: SHOW/HIDE FILTERS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: CASCADING FILTER OPTIONS (BU → Branch restricted)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"options\"),\n",
    "    Output(\"plant-filter\", \"options\"),\n",
    "    Output(\"branch-filter\", \"options\"),\n",
    "    Output(\"class-filter\", \"options\"),\n",
    "    Output(\"busunit-filter\", \"options\"),\n",
    "    Output(\"ai-sku-filter\", \"options\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_filter_options(\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "):\n",
    "    # Brand options\n",
    "    df_brand = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"brand\"},\n",
    "    )\n",
    "    brand_opts = [{\"label\": b, \"value\": b} for b in sorted(df_brand[\"Brand\"].unique())]\n",
    "\n",
    "    # Plant options\n",
    "    df_plant = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"plant\"},\n",
    "    )\n",
    "    plant_opts = [{\"label\": p, \"value\": p} for p in sorted(df_plant[\"Plant\"].unique())]\n",
    "\n",
    "    # Branch options\n",
    "    df_branch = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"branch\"},\n",
    "    )\n",
    "    branch_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_branch[\"Branch\"].unique())\n",
    "    ]\n",
    "\n",
    "    # Class options\n",
    "    df_class = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"class\"},\n",
    "    )\n",
    "    class_opts = [{\"label\": c, \"value\": c} for c in sorted(df_class[\"Class\"].unique())]\n",
    "\n",
    "    # BU options\n",
    "    df_bu = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"bu\"},\n",
    "    )\n",
    "    bu_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_bu[\"BusinessUnit\"].unique())\n",
    "    ]\n",
    "\n",
    "    # SKU options\n",
    "    df_sku = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"sku\"},\n",
    "    )\n",
    "    sku_opts = [{\"label\": s, \"value\": s} for s in sorted(df_sku[\"SKU\"].unique())]\n",
    "\n",
    "    return brand_opts, plant_opts, branch_opts, class_opts, bu_opts, sku_opts\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: DROPDOWN CLASS (chip display logic)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"className\"),\n",
    "    Output(\"plant-filter\", \"className\"),\n",
    "    Output(\"branch-filter\", \"className\"),\n",
    "    Output(\"class-filter\", \"className\"),\n",
    "    Output(\"busunit-filter\", \"className\"),\n",
    "    Output(\"ai-sku-filter\", \"className\"),\n",
    "    Output(\"branch-dc-filter\", \"className\"),\n",
    "    Output(\"oversell-filter\", \"className\"),\n",
    "    Output(\"risk-filter\", \"className\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    ")\n",
    "def update_dropdown_classes(\n",
    "    brand_v,\n",
    "    plant_v,\n",
    "    branch_v,\n",
    "    class_v,\n",
    "    bu_v,\n",
    "    sku_v,\n",
    "    dc_v,\n",
    "    oversell_v,\n",
    "    risk_v,\n",
    "):\n",
    "    def cls(v):\n",
    "        if v and len(v) == 1:\n",
    "            return \"fixed-multi-dropdown show-chips\"\n",
    "        return \"fixed-multi-dropdown hide-chips\"\n",
    "\n",
    "    return (\n",
    "        cls(brand_v),\n",
    "        cls(plant_v),\n",
    "        cls(branch_v),\n",
    "        cls(class_v),\n",
    "        cls(bu_v),\n",
    "        cls(sku_v),\n",
    "        cls(dc_v),\n",
    "        cls(oversell_v),\n",
    "        cls(risk_v),\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# MAIN DASHBOARD CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    "    Input(\"refresh-interval\", \"n_intervals\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    n_intervals,\n",
    "):\n",
    "    # ---- Filter summary\n",
    "    dff = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "    )\n",
    "    dff_filtered = dff.copy()\n",
    "\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    # ---- OOS logic (cases)\n",
    "    dff_oos = dff_filtered[dff_filtered[\"BalanceSupply\"] > 0].copy()\n",
    "    total_oos_cases = 0\n",
    "    oos_calc = None\n",
    "\n",
    "    if not dff_oos.empty:\n",
    "        balance_supply_per_sku_plant = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\"BalanceSupply\"].sum()\n",
    "        )\n",
    "        plant_max_inv = (\n",
    "            dff_oos.groupby([\"SKU\", \"Plant\"], as_index=False)[\n",
    "                \"Total_SKU_Plant_Inventory\"\n",
    "            ].max()\n",
    "        )\n",
    "        oos_calc = balance_supply_per_sku_plant.merge(\n",
    "            plant_max_inv, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_calc[\"OOS_Cases\"] = (\n",
    "            oos_calc[\"BalanceSupply\"] - oos_calc[\"Total_SKU_Plant_Inventory\"]\n",
    "        ).clip(lower=0)\n",
    "        total_oos_cases = int(oos_calc[\"OOS_Cases\"].sum())\n",
    "\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    # KPI trend directions (simple: up if >0, else flat)\n",
    "    oos_trend = \"up\" if total_oos_cases > 0 else \"flat\"\n",
    "    risk_trend = \"up\" if risk_count > 0 else \"flat\"\n",
    "    bo_trend = \"up\" if bo_count > 0 else \"flat\"\n",
    "    oversell_trend = \"up\" if oversell_count > 0 else \"flat\"\n",
    "    bal_trend = \"up\" if bal_supply_sum > 0 else \"flat\"\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\n",
    "                \"Supply Risk SKUs\", risk_count, color=\"warning\", trend=risk_trend\n",
    "            ),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\", trend=bo_trend),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count, trend=risk_trend),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count, trend=bo_trend),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover, trend=\"flat\"),\n",
    "            kpi_card(\n",
    "                \"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend\n",
    "            ),\n",
    "        ]\n",
    "\n",
    "    # ---- Info table columns (PlantInv% removed)\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    # dates for table\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
    "\n",
    "    # ---- Plant Inventory Treemap (size = PlantInv%, color = Balance Supply, hover shows OOS cases)\n",
    "    if not dff_filtered.empty:\n",
    "        dff_filtered[\"PlantInvPerc_safe\"] = dff_filtered[\"PlantInvPerc\"].fillna(0)\n",
    "        dff_agg = (\n",
    "            dff_filtered.groupby([\"Plant\", \"Brand\", \"SKU\"], as_index=False)\n",
    "            .agg(\n",
    "                PlantInvPerc_safe=(\"PlantInvPerc_safe\", \"sum\"),\n",
    "                BalanceSupply=(\"BalanceSupply\", \"sum\"),\n",
    "            )\n",
    "        )\n",
    "# 🔥 FIX — Avoid zero weights\n",
    "        dff_agg[\"PlantInvPerc_safe\"] = dff_agg[\"PlantInvPerc_safe\"].fillna(0)\n",
    "        dff_agg[\"PlantInvPerc_safe\"] = dff_agg[\"PlantInvPerc_safe\"].astype(float)\n",
    "\n",
    "# When value = 0, give tiny non-zero weight\n",
    "        dff_agg.loc[dff_agg[\"PlantInvPerc_safe\"] <= 0, \"PlantInvPerc_safe\"] = 0.0001\n",
    "\n",
    "# When BalanceSupply null\n",
    "        dff_agg[\"BalanceSupply\"] = dff_agg[\"BalanceSupply\"].fillna(0)\n",
    "        # attach OOS cases per SKU-Plant to SKU level (merge on SKU + Plant)\n",
    "        dff_agg[\"OOS_Cases\"] = 0\n",
    "        if oos_calc is not None:\n",
    "            oos_simple = oos_calc[[\"SKU\", \"Plant\", \"OOS_Cases\"]].copy()\n",
    "            oos_simple[\"OOS_Cases\"] = oos_simple[\"OOS_Cases\"].fillna(0)\n",
    "            dff_agg = dff_agg.merge(\n",
    "                oos_simple, on=[\"SKU\", \"Plant\"], how=\"left\", suffixes=(\"\", \"_oos\")\n",
    "            )\n",
    "            dff_agg[\"OOS_Cases\"] = (\n",
    "                dff_agg[\"OOS_Cases_oos\"].fillna(0).astype(int)\n",
    "            )\n",
    "            dff_agg.drop(columns=[\"OOS_Cases_oos\"], inplace=True)\n",
    "\n",
    "        dff_agg[\"BalanceSupply\"] = dff_agg[\"BalanceSupply\"].fillna(0)\n",
    "        dff_agg[\"OOS_Cases\"] = dff_agg[\"OOS_Cases\"].fillna(0).astype(int)\n",
    "\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Plant\", \"Brand\", \"SKU\"],\n",
    "            values=\"PlantInvPerc_safe\",\n",
    "            color=\"BalanceSupply\",\n",
    "            color_continuous_scale=\"RdYlGn\",\n",
    "            custom_data=[\"BalanceSupply\", \"OOS_Cases\"],\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"%{label}\",\n",
    "            hovertemplate=\"<b>%{label}</b><br>\"\n",
    "            \"Balance Supply: %{customdata[0]:,.0f}<br>\"\n",
    "            \"OOS Cases: %{customdata[1]:,.0f}<extra></extra>\",\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"Balance Supply\"},\n",
    "        )\n",
    "        fig_inv = apply_light_theme(\n",
    "            fig_inv, \"Plant Inventory (size = PlantInv%, color = Balance Supply)\"\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = apply_light_theme(go.Figure(), \"Plant Inventory\")\n",
    "\n",
    "    # ---- OOS Cases & Risk SKUs Bar\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title_bar = \"OOS Cases & Risk SKUs by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title_bar = \"OOS Cases & Risk SKUs by Brand\"\n",
    "\n",
    "        # Risk SKUs by group\n",
    "        risk_by_group = (\n",
    "            dff_filtered.groupby(group_col)[\"IsRisk\"].sum().reset_index(name=\"Risk_SKUs\")\n",
    "        )\n",
    "\n",
    "        # OOS cases by group (using oos_calc merged with group)\n",
    "        if oos_calc is not None and not oos_calc.empty:\n",
    "            meta = (\n",
    "                dff_filtered.groupby([\"SKU\", \"Plant\"], as_index=False)[group_col]\n",
    "                .agg({group_col: \"first\"})\n",
    "            )\n",
    "            oos_pos = oos_calc[oos_calc[\"OOS_Cases\"] > 0].merge(\n",
    "                meta, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "            )\n",
    "            oos_by_group = (\n",
    "                oos_pos.groupby(group_col)[\"OOS_Cases\"]\n",
    "                .sum()\n",
    "                .reset_index(name=\"OOS_Cases\")\n",
    "            )\n",
    "        else:\n",
    "            oos_by_group = pd.DataFrame(columns=[group_col, \"OOS_Cases\"])\n",
    "\n",
    "        summary_df = pd.merge(\n",
    "            oos_by_group, risk_by_group, on=group_col, how=\"outer\"\n",
    "        ).fillna(0)\n",
    "        summary_df[\"OOS_Cases\"] = summary_df[\"OOS_Cases\"].astype(int)\n",
    "        summary_df[\"Risk_SKUs\"] = summary_df[\"Risk_SKUs\"].astype(int)\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(columns=[\"Group\", \"OOS_Cases\", \"Risk_SKUs\"])\n",
    "        group_col = \"Group\"\n",
    "        title_bar = \"OOS Cases & Risk SKUs\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS Cases\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Cases\"],\n",
    "            marker_color=\"#dc3545\",\n",
    "            text=summary_df[\"OOS_Cases\"],\n",
    "            textposition=\"outside\",\n",
    "            hovertemplate=\"<b>%{x}</b><br>OOS Cases: %{y:,}<extra></extra>\",\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk SKUs\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_SKUs\"],\n",
    "            marker_color=\"#fd7e14\",\n",
    "            text=summary_df[\"Risk_SKUs\"],\n",
    "            textposition=\"outside\",\n",
    "            hovertemplate=\"<b>%{x}</b><br>Risk SKUs: %{y:,}<extra></extra>\",\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-45,\n",
    "        legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"right\", x=1),\n",
    "    )\n",
    "    fig_bar = apply_light_theme(fig_bar, title_bar)\n",
    "\n",
    "    # ---- Branch OOS Treemap (Balance Supply by Branch/Brand/SKU)\n",
    "    treemap_df = (\n",
    "        dff.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Brand\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=\"<b>SKU:</b> %{customdata[0]}<br>\"\n",
    "            \"<b>Balance Supply:</b> %{customdata[1]:,}<extra></extra>\"\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "        fig_treemap = apply_light_theme(fig_treemap, \"Branch OOS Balance Supply\")\n",
    "    else:\n",
    "        fig_treemap = apply_light_theme(go.Figure(), \"Branch OOS Treemap\")\n",
    "\n",
    "    # ---- Stock Criticality Table (Option A: only branches present in filtered data, rounded whole numbers)\n",
    "    crit_columns = []\n",
    "    crit_data = []\n",
    "    style_data_conditional = []\n",
    "\n",
    "    try:\n",
    "        if not dff_filtered.empty and not df_crit.empty:\n",
    "            crit_filtered = df_crit.copy()\n",
    "            base_cols = [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "\n",
    "            branch_set = set(dff_filtered[\"Branch\"].unique())\n",
    "            branch_cols = [\n",
    "                c for c in crit_filtered.columns if c not in base_cols and c in branch_set\n",
    "            ]\n",
    "\n",
    "            if branch_cols:\n",
    "                for col in branch_cols:\n",
    "                    crit_filtered[col] = (\n",
    "                        pd.to_numeric(crit_filtered[col], errors=\"coerce\")\n",
    "                        .round(0)\n",
    "                        .astype(\"Int64\")\n",
    "                    )\n",
    "\n",
    "                final_cols = base_cols + branch_cols\n",
    "                crit_filtered = crit_filtered[final_cols]\n",
    "\n",
    "                crit_filtered = crit_filtered.replace({np.nan: None})\n",
    "\n",
    "                crit_columns = [{\"name\": c, \"id\": c} for c in final_cols]\n",
    "                crit_data = crit_filtered.to_dict(\"records\")\n",
    "\n",
    "                # Conditional formatting for numeric branch columns\n",
    "                bands = [\n",
    "                    (0, 0, \"#7f0000\", \"white\"),\n",
    "                    (1, 2, \"#b30000\", \"white\"),\n",
    "                    (3, 4, \"#e31a1c\", \"white\"),\n",
    "                    (5, 6, \"#fb9a99\", \"black\"),\n",
    "                    (7, 8, \"#d9f0a3\", \"black\"),\n",
    "                    (9, 10, \"#78c679\", \"black\"),\n",
    "                    (11, 9999, \"#238443\", \"white\"),\n",
    "                ]\n",
    "                for col in branch_cols:\n",
    "                    for low, high, bg, font in bands:\n",
    "                        style_data_conditional.append(\n",
    "                            {\n",
    "                                \"if\": {\n",
    "                                    \"column_id\": col,\n",
    "                                    \"filter_query\": f\"{{{col}}} >= {low} && {{{col}}} <= {high}\",\n",
    "                                },\n",
    "                                \"backgroundColor\": bg,\n",
    "                                \"color\": font,\n",
    "                            }\n",
    "                        )\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\n",
    "                                \"column_id\": col,\n",
    "                                \"filter_query\": f\"{{{col}}} is blank\",\n",
    "                            },\n",
    "                            \"backgroundColor\": \"#e0e0e0\",\n",
    "                            \"color\": \"#6c757d\",\n",
    "                        }\n",
    "                    )\n",
    "    except Exception as e:\n",
    "        print(\"CRIT TABLE ERROR:\", e)\n",
    "        crit_columns = []\n",
    "        crit_data = []\n",
    "        style_data_conditional = []\n",
    "\n",
    "    # ---- Inter-rotation Map\n",
    "    df_inter = explode_interrotation(dff_filtered)\n",
    "    if not df_inter.empty:\n",
    "        # Merge coordinates for From and To branches\n",
    "        coord_from = df_coord[[\"AI_BRANCH\", \"Latitude\", \"Longitude\"]].rename(\n",
    "            columns={\"AI_BRANCH\": \"FromBranch\", \"Latitude\": \"FromLat\", \"Longitude\": \"FromLon\"}\n",
    "        )\n",
    "        coord_to = df_coord[[\"AI_BRANCH\", \"Latitude\", \"Longitude\"]].rename(\n",
    "            columns={\"AI_BRANCH\": \"ToBranch\", \"Latitude\": \"ToLat\", \"Longitude\": \"ToLon\"}\n",
    "        )\n",
    "\n",
    "        df_edges = df_inter.merge(coord_from, on=\"FromBranch\", how=\"left\").merge(\n",
    "            coord_to, on=\"ToBranch\", how=\"left\"\n",
    "        )\n",
    "        df_edges = df_edges.dropna(subset=[\"FromLat\", \"FromLon\", \"ToLat\", \"ToLon\"])\n",
    "\n",
    "        # If exactly one SKU selected -> draw network lines (red) between branches\n",
    "        if ai_skus and len(ai_skus) == 1 and not df_edges.empty:\n",
    "            fig_inter = go.Figure()\n",
    "\n",
    "            # Lines\n",
    "            for _, row in df_edges.iterrows():\n",
    "                fig_inter.add_trace(\n",
    "                    go.Scattermapbox(\n",
    "                        lat=[row[\"FromLat\"], row[\"ToLat\"]],\n",
    "                        lon=[row[\"FromLon\"], row[\"ToLon\"]],\n",
    "                        mode=\"lines\",\n",
    "                        line=dict(color=\"red\", width=2),\n",
    "                        hoverinfo=\"text\",\n",
    "                        text=f\"{row['FromBranch']} → {row['ToBranch']}<br>Cases: {int(row['Cases']):,}\",\n",
    "                    )\n",
    "                )\n",
    "\n",
    "            # Nodes (branches)\n",
    "            nodes_from = df_edges[[\"FromBranch\", \"FromLat\", \"FromLon\"]].rename(\n",
    "                columns={\"FromBranch\": \"Branch\", \"FromLat\": \"Lat\", \"FromLon\": \"Lon\"}\n",
    "            )\n",
    "            nodes_to = df_edges[[\"ToBranch\", \"ToLat\", \"ToLon\"]].rename(\n",
    "                columns={\"ToBranch\": \"Branch\", \"ToLat\": \"Lat\", \"ToLon\": \"Lon\"}\n",
    "            )\n",
    "            nodes = pd.concat([nodes_from, nodes_to], ignore_index=True).drop_duplicates()\n",
    "\n",
    "            # total cases per branch\n",
    "            cases_from = df_edges.groupby(\"FromBranch\")[\"Cases\"].sum().reset_index()\n",
    "            cases_to = df_edges.groupby(\"ToBranch\")[\"Cases\"].sum().reset_index()\n",
    "            cases_from.rename(columns={\"FromBranch\": \"Branch\", \"Cases\": \"CasesFrom\"}, inplace=True)\n",
    "            cases_to.rename(columns={\"ToBranch\": \"Branch\", \"Cases\": \"CasesTo\"}, inplace=True)\n",
    "            cases = pd.merge(cases_from, cases_to, on=\"Branch\", how=\"outer\").fillna(0)\n",
    "            cases[\"TotalCases\"] = (cases[\"CasesFrom\"] + cases[\"CasesTo\"]).astype(int)\n",
    "\n",
    "            nodes = nodes.merge(cases[[\"Branch\", \"TotalCases\"]], on=\"Branch\", how=\"left\")\n",
    "            nodes[\"TotalCases\"] = nodes[\"TotalCases\"].fillna(0).astype(int)\n",
    "            nodes[\"Label\"] = nodes.apply(\n",
    "                lambda x: f\"{x['Branch']}<br>Total Cases: {x['TotalCases']:,}\", axis=1\n",
    "            )\n",
    "\n",
    "            fig_inter.add_trace(\n",
    "                go.Scattermapbox(\n",
    "                    lat=nodes[\"Lat\"],\n",
    "                    lon=nodes[\"Lon\"],\n",
    "                    mode=\"markers+text\",\n",
    "                    marker=dict(size=10, color=\"red\"),\n",
    "                    text=nodes[\"Branch\"],\n",
    "                    textposition=\"top center\",\n",
    "                    hoverinfo=\"text\",\n",
    "                    hovertext=nodes[\"Label\"],\n",
    "                )\n",
    "            )\n",
    "\n",
    "            fig_inter.update_layout(\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                mapbox_zoom=4,\n",
    "                margin=dict(t=40, l=10, r=10, b=10),\n",
    "            )\n",
    "            fig_inter = apply_light_theme(fig_inter, \"Inter-Rotation Network (Selected SKU)\")\n",
    "        else:\n",
    "            # Default bubble map (no specific SKU)\n",
    "            df_map = df_edges.copy()\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['ToBranch']} ({int(x['Cases']):,}) – {x['Brand']}\", axis=1\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"ToLat\",\n",
    "                lon=\"ToLon\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Cases\",\n",
    "                text=\"ToBranch\",\n",
    "                hover_name=\"ToBranch\",\n",
    "                hover_data={\"Cases\": True, \"ToLat\": False, \"ToLon\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                size_max=30,\n",
    "            )\n",
    "            fig_inter.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "            fig_inter = apply_light_theme(fig_inter, \"Inter-Rotation Map\")\n",
    "    else:\n",
    "        fig_inter = apply_light_theme(go.Figure(), \"Inter-Rotation Map\")\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CRITICALITY EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"crit-download\", \"data\"),\n",
    "    Input(\"crit-export-btn\", \"n_clicks\"),\n",
    "    State(\"crit-table\", \"data\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_criticality(n_clicks, rows):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Criticality\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Stock_Criticality.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# INFORMATION EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"info-download\", \"data\"),\n",
    "    Input(\"info-export-btn\", \"n_clicks\"),\n",
    "    State(\"info-table\", \"data\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_information(n_clicks, rows):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Information\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Information.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LABEL COUNTS\n",
    "# =========================================================\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"risk-count-label\", \"children\"), Input(\"risk-filter\", \"value\"))\n",
    "def _risk_count(v):\n",
    "    return _count_label(v, \"Risk\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN APP\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "bb6ca41c-6148-470a-816f-46b199c5ac6a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dashboard running at http://127.0.0.1:8051\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8051/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x1fbb578eca0>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "import re\n",
    "import io\n",
    "\n",
    "import dash\n",
    "import dash_bootstrap_components as dbc\n",
    "from dash import dcc, html, Input, Output, State, dash_table\n",
    "from dash.dcc import send_bytes\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from dash.dash_table import FormatTemplate\n",
    "from dash.dash_table.Format import Format, Group, Scheme\n",
    "\n",
    "# =========================================================\n",
    "# CONFIG\n",
    "# =========================================================\n",
    "FILE_PATH = r\"C:/Data/Branch_Inventory_Supply_Summary.xlsx\"\n",
    "SERVER_PORT = 8051\n",
    "\n",
    "SUMMARY_SHEET = \"Summary\"\n",
    "CRIT_SHEET = \"Stock Criticality_Days\"\n",
    "COORD_SHEET = \"Coordinates\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# UTIL FUNCTIONS\n",
    "# =========================================================\n",
    "def parse_depletion_date(x):\n",
    "    if pd.isna(x):\n",
    "        return pd.NaT\n",
    "    if isinstance(x, (pd.Timestamp, datetime)):\n",
    "        return pd.to_datetime(x)\n",
    "\n",
    "    s = str(x).strip()\n",
    "    fmts = [\n",
    "        \"%d-%b-%Y\",\n",
    "        \"%d-%b-%y\",\n",
    "        \"%d-%b\",\n",
    "        \"%Y-%m-%d\",\n",
    "        \"%d/%m/%Y\",\n",
    "        \"%d/%m/%y\",\n",
    "        \"%Y/%m/%d\",\n",
    "    ]\n",
    "    for f in fmts:\n",
    "        try:\n",
    "            dt = datetime.strptime(s, f)\n",
    "            if f == \"%d-%b\":\n",
    "                dt = dt.replace(year=datetime.today().year)\n",
    "            return pd.to_datetime(dt)\n",
    "        except Exception:\n",
    "            continue\n",
    "\n",
    "    try:\n",
    "        return pd.to_datetime(s, dayfirst=True, errors=\"coerce\")\n",
    "    except Exception:\n",
    "        return pd.NaT\n",
    "\n",
    "\n",
    "def explode_interrotation(df):\n",
    "    records = []\n",
    "    for _, row in df.iterrows():\n",
    "        inter = str(row.get(\"InterRotation\", \"\")).strip()\n",
    "        if not inter:\n",
    "            continue\n",
    "        branches = [b.strip() for b in inter.split(\",\")]\n",
    "        for b in branches:\n",
    "            m = re.match(r\"(.+?)\\s*\\(([\\d,]+)\\s*CS\\)\", b)\n",
    "            if m:\n",
    "                branch_name = m.group(1).strip()\n",
    "                cases = int(m.group(2).replace(\",\", \"\"))\n",
    "                records.append(\n",
    "                    {\n",
    "                        \"SKU\": row[\"SKU\"],\n",
    "                        \"Brand\": row[\"Brand\"],\n",
    "                        \"Branch\": branch_name,\n",
    "                        \"Cases\": cases,\n",
    "                    }\n",
    "                )\n",
    "    return pd.DataFrame(records)\n",
    "\n",
    "\n",
    "def normalize_branch(x):\n",
    "    return str(x).strip().replace(\"–\", \"-\").upper()\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LOAD DATA\n",
    "# =========================================================\n",
    "def load_summary(path=FILE_PATH, sheet=SUMMARY_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet, dtype=str)\n",
    "    df = df.fillna(\"\")\n",
    "\n",
    "    col_map = {\n",
    "        \"Plant\": \"Plant\",\n",
    "        \"AI_SKU\": \"SKU\",\n",
    "        \"AI_MFGBRND\": \"Brand\",\n",
    "        \"AI_BUSINESSUNIT\": \"BusinessUnit\",\n",
    "        \"AI_BRANCH\": \"Branch\",\n",
    "        \"Class\": \"Class\",\n",
    "        \"<10_Days\": \"DaysLess10\",\n",
    "        \"OOS\": \"OOS\",\n",
    "        \"PlantInv %\": \"PlantInvPerc\",\n",
    "        \"Upcoming_Plan\": \"UpcomingPlan\",\n",
    "        \"Depletion_Date\": \"DepletionDate\",\n",
    "        \"Risk\": \"Risk\",\n",
    "        \"BackOrder?\": \"BackOrder\",\n",
    "        \"Oversell\": \"Oversell\",\n",
    "        \"MTD Sales\": \"MTD_Sales\",\n",
    "        \"Forecast\": \"Forecast\",\n",
    "        \"Avg_3MNTH_sales\": \"Avg_3MNTH_sales\",\n",
    "        \"Inter_Rotation_Branches\": \"InterRotation\",\n",
    "        \"Balance_Supply\": \"BalanceSupply\",\n",
    "        \"Total_SKU_Plant_Inventory\": \"Total_SKU_Plant_Inventory\",\n",
    "    }\n",
    "    df.rename(columns={c: col_map[c] for c in df.columns if c in col_map}, inplace=True)\n",
    "\n",
    "    # numeric conversions\n",
    "    df[\"PlantInvPerc\"] = (\n",
    "        pd.to_numeric(df.get(\"PlantInvPerc\", \"0\").str.replace(\"%\", \"\"), errors=\"coerce\")\n",
    "        / 100.0\n",
    "    )\n",
    "    df[\"MTD_Sales\"] = pd.to_numeric(df.get(\"MTD_Sales\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Forecast\"] = pd.to_numeric(df.get(\"Forecast\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Avg_3MNTH_sales\"] = pd.to_numeric(\n",
    "        df.get(\"Avg_3MNTH_sales\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "    df[\"BalanceSupply\"] = pd.to_numeric(df.get(\"BalanceSupply\", \"0\"), errors=\"coerce\")\n",
    "    df[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        df.get(\"Total_SKU_Plant_Inventory\", \"0\"), errors=\"coerce\"\n",
    "    )\n",
    "\n",
    "    # flags\n",
    "    df[\"IsOOS\"] = df[\"OOS\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"oos\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsRisk\"] = df[\"Risk\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"risk\", \"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsLowCover\"] = df[\"DaysLess10\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsBackorder\"] = df[\"BackOrder\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "    df[\"IsOversell\"] = df[\"Oversell\"].apply(\n",
    "        lambda x: 1 if str(x).lower() in [\"yes\", \"true\"] else 0\n",
    "    )\n",
    "\n",
    "    df[\"DepletionDate_parsed\"] = df[\"DepletionDate\"].apply(parse_depletion_date)\n",
    "    df[\"UpcomingPlan_parsed\"] = pd.to_datetime(df[\"UpcomingPlan\"], errors=\"coerce\")\n",
    "    df[\"DaysToDepletion\"] = (\n",
    "        df[\"DepletionDate_parsed\"] - pd.to_datetime(datetime.today().date())\n",
    "    ).dt.days\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def load_criticality(path=FILE_PATH, sheet=CRIT_SHEET):\n",
    "    return pd.read_excel(path, sheet_name=sheet)\n",
    "\n",
    "\n",
    "def load_coordinates(path=FILE_PATH, sheet=COORD_SHEET):\n",
    "    df = pd.read_excel(path, sheet_name=sheet)\n",
    "    return df.dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "\n",
    "df_full = load_summary()\n",
    "df_crit = load_criticality()\n",
    "df_coord = load_coordinates()\n",
    "\n",
    "# Normalise names for joins and filters\n",
    "df_full[\"Branch\"] = df_full[\"Branch\"].apply(normalize_branch)\n",
    "df_full[\"BusinessUnit\"] = df_full[\"BusinessUnit\"].str.upper()\n",
    "df_full[\"Brand\"] = df_full[\"Brand\"].str.upper()\n",
    "\n",
    "df_crit.rename(columns=lambda x: normalize_branch(x), inplace=True)\n",
    "df_crit[\"AI_SKU\"] = df_crit[\"AI_SKU\"].astype(str)\n",
    "df_crit[\"AI_MFGBRND\"] = df_crit[\"AI_MFGBRND\"].astype(str).str.upper()\n",
    "\n",
    "# =========================================================\n",
    "# FILTER OPTIONS\n",
    "# =========================================================\n",
    "BRANDS = sorted(df_full[\"Brand\"].unique())\n",
    "PLANTS = sorted(df_full[\"Plant\"].unique())\n",
    "BRANCHES = sorted(df_full[\"Branch\"].unique())\n",
    "CLASSES = sorted(df_full[\"Class\"].unique())\n",
    "BUS_UNITS = sorted(df_full[\"BusinessUnit\"].unique())\n",
    "AI_SKUS = sorted(df_full[\"SKU\"].unique())\n",
    "BRANCH_DC_FILTER = [\"0\", \"1-4\", \"5-6\", \"7-10\"]\n",
    "OVERSELL_FILTER = [\"Yes\", \"No\"]\n",
    "RISK_FILTER = [\"Yes\", \"No\"]  # Yes/No based on IsRisk\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# COMPONENT HELPERS\n",
    "# =========================================================\n",
    "def counting_dropdown(id_, count_id, options, label_text):\n",
    "    return html.Div(\n",
    "        [\n",
    "            html.Small(\n",
    "                f\"{label_text} (0 selected)\",\n",
    "                id=count_id,\n",
    "                className=\"text-muted d-block mb-1 filter-label\",\n",
    "            ),\n",
    "            dcc.Dropdown(\n",
    "                id=id_,\n",
    "                options=[{\"label\": o, \"value\": o} for o in options],\n",
    "                multi=True,\n",
    "                placeholder=f\"Select {label_text}\",\n",
    "                className=\"fixed-multi-dropdown hide-chips\",\n",
    "            ),\n",
    "        ],\n",
    "        className=\"mb-2\",\n",
    "    )\n",
    "\n",
    "\n",
    "def kpi_card(title, value, color=\"primary\", trend=None):\n",
    "    icon = \"\"\n",
    "    if trend == \"up\":\n",
    "        icon = \"▲ \"\n",
    "    elif trend == \"down\":\n",
    "        icon = \"▼ \"\n",
    "    elif trend == \"flat\":\n",
    "        icon = \"■ \"\n",
    "    label = icon + title if icon else title\n",
    "\n",
    "    return dbc.Col(\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                [\n",
    "                    html.Div(\n",
    "                        label,\n",
    "                        className=\"text-muted\",\n",
    "                        style={\"fontSize\": \"0.9rem\"},\n",
    "                    ),\n",
    "                    html.Div(\n",
    "                        value,\n",
    "                        className=\"fw-bold kpi-number\",\n",
    "                        style={\n",
    "                            \"fontSize\": \"1.4rem\",\n",
    "                            \"whiteSpace\": \"nowrap\",\n",
    "                            \"overflow\": \"hidden\",\n",
    "                            \"textOverflow\": \"ellipsis\",\n",
    "                        },\n",
    "                    ),\n",
    "                ]\n",
    "            ),\n",
    "            className=f\"kpi-card border-{color}\",\n",
    "        ),\n",
    "        xs=6,\n",
    "        sm=4,\n",
    "        md=3,\n",
    "        lg=2,\n",
    "    )\n",
    "\n",
    "\n",
    "def _count_label(values, base):\n",
    "    if values and len(values) == 1:\n",
    "        return f\"{base} (1 selected)\"\n",
    "    elif values:\n",
    "        return f\"{base} ({len(values)} selected)\"\n",
    "    return f\"{base} (0 selected)\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# APP + INLINE CSS\n",
    "# =========================================================\n",
    "app = dash.Dash(\n",
    "    __name__,\n",
    "    external_stylesheets=[dbc.themes.BOOTSTRAP],\n",
    "    suppress_callback_exceptions=True,\n",
    ")\n",
    "server = app.server\n",
    "\n",
    "app.index_string = \"\"\"\n",
    "<!DOCTYPE html>\n",
    "<html>\n",
    "    <head>\n",
    "        {%metas%}\n",
    "        <title>Inventory & Supply Dashboard</title>\n",
    "        {%favicon%}\n",
    "        {%css%}\n",
    "        <style>\n",
    "        body {\n",
    "            background-color: #f5f6f8;\n",
    "            font-family: -apple-system, BlinkMacSystemFont, \"SF Pro Text\",\n",
    "                         \"Segoe UI\", system-ui, sans-serif;\n",
    "        }\n",
    "        .filter-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .kpi-card {\n",
    "            height: 100%;\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;\n",
    "        }\n",
    "        .kpi-card:hover {\n",
    "            transform: translateY(-2px);\n",
    "            box-shadow: 0 0.35rem 0.8rem rgba(0,0,0,0.08);\n",
    "        }\n",
    "        .sticky-kpi-bar {\n",
    "            position: sticky;\n",
    "            top: 0;\n",
    "            z-index: 900;\n",
    "            background: linear-gradient(180deg, rgba(245,246,248,0.97), rgba(245,246,248,0.90));\n",
    "            padding-top: 0.25rem;\n",
    "            padding-bottom: 0.35rem;\n",
    "        }\n",
    "        .tab-card {\n",
    "            border-radius: 0.75rem;\n",
    "            box-shadow: 0 0.125rem 0.35rem rgba(0,0,0,0.06);\n",
    "        }\n",
    "        .view-toggle {\n",
    "            font-size: 0.75rem;\n",
    "        }\n",
    "\n",
    "        /* Dropdown styles */\n",
    "        .fixed-multi-dropdown { font-size: 11px; }\n",
    "        .fixed-multi-dropdown .Select-control {\n",
    "            min-height: 34px;\n",
    "            max-height: 38px;\n",
    "            overflow: hidden;\n",
    "            position: relative;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-menu-outer {\n",
    "            max-height: 260px;\n",
    "            z-index: 9999;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option {\n",
    "            padding: 4px 8px;\n",
    "            border-bottom: 1px solid #f1f3f4;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-focused {\n",
    "            background-color: #e9f5ff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-option.is-selected {\n",
    "            background-color: #1565C0;\n",
    "            color: #ffffff;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-arrow-zone {\n",
    "            padding-right: 8px;\n",
    "            display: flex;\n",
    "            justify-content: flex-end !important;\n",
    "            width: 22px;\n",
    "        }\n",
    "        .fixed-multi-dropdown .Select-control .Select-clear-zone {\n",
    "            position: absolute;\n",
    "            right: 22px;\n",
    "            top: 0;\n",
    "            bottom: 0;\n",
    "            display: flex;\n",
    "            align-items: center;\n",
    "        }\n",
    "        .fixed-multi-dropdown.hide-chips .Select-value {\n",
    "            display: none !important;\n",
    "        }\n",
    "        .fixed-multi-dropdown.show-chips .Select-value {\n",
    "            display: inline-flex !important;\n",
    "        }\n",
    "\n",
    "        .global-search { font-size: 11px; height: 32px; }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container table {\n",
    "            border-collapse: collapse !important;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container th {\n",
    "            font-weight: 600;\n",
    "            font-size: 11px;\n",
    "            background-color: #ECEFF1 !important;\n",
    "            border-bottom: 1px solid #CFD8DC !important;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container td {\n",
    "            padding: 4px 6px;\n",
    "            font-size: 11px;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container tr:nth-child(odd) td {\n",
    "            background-color: #FAFAFA;\n",
    "        }\n",
    "\n",
    "        .dash-table-container .dash-spreadsheet-container td:hover {\n",
    "            background-color: #E3F2FD !important;\n",
    "        }\n",
    "        </style>\n",
    "    </head>\n",
    "    <body>\n",
    "        {%app_entry%}\n",
    "        <footer>\n",
    "            {%config%}\n",
    "            {%scripts%}\n",
    "            {%renderer%}\n",
    "        </footer>\n",
    "    </body>\n",
    "</html>\n",
    "\"\"\"\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LAYOUT\n",
    "# =========================================================\n",
    "app.layout = dbc.Container(\n",
    "    [\n",
    "        # Header row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    html.Div(\n",
    "                        [\n",
    "                            html.H3(\n",
    "                                \"Inventory & Supply Dashboard\",\n",
    "                                className=\"mt-2 mb-0\",\n",
    "                            ),\n",
    "                            html.Div(\n",
    "                                \"Executive & Analyst Views\",\n",
    "                                className=\"text-muted small\",\n",
    "                            ),\n",
    "                        ]\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dbc.Row(\n",
    "                        [\n",
    "                            dbc.Col(\n",
    "                                dbc.RadioItems(\n",
    "                                    id=\"view-mode\",\n",
    "                                    options=[\n",
    "                                        {\"label\": \" Executive\", \"value\": \"executive\"},\n",
    "                                        {\"label\": \" Analyst\", \"value\": \"analyst\"},\n",
    "                                    ],\n",
    "                                    value=\"executive\",\n",
    "                                    inline=True,\n",
    "                                    className=\"view-toggle\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    id=\"last-refresh\",\n",
    "                                    className=\"text-end text-muted small mt-2\",\n",
    "                                ),\n",
    "                                width=True,\n",
    "                            ),\n",
    "                            dbc.Col(\n",
    "                                html.Div(\n",
    "                                    html.Img(\n",
    "                                        src=\"/assets/aujan_logo.png\",\n",
    "                                        style={\n",
    "                                            \"height\": \"90px\",\n",
    "                                            \"width\": \"220px\",\n",
    "                                            \"objectFit\": \"contain\",\n",
    "                                        },\n",
    "                                    ),\n",
    "                                    className=\"d-flex justify-content-end\",\n",
    "                                ),\n",
    "                                width=\"auto\",\n",
    "                            ),\n",
    "                        ],\n",
    "                        className=\"align-items-center justify-content-end\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-2\",\n",
    "        ),\n",
    "\n",
    "        # Auto-refresh interval (2 minutes)\n",
    "        dcc.Interval(id=\"refresh-interval\", interval=120000, n_intervals=0),\n",
    "\n",
    "        # Filters row\n",
    "        dbc.Row(\n",
    "            [\n",
    "                dbc.Col(\n",
    "                    dbc.Button(\n",
    "                        \"Hide / Show Filters\",\n",
    "                        id=\"filter-toggle\",\n",
    "                        outline=True,\n",
    "                        color=\"primary\",\n",
    "                        size=\"sm\",\n",
    "                        className=\"mb-1\",\n",
    "                    ),\n",
    "                    md=2,\n",
    "                ),\n",
    "                dbc.Col(\n",
    "                    dcc.Input(\n",
    "                        id=\"global-search\",\n",
    "                        placeholder=\"Global search: SKU / Brand / Plant / Branch / Class...\",\n",
    "                        type=\"text\",\n",
    "                        debounce=True,\n",
    "                        className=\"form-control form-control-sm global-search\",\n",
    "                    ),\n",
    "                    md=6,\n",
    "                ),\n",
    "            ],\n",
    "            className=\"mb-1\",\n",
    "        ),\n",
    "\n",
    "        # Filter panel\n",
    "        dbc.Collapse(\n",
    "            dbc.Card(\n",
    "                dbc.CardBody(\n",
    "                    [\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"brand-filter\",\n",
    "                                        \"brand-count-label\",\n",
    "                                        BRANDS,\n",
    "                                        \"Brand\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"plant-filter\",\n",
    "                                        \"plant-count-label\",\n",
    "                                        PLANTS,\n",
    "                                        \"Plant\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-filter\",\n",
    "                                        \"branch-count-label\",\n",
    "                                        BRANCHES,\n",
    "                                        \"Branch\",\n",
    "                                    ),\n",
    "                                    md=3,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"class-filter\",\n",
    "                                        \"class-count-label\",\n",
    "                                        CLASSES,\n",
    "                                        \"Class\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"busunit-filter\",\n",
    "                                        \"bu-count-label\",\n",
    "                                        BUS_UNITS,\n",
    "                                        \"BU\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2\",\n",
    "                        ),\n",
    "                        dbc.Row(\n",
    "                            [\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"ai-sku-filter\",\n",
    "                                        \"sku-count-label\",\n",
    "                                        AI_SKUS,\n",
    "                                        \"SKU\",\n",
    "                                    ),\n",
    "                                    md=4,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"branch-dc-filter\",\n",
    "                                        \"dc-count-label\",\n",
    "                                        BRANCH_DC_FILTER,\n",
    "                                        \"DC Days\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"oversell-filter\",\n",
    "                                        \"oversell-count-label\",\n",
    "                                        OVERSELL_FILTER,\n",
    "                                        \"Oversell\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                                dbc.Col(\n",
    "                                    counting_dropdown(\n",
    "                                        \"risk-filter\",\n",
    "                                        \"risk-count-label\",\n",
    "                                        RISK_FILTER,\n",
    "                                        \"Risk\",\n",
    "                                    ),\n",
    "                                    md=2,\n",
    "                                ),\n",
    "                            ],\n",
    "                            className=\"gy-2 mt-1\",\n",
    "                        ),\n",
    "                    ]\n",
    "                ),\n",
    "                className=\"mb-2 filter-card\",\n",
    "            ),\n",
    "            id=\"filter-collapse\",\n",
    "            is_open=True,\n",
    "        ),\n",
    "\n",
    "        # KPI row\n",
    "        html.Div(\n",
    "            dbc.Row(id=\"kpi-row\", className=\"g-2 mb-2\"),\n",
    "            className=\"sticky-kpi-bar\",\n",
    "        ),\n",
    "\n",
    "        # Tabs\n",
    "        dbc.Card(\n",
    "            dbc.CardBody(\n",
    "                dbc.Tabs(\n",
    "                    id=\"tabs\",\n",
    "                    active_tab=\"tab-overview\",\n",
    "                    children=[\n",
    "                        dbc.Tab(\n",
    "                            label=\"Overview\",\n",
    "                            tab_id=\"tab-overview\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"plant-inv-chart\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                        dbc.Col(\n",
    "                                            dcc.Graph(\n",
    "                                                id=\"oos-risk-bar\",\n",
    "                                                style={\"height\": \"640px\"},\n",
    "                                            ),\n",
    "                                            md=6,\n",
    "                                        ),\n",
    "                                    ]\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Branch OOS Treemap\",\n",
    "                            tab_id=\"tab-treemap\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"branch-oos-treemap\",\n",
    "                                    style={\"height\": \"620px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Information\",\n",
    "                            tab_id=\"tab-info\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Information.xlsx\",\n",
    "                                                id=\"info-export-btn\",\n",
    "                                                color=\"secondary\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"info-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"info-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    merge_duplicate_headers=True,\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    row_selectable=\"multi\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"overflowY\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                        \"maxHeight\": \"620px\",\n",
    "                                        \"borderRadius\": \"0.75rem\",\n",
    "                                        \"border\": \"1px solid #CFD8DC\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"6px 8px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"none\",\n",
    "                                        \"fontFamily\": '-apple-system, BlinkMacSystemFont, \"SF Pro Text\", \"Segoe UI\", system-ui, sans-serif',\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#ECEFF1\",\n",
    "                                        \"fontWeight\": \"600\",\n",
    "                                        \"borderBottom\": \"1px solid #CFD8DC\",\n",
    "                                        \"textTransform\": \"uppercase\",\n",
    "                                        \"fontSize\": 10,\n",
    "                                    },\n",
    "                                    style_data_conditional=[\n",
    "                                        {\n",
    "                                            \"if\": {\"row_index\": \"odd\"},\n",
    "                                            \"backgroundColor\": \"#FAFAFA\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\"state\": \"selected\"},\n",
    "                                            \"backgroundColor\": \"#E3F2FD\",\n",
    "                                            \"border\": \"1px solid #90CAF9\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\n",
    "                                                \"filter_query\": '{OOS} contains \"OOS\" || {OOS} = \"Yes\"'\n",
    "                                            },\n",
    "                                            \"backgroundColor\": \"#FFEBEE\",\n",
    "                                        },\n",
    "                                        {\n",
    "                                            \"if\": {\n",
    "                                                \"filter_query\": '{Risk} contains \"RISK\" || {Risk} = \"Yes\"'\n",
    "                                            },\n",
    "                                            \"backgroundColor\": \"#FFF8E1\",\n",
    "                                        },\n",
    "                                    ],\n",
    "                                ),\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Stock Criticality\",\n",
    "                            tab_id=\"tab-crit\",\n",
    "                            children=[\n",
    "                                dbc.Row(\n",
    "                                    [\n",
    "                                        dbc.Col(\n",
    "                                            dbc.Button(\n",
    "                                                \"📤 Download Criticality.xlsx\",\n",
    "                                                id=\"crit-export-btn\",\n",
    "                                                color=\"success\",\n",
    "                                                size=\"sm\",\n",
    "                                                className=\"mb-2\",\n",
    "                                            ),\n",
    "                                            width=\"auto\",\n",
    "                                        ),\n",
    "                                        dbc.Col(width=True),\n",
    "                                        dcc.Download(id=\"crit-download\"),\n",
    "                                    ],\n",
    "                                    className=\"mb-1\",\n",
    "                                ),\n",
    "                                dash_table.DataTable(\n",
    "                                    id=\"crit-table\",\n",
    "                                    columns=[],\n",
    "                                    data=[],\n",
    "                                    page_size=15,\n",
    "                                    export_format=\"xlsx\",\n",
    "                                    style_as_list_view=True,\n",
    "                                    sort_action=\"native\",\n",
    "                                    filter_action=\"native\",\n",
    "                                    style_table={\n",
    "                                        \"overflowX\": \"auto\",\n",
    "                                        \"minWidth\": \"100%\",\n",
    "                                        \"borderRadius\": \"0.75rem\",\n",
    "                                        \"border\": \"1px solid #CFD8DC\",\n",
    "                                    },\n",
    "                                    style_cell={\n",
    "                                        \"fontSize\": 11,\n",
    "                                        \"padding\": \"5px 6px\",\n",
    "                                        \"whiteSpace\": \"nowrap\",\n",
    "                                        \"border\": \"none\",\n",
    "                                        \"textAlign\": \"center\",\n",
    "                                        \"fontFamily\": '-apple-system, BlinkMacSystemFont, \"SF Pro Text\", \"Segoe UI\", system-ui, sans-serif',\n",
    "                                    },\n",
    "                                    style_header={\n",
    "                                        \"backgroundColor\": \"#ECEFF1\",\n",
    "                                        \"fontWeight\": \"600\",\n",
    "                                        \"borderBottom\": \"1px solid #CFD8DC\",\n",
    "                                        \"textTransform\": \"uppercase\",\n",
    "                                        \"fontSize\": 10,\n",
    "                                    },\n",
    "                                    style_data_conditional=[],\n",
    "                                ),\n",
    "                            ],\n",
    "                        ),\n",
    "                        dbc.Tab(\n",
    "                            label=\"Inter Rotation\",\n",
    "                            tab_id=\"tab-inter\",\n",
    "                            children=[\n",
    "                                dcc.Graph(\n",
    "                                    id=\"inter-rotation-map\",\n",
    "                                    style={\"height\": \"650px\"},\n",
    "                                )\n",
    "                            ],\n",
    "                        ),\n",
    "                    ],\n",
    "                )\n",
    "            ),\n",
    "            className=\"tab-card\",\n",
    "        ),\n",
    "    ],\n",
    "    fluid=True,\n",
    ")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# HELPER: APPLY FILTERS\n",
    "# =========================================================\n",
    "def apply_filters(\n",
    "    base_df,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    ignore=None,\n",
    "):\n",
    "    ignore = ignore or set()\n",
    "    df = base_df.copy()\n",
    "\n",
    "    if \"brand\" not in ignore and brands:\n",
    "        df = df[df[\"Brand\"].isin(brands)]\n",
    "    if \"plant\" not in ignore and plants:\n",
    "        df = df[df[\"Plant\"].isin(plants)]\n",
    "    if \"branch\" not in ignore and branches:\n",
    "        df = df[df[\"Branch\"].isin(branches)]\n",
    "    if \"class\" not in ignore and classes:\n",
    "        df = df[df[\"Class\"].isin(classes)]\n",
    "    if \"bu\" not in ignore and busunits:\n",
    "        df = df[df[\"BusinessUnit\"].isin(busunits)]\n",
    "    if \"sku\" not in ignore and ai_skus:\n",
    "        df = df[df[\"SKU\"].isin(ai_skus)]\n",
    "    if \"oversell\" not in ignore and oversell:\n",
    "        flags = [1 if v == \"Yes\" else 0 for v in oversell]\n",
    "        df = df[df[\"IsOversell\"].isin(flags)]\n",
    "    if \"risk\" not in ignore and risk:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        if \"Yes\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 1\n",
    "        if \"No\" in risk:\n",
    "            mask |= df[\"IsRisk\"] == 0\n",
    "        df = df[mask]\n",
    "\n",
    "    # branch DC band filtering\n",
    "    if \"dc\" not in ignore and branch_dc:\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for b in branch_dc:\n",
    "            if b == \"0\":\n",
    "                mask |= df[\"DaysToDepletion\"] <= 0\n",
    "            elif b == \"1-4\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(1, 4)\n",
    "            elif b == \"5-6\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(5, 6)\n",
    "            elif b == \"7-10\":\n",
    "                mask |= df[\"DaysToDepletion\"].between(7, 10)\n",
    "        df = df[mask]\n",
    "\n",
    "    # global search\n",
    "    if \"global\" not in ignore and global_search and global_search.strip():\n",
    "        gs = global_search.strip().lower()\n",
    "        search_cols = [\"SKU\", \"Brand\", \"BusinessUnit\", \"Branch\", \"Plant\", \"Class\"]\n",
    "        mask = pd.Series(False, index=df.index)\n",
    "        for col in search_cols:\n",
    "            mask |= df[col].astype(str).str.lower().str.contains(gs)\n",
    "        df = df[mask]\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: SHOW/HIDE FILTERS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"filter-collapse\", \"is_open\"),\n",
    "    Input(\"filter-toggle\", \"n_clicks\"),\n",
    "    State(\"filter-collapse\", \"is_open\"),\n",
    ")\n",
    "def toggle_filters(n, is_open):\n",
    "    if n:\n",
    "        return not is_open\n",
    "    return is_open\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: CASCADING FILTER OPTIONS\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"options\"),\n",
    "    Output(\"plant-filter\", \"options\"),\n",
    "    Output(\"branch-filter\", \"options\"),\n",
    "    Output(\"class-filter\", \"options\"),\n",
    "    Output(\"busunit-filter\", \"options\"),\n",
    "    Output(\"ai-sku-filter\", \"options\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    ")\n",
    "def update_filter_options(\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "):\n",
    "    # Brand options\n",
    "    df_brand = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"brand\"},\n",
    "    )\n",
    "    brand_opts = [{\"label\": b, \"value\": b} for b in sorted(df_brand[\"Brand\"].unique())]\n",
    "\n",
    "    # Plant options\n",
    "    df_plant = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"plant\"},\n",
    "    )\n",
    "    plant_opts = [{\"label\": p, \"value\": p} for p in sorted(df_plant[\"Plant\"].unique())]\n",
    "\n",
    "    # Branch options\n",
    "    df_branch = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"branch\"},\n",
    "    )\n",
    "    branch_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_branch[\"Branch\"].unique())\n",
    "    ]\n",
    "\n",
    "    # Class options\n",
    "    df_class = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"class\"},\n",
    "    )\n",
    "    class_opts = [\n",
    "        {\"label\": c, \"value\": c} for c in sorted(df_class[\"Class\"].unique())\n",
    "    ]\n",
    "\n",
    "    # BU options\n",
    "    df_bu = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"bu\"},\n",
    "    )\n",
    "    bu_opts = [\n",
    "        {\"label\": b, \"value\": b} for b in sorted(df_bu[\"BusinessUnit\"].unique())\n",
    "    ]\n",
    "\n",
    "    # SKU options\n",
    "    df_sku = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "        ignore={\"sku\"},\n",
    "    )\n",
    "    sku_opts = [{\"label\": s, \"value\": s} for s in sorted(df_sku[\"SKU\"].unique())]\n",
    "\n",
    "    return brand_opts, plant_opts, branch_opts, class_opts, bu_opts, sku_opts\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CALLBACK: DROPDOWN CLASS (chip display logic)\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"brand-filter\", \"className\"),\n",
    "    Output(\"plant-filter\", \"className\"),\n",
    "    Output(\"branch-filter\", \"className\"),\n",
    "    Output(\"class-filter\", \"className\"),\n",
    "    Output(\"busunit-filter\", \"className\"),\n",
    "    Output(\"ai-sku-filter\", \"className\"),\n",
    "    Output(\"branch-dc-filter\", \"className\"),\n",
    "    Output(\"oversell-filter\", \"className\"),\n",
    "    Output(\"risk-filter\", \"className\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    ")\n",
    "def update_dropdown_classes(\n",
    "    brand_v,\n",
    "    plant_v,\n",
    "    branch_v,\n",
    "    class_v,\n",
    "    bu_v,\n",
    "    sku_v,\n",
    "    dc_v,\n",
    "    oversell_v,\n",
    "    risk_v,\n",
    "):\n",
    "    def cls(v):\n",
    "        if v and len(v) == 1:\n",
    "            return \"fixed-multi-dropdown show-chips\"\n",
    "        return \"fixed-multi-dropdown hide-chips\"\n",
    "\n",
    "    return (\n",
    "        cls(brand_v),\n",
    "        cls(plant_v),\n",
    "        cls(branch_v),\n",
    "        cls(class_v),\n",
    "        cls(bu_v),\n",
    "        cls(sku_v),\n",
    "        cls(dc_v),\n",
    "        cls(oversell_v),\n",
    "        cls(risk_v),\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# MAIN DASHBOARD CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"kpi-row\", \"children\"),\n",
    "    Output(\"plant-inv-chart\", \"figure\"),\n",
    "    Output(\"oos-risk-bar\", \"figure\"),\n",
    "    Output(\"branch-oos-treemap\", \"figure\"),\n",
    "    Output(\"info-table\", \"columns\"),\n",
    "    Output(\"info-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"columns\"),\n",
    "    Output(\"crit-table\", \"data\"),\n",
    "    Output(\"crit-table\", \"style_data_conditional\"),\n",
    "    Output(\"inter-rotation-map\", \"figure\"),\n",
    "    Output(\"last-refresh\", \"children\"),\n",
    "    Input(\"view-mode\", \"value\"),\n",
    "    Input(\"brand-filter\", \"value\"),\n",
    "    Input(\"plant-filter\", \"value\"),\n",
    "    Input(\"branch-filter\", \"value\"),\n",
    "    Input(\"class-filter\", \"value\"),\n",
    "    Input(\"busunit-filter\", \"value\"),\n",
    "    Input(\"ai-sku-filter\", \"value\"),\n",
    "    Input(\"branch-dc-filter\", \"value\"),\n",
    "    Input(\"oversell-filter\", \"value\"),\n",
    "    Input(\"risk-filter\", \"value\"),\n",
    "    Input(\"global-search\", \"value\"),\n",
    "    Input(\"refresh-interval\", \"n_intervals\"),\n",
    ")\n",
    "def update_dashboard(\n",
    "    view_mode,\n",
    "    brands,\n",
    "    plants,\n",
    "    branches,\n",
    "    classes,\n",
    "    busunits,\n",
    "    ai_skus,\n",
    "    branch_dc,\n",
    "    oversell,\n",
    "    risk,\n",
    "    global_search,\n",
    "    n_intervals,\n",
    "):\n",
    "    # ---- Filtered data\n",
    "    dff = apply_filters(\n",
    "        df_full,\n",
    "        brands,\n",
    "        plants,\n",
    "        branches,\n",
    "        classes,\n",
    "        busunits,\n",
    "        ai_skus,\n",
    "        branch_dc,\n",
    "        oversell,\n",
    "        risk,\n",
    "        global_search,\n",
    "    )\n",
    "    dff_filtered = dff.copy()\n",
    "\n",
    "    dff_filtered[\"BalanceSupply\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"BalanceSupply\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "    dff_filtered[\"Total_SKU_Plant_Inventory\"] = pd.to_numeric(\n",
    "        dff_filtered.get(\"Total_SKU_Plant_Inventory\", 0), errors=\"coerce\"\n",
    "    ).fillna(0)\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # OOS calculation per SKU+Plant (for treemap + KPI)\n",
    "    # -----------------------------------------------------\n",
    "    if not dff_filtered.empty:\n",
    "        oos_group = (\n",
    "            dff_filtered.groupby([\"SKU\", \"Plant\"], as_index=False)\n",
    "            .agg(\n",
    "                BalanceSupply_total=(\"BalanceSupply\", \"sum\"),\n",
    "                TotalPlantInv=(\"Total_SKU_Plant_Inventory\", \"max\"),\n",
    "            )\n",
    "        )\n",
    "        oos_group[\"OOS_Cases\"] = (\n",
    "            oos_group[\"BalanceSupply_total\"] - oos_group[\"TotalPlantInv\"]\n",
    "        ).clip(lower=0)\n",
    "\n",
    "        total_oos_cases = int(oos_group[\"OOS_Cases\"].sum())\n",
    "\n",
    "        # bring Brand for treemap\n",
    "        sku_plant_brand = (\n",
    "            dff_filtered[[\"SKU\", \"Plant\", \"Brand\"]].drop_duplicates().copy()\n",
    "        )\n",
    "        oos_treemap = oos_group.merge(\n",
    "            sku_plant_brand, on=[\"SKU\", \"Plant\"], how=\"left\"\n",
    "        )\n",
    "        oos_treemap.rename(\n",
    "            columns={\"BalanceSupply_total\": \"BalanceSupply\"}, inplace=True\n",
    "        )\n",
    "    else:\n",
    "        oos_group = pd.DataFrame(columns=[\"SKU\", \"Plant\", \"BalanceSupply_total\", \"TotalPlantInv\", \"OOS_Cases\"])\n",
    "        oos_treemap = pd.DataFrame(columns=[\"SKU\", \"Plant\", \"Brand\", \"BalanceSupply\", \"TotalPlantInv\", \"OOS_Cases\"])\n",
    "        total_oos_cases = 0\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # KPIs\n",
    "    # -----------------------------------------------------\n",
    "    total_sku_10d = dff_filtered[\"SKU\"].nunique()\n",
    "    bal_supply_sum = int(dff_filtered[\"BalanceSupply\"].sum())\n",
    "    risk_count = int(dff_filtered[\"IsRisk\"].sum())\n",
    "    bo_count = int(dff_filtered[\"IsBackorder\"].sum())\n",
    "    low_cover = int(dff_filtered[\"IsLowCover\"].sum())\n",
    "    oversell_count = int(dff_filtered[\"IsOversell\"].sum())\n",
    "\n",
    "    # KPI trend directions (simple)\n",
    "    oos_trend = \"up\" if total_oos_cases > 0 else \"flat\"\n",
    "    risk_trend = \"up\" if risk_count > 0 else \"flat\"\n",
    "    bo_trend = \"up\" if bo_count > 0 else \"flat\"\n",
    "    oversell_trend = \"up\" if oversell_count > 0 else \"flat\"\n",
    "    bal_trend = \"up\" if bal_supply_sum > 0 else \"flat\"\n",
    "\n",
    "    if view_mode == \"executive\":\n",
    "        cards = [\n",
    "            kpi_card(\"SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\n",
    "                \"Supply Risk SKUs\", risk_count, color=\"warning\", trend=risk_trend\n",
    "            ),\n",
    "            kpi_card(\"Backorder SKUs\", bo_count, color=\"danger\", trend=bo_trend),\n",
    "            kpi_card(\"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend),\n",
    "        ]\n",
    "    else:\n",
    "        cards = [\n",
    "            kpi_card(\"Total SKUs 0–10 Days Cover\", total_sku_10d, trend=\"flat\"),\n",
    "            kpi_card(\"Balance Supply – Cases\", f\"{bal_supply_sum:,}\", trend=bal_trend),\n",
    "            kpi_card(\n",
    "                \"Total OOS Cases\",\n",
    "                f\"{total_oos_cases:,}\",\n",
    "                color=\"danger\",\n",
    "                trend=oos_trend,\n",
    "            ),\n",
    "            kpi_card(\"Total Supply Risk SKUs\", risk_count, trend=risk_trend),\n",
    "            kpi_card(\"Total Backorder SKUs\", bo_count, trend=bo_trend),\n",
    "            kpi_card(\"<10d Cover SKUs\", low_cover, trend=\"flat\"),\n",
    "            kpi_card(\n",
    "                \"Oversell SKUs\", oversell_count, color=\"info\", trend=oversell_trend\n",
    "            ),\n",
    "        ]\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # Info table columns (UpcomingPlan in both views)\n",
    "    # -----------------------------------------------------\n",
    "    if view_mode == \"executive\":\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "    else:\n",
    "        info_columns = [\n",
    "            {\"name\": \"Plant\", \"id\": \"Plant\", \"type\": \"text\"},\n",
    "            {\"name\": \"SKU\", \"id\": \"SKU\", \"type\": \"text\"},\n",
    "            {\"name\": \"Brand\", \"id\": \"Brand\", \"type\": \"text\"},\n",
    "            {\"name\": \"BusinessUnit\", \"id\": \"BusinessUnit\", \"type\": \"text\"},\n",
    "            {\"name\": \"Branch\", \"id\": \"Branch\", \"type\": \"text\"},\n",
    "            {\"name\": \"Class\", \"id\": \"Class\", \"type\": \"text\"},\n",
    "            {\"name\": \"Days<10\", \"id\": \"DaysLess10\", \"type\": \"text\"},\n",
    "            {\"name\": \"OOS\", \"id\": \"OOS\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"PlantInv %\",\n",
    "                \"id\": \"PlantInvPerc\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": FormatTemplate.percentage(1),\n",
    "            },\n",
    "            {\"name\": \"Oversell\", \"id\": \"Oversell\", \"type\": \"text\"},\n",
    "            {\"name\": \"Risk\", \"id\": \"Risk\", \"type\": \"text\"},\n",
    "            {\n",
    "                \"name\": \"MTD Sales\",\n",
    "                \"id\": \"MTD_Sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Forecast\",\n",
    "                \"id\": \"Forecast\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Avg 3M Sales\",\n",
    "                \"id\": \"Avg_3MNTH_sales\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\n",
    "                \"name\": \"Balance Supply\",\n",
    "                \"id\": \"BalanceSupply\",\n",
    "                \"type\": \"numeric\",\n",
    "                \"format\": Format(group=Group.yes, scheme=Scheme.fixed, precision=0),\n",
    "            },\n",
    "            {\"name\": \"Upcoming Plan\", \"id\": \"UpcomingPlan\", \"type\": \"text\"},\n",
    "            {\"name\": \"Depletion Date\", \"id\": \"DepletionDate\", \"type\": \"text\"},\n",
    "        ]\n",
    "\n",
    "    # date columns for table\n",
    "    dff_filtered[\"DepletionDate\"] = dff_filtered[\"DepletionDate_parsed\"].dt.date\n",
    "    dff_filtered[\"UpcomingPlan\"] = dff_filtered[\"UpcomingPlan_parsed\"].dt.date\n",
    "    info_data = dff_filtered[[c[\"id\"] for c in info_columns]].to_dict(\"records\")\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # Theming helper (single \"light\" theme)\n",
    "    # -----------------------------------------------------\n",
    "    def apply_theme(fig):\n",
    "        fig.update_layout(\n",
    "            template=\"plotly\",\n",
    "            paper_bgcolor=\"#ffffff\",\n",
    "            plot_bgcolor=\"#ffffff\",\n",
    "            font_color=\"#263238\",\n",
    "            font=dict(family='-apple-system, BlinkMacSystemFont, \"SF Pro Text\", \"Segoe UI\", system-ui, sans-serif'),\n",
    "        )\n",
    "        return fig\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # Plant Inventory Treemap\n",
    "    # Brand → Plant → SKU, size = BalanceSupply, color = OOS_Cases\n",
    "    # -----------------------------------------------------\n",
    "    if not oos_treemap.empty:\n",
    "        dff_agg = oos_treemap.copy()\n",
    "        dff_agg[\"BalanceSupply\"] = dff_agg[\"BalanceSupply\"].clip(lower=0)\n",
    "        dff_agg[\"OOS_Cases\"] = dff_agg[\"OOS_Cases\"].fillna(0)\n",
    "\n",
    "        material_scale = [\n",
    "            [0.0, \"#E8F5E9\"],   # light green\n",
    "            [0.00001, \"#C8E6C9\"],\n",
    "            [0.25, \"#FFF9C4\"],  # soft yellow\n",
    "            [0.5, \"#FFE082\"],   # amber\n",
    "            [0.75, \"#FFAB91\"],  # orange\n",
    "            [1.0, \"#E53935\"],   # red\n",
    "        ]\n",
    "\n",
    "        fig_inv = px.treemap(\n",
    "            dff_agg,\n",
    "            path=[\"Brand\", \"Plant\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"OOS_Cases\",\n",
    "            color_continuous_scale=material_scale,\n",
    "            custom_data=[\"BalanceSupply\", \"OOS_Cases\", \"TotalPlantInv\"],\n",
    "        )\n",
    "        fig_inv.update_traces(\n",
    "            texttemplate=\"<b>%{label}</b><br>%{value:,.0f} cs\",\n",
    "            hovertemplate=(\n",
    "                \"<b>%{label}</b><br>\"\n",
    "                \"Balance Supply: %{customdata[0]:,.0f} cs<br>\"\n",
    "                \"OOS Gap: %{customdata[1]:,.0f} cs<br>\"\n",
    "                \"Plant Inventory: %{customdata[2]:,.0f} cs\"\n",
    "                \"<extra></extra>\"\n",
    "            ),\n",
    "        )\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory Overview\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "            coloraxis_colorbar={\"title\": \"OOS Gap (cs)\"},\n",
    "        )\n",
    "    else:\n",
    "        fig_inv = go.Figure()\n",
    "        fig_inv.update_layout(\n",
    "            title=\"Plant Inventory Overview\",\n",
    "            margin=dict(t=40, l=10, r=10, b=10),\n",
    "        )\n",
    "    fig_inv = apply_theme(fig_inv)\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # OOS & Risk bar (cases)\n",
    "    # -----------------------------------------------------\n",
    "    if not dff_filtered.empty:\n",
    "        if view_mode == \"executive\":\n",
    "            group_col = \"BusinessUnit\"\n",
    "            title_bar = \"OOS & Risk Exposure (Cases) by Business Unit\"\n",
    "        else:\n",
    "            group_col = \"Brand\"\n",
    "            title_bar = \"OOS & Risk Exposure (Cases) by Brand\"\n",
    "\n",
    "        # allocate OOS_Cases from SKU+Plant to groups, proportional to BalanceSupply\n",
    "        if not oos_group.empty:\n",
    "            oos_join = dff_filtered.merge(\n",
    "                oos_group[[\"SKU\", \"Plant\", \"BalanceSupply_total\", \"OOS_Cases\"]],\n",
    "                on=[\"SKU\", \"Plant\"],\n",
    "                how=\"left\",\n",
    "            )\n",
    "            oos_join[\"BalanceSupply_total\"] = oos_join[\"BalanceSupply_total\"].replace(0, np.nan)\n",
    "            oos_join[\"OOS_weight\"] = (\n",
    "                oos_join[\"BalanceSupply\"] / oos_join[\"BalanceSupply_total\"]\n",
    "            )\n",
    "            oos_join[\"OOS_weight\"] = oos_join[\"OOS_weight\"].fillna(0)\n",
    "            oos_join[\"OOS_Cases_alloc\"] = oos_join[\"OOS_weight\"] * oos_join[\"OOS_Cases\"]\n",
    "\n",
    "            oos_by_group = (\n",
    "                oos_join.groupby(group_col)[\"OOS_Cases_alloc\"]\n",
    "                .sum()\n",
    "                .fillna(0)\n",
    "                .rename(\"OOS_Cases\")\n",
    "            )\n",
    "        else:\n",
    "            oos_by_group = pd.Series(dtype=float, name=\"OOS_Cases\")\n",
    "\n",
    "        # risk cases = BalanceSupply on risk SKUs\n",
    "        risk_by_group = (\n",
    "            dff_filtered[dff_filtered[\"IsRisk\"] == 1]\n",
    "            .groupby(group_col)[\"BalanceSupply\"]\n",
    "            .sum()\n",
    "            .fillna(0)\n",
    "            .rename(\"Risk_Cases\")\n",
    "        )\n",
    "\n",
    "        summary_df = (\n",
    "            pd.concat([oos_by_group, risk_by_group], axis=1)\n",
    "            .fillna(0)\n",
    "            .reset_index()\n",
    "        )\n",
    "    else:\n",
    "        summary_df = pd.DataFrame(\n",
    "            columns=[\"Group\", \"OOS_Cases\", \"Risk_Cases\"]\n",
    "        )\n",
    "        group_col = \"Group\"\n",
    "        title_bar = \"OOS & Risk Exposure\"\n",
    "\n",
    "    fig_bar = go.Figure()\n",
    "    if not summary_df.empty:\n",
    "        fig_bar.add_bar(\n",
    "            name=\"OOS Gap (cs)\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"OOS_Cases\"],\n",
    "            marker_color=\"#E53935\",\n",
    "            text=[f\"{v:,.0f}\" for v in summary_df[\"OOS_Cases\"]],\n",
    "            textposition=\"outside\",\n",
    "            hovertemplate=(\n",
    "                \"<b>%{x}</b><br>\"\n",
    "                \"OOS Gap: %{y:,.0f} cs\"\n",
    "                \"<extra></extra>\"\n",
    "            ),\n",
    "        )\n",
    "        fig_bar.add_bar(\n",
    "            name=\"Risk Exposure (cs)\",\n",
    "            x=summary_df[group_col],\n",
    "            y=summary_df[\"Risk_Cases\"],\n",
    "            marker_color=\"#FB8C00\",\n",
    "            text=[f\"{v:,.0f}\" for v in summary_df[\"Risk_Cases\"]],\n",
    "            textposition=\"outside\",\n",
    "            hovertemplate=(\n",
    "                \"<b>%{x}</b><br>\"\n",
    "                \"Risk Exposure: %{y:,.0f} cs\"\n",
    "                \"<extra></extra>\"\n",
    "            ),\n",
    "        )\n",
    "    fig_bar.update_layout(\n",
    "        barmode=\"group\",\n",
    "        title=title_bar,\n",
    "        margin=dict(t=60, b=130, l=10, r=10),\n",
    "        xaxis_tickangle=-30,\n",
    "        legend=dict(\n",
    "            orientation=\"h\",\n",
    "            yanchor=\"bottom\",\n",
    "            y=1.02,\n",
    "            xanchor=\"right\",\n",
    "            x=1,\n",
    "        ),\n",
    "    )\n",
    "    fig_bar = apply_theme(fig_bar)\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # Branch OOS Treemap (by BalanceSupply)\n",
    "    # -----------------------------------------------------\n",
    "    treemap_df = (\n",
    "        dff_filtered.groupby([\"Branch\", \"Brand\", \"SKU\"])[\"BalanceSupply\"]\n",
    "        .sum()\n",
    "        .reset_index(name=\"BalanceSupply\")\n",
    "    )\n",
    "    if not treemap_df.empty:\n",
    "        fig_treemap = px.treemap(\n",
    "            treemap_df,\n",
    "            path=[\"Branch\", \"Brand\", \"SKU\"],\n",
    "            values=\"BalanceSupply\",\n",
    "            color=\"Branch\",\n",
    "            hover_data=[\"SKU\", \"BalanceSupply\"],\n",
    "        )\n",
    "        fig_treemap.update_traces(\n",
    "            hovertemplate=(\n",
    "                \"<b>%{label}</b><br>\"\n",
    "                \"SKU: %{customdata[0]}<br>\"\n",
    "                \"Balance Supply: %{customdata[1]:,} cs\"\n",
    "                \"<extra></extra>\"\n",
    "            )\n",
    "        )\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    else:\n",
    "        fig_treemap = go.Figure()\n",
    "        fig_treemap.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "    fig_treemap = apply_theme(fig_treemap)\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # Stock Criticality Table\n",
    "    # heatmap style: red worst → yellow → white (OK)\n",
    "    # only branches present in filtered data\n",
    "    # -----------------------------------------------------\n",
    "    crit_columns = []\n",
    "    crit_data = []\n",
    "    style_data_conditional = []\n",
    "\n",
    "    try:\n",
    "        if not dff_filtered.empty and not df_crit.empty:\n",
    "            crit_filtered = df_crit.copy()\n",
    "            base_cols = [\"AI_SKU\", \"AI_MFGBRND\"]\n",
    "\n",
    "            valid_skus = set(dff_filtered[\"SKU\"].astype(str).unique())\n",
    "            valid_brands = set(dff_filtered[\"Brand\"].astype(str).unique())\n",
    "            branch_set = set(dff_filtered[\"Branch\"].unique())\n",
    "\n",
    "            # filter rows (SKUs / Brands)\n",
    "            if valid_skus:\n",
    "                crit_filtered = crit_filtered[\n",
    "                    crit_filtered[\"AI_SKU\"].astype(str).isin(valid_skus)\n",
    "                ]\n",
    "            if valid_brands:\n",
    "                crit_filtered = crit_filtered[\n",
    "                    crit_filtered[\"AI_MFGBRND\"].astype(str).str.upper().isin(valid_brands)\n",
    "                ]\n",
    "\n",
    "            # branch columns = intersection of crit sheet columns and filtered branches\n",
    "            branch_set = set(dff_filtered[\"Branch\"].unique())\n",
    "            branch_cols = [\n",
    "                c for c in crit_filtered.columns if c not in base_cols and c in branch_set\n",
    "            ]\n",
    "\n",
    "            if branch_cols:\n",
    "                for col in branch_cols:\n",
    "                    crit_filtered[col] = (\n",
    "                        pd.to_numeric(crit_filtered[col], errors=\"coerce\")\n",
    "                        .round(0)\n",
    "                        .astype(\"Int64\")\n",
    "                    )\n",
    "\n",
    "                final_cols = base_cols + branch_cols\n",
    "                crit_filtered = crit_filtered[final_cols]\n",
    "                crit_filtered = crit_filtered.replace({np.nan: None})\n",
    "\n",
    "                crit_columns = [{\"name\": c, \"id\": c} for c in final_cols]\n",
    "                crit_data = crit_filtered.to_dict(\"records\")\n",
    "\n",
    "                # bands: 0 = deep red, 1–2 dark red, 3–4 bright red, 5–6 light red, 7–8 pale green, 9–10 green, >10 dark green\n",
    "                bands = [\n",
    "                    (0, 0, \"#B71C1C\", \"white\"),\n",
    "                    (1, 2, \"#D32F2F\", \"white\"),\n",
    "                    (3, 4, \"#F44336\", \"white\"),\n",
    "                    (5, 6, \"#FFCDD2\", \"#212121\"),\n",
    "                    (7, 8, \"#FFFDE7\", \"#212121\"),\n",
    "                    (9, 10, \"#C8E6C9\", \"#212121\"),\n",
    "                    (11, 9999, \"#2E7D32\", \"white\"),\n",
    "                ]\n",
    "                for col in branch_cols:\n",
    "                    for low, high, bg, font in bands:\n",
    "                        style_data_conditional.append(\n",
    "                            {\n",
    "                                \"if\": {\n",
    "                                    \"column_id\": col,\n",
    "                                    \"filter_query\": f\"{{{col}}} >= {low} && {{{col}}} <= {high}\",\n",
    "                                },\n",
    "                                \"backgroundColor\": bg,\n",
    "                                \"color\": font,\n",
    "                            }\n",
    "                        )\n",
    "                    style_data_conditional.append(\n",
    "                        {\n",
    "                            \"if\": {\n",
    "                                \"column_id\": col,\n",
    "                                \"filter_query\": f\"{{{col}}} is blank\",\n",
    "                            },\n",
    "                            \"backgroundColor\": \"#ECEFF1\",\n",
    "                            \"color\": \"#90A4AE\",\n",
    "                        }\n",
    "                    )\n",
    "    except Exception as e:\n",
    "        print(\"CRIT TABLE ERROR:\", e)\n",
    "        crit_columns = []\n",
    "        crit_data = []\n",
    "        style_data_conditional = []\n",
    "\n",
    "    # -----------------------------------------------------\n",
    "    # Inter-rotation Map\n",
    "    # If exactly one SKU in filtered data → show network from donors → OOS branches\n",
    "    # Else → bubble map by cases only\n",
    "    # -----------------------------------------------------\n",
    "    if not dff_filtered.empty:\n",
    "        unique_skus = dff_filtered[\"SKU\"].nunique()\n",
    "    else:\n",
    "        unique_skus = 0\n",
    "\n",
    "    if unique_skus == 1:\n",
    "        sku_sel = dff_filtered[\"SKU\"].unique()[0]\n",
    "\n",
    "        # donor branches from InterRotation\n",
    "        df_inter = explode_interrotation(dff_filtered[dff_filtered[\"SKU\"] == sku_sel])\n",
    "\n",
    "        if not df_inter.empty:\n",
    "            df_inter = df_inter.merge(\n",
    "                df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\"\n",
    "            ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "            # OOS branches for this SKU\n",
    "            oos_nodes = (\n",
    "                dff_filtered[\n",
    "                    (dff_filtered[\"SKU\"] == sku_sel) & (dff_filtered[\"IsOOS\"] == 1)\n",
    "                ]\n",
    "                .merge(df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\")\n",
    "                .dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "            )\n",
    "\n",
    "            # build nodes\n",
    "            donors = df_inter[[\"Branch\", \"Latitude\", \"Longitude\"]].drop_duplicates()\n",
    "            donors[\"NodeType\"] = \"Donor\"\n",
    "\n",
    "            targets = oos_nodes[[\"Branch\", \"Latitude\", \"Longitude\"]].drop_duplicates()\n",
    "            targets[\"NodeType\"] = \"OOS\"\n",
    "\n",
    "            nodes = (\n",
    "                pd.concat([donors, targets])\n",
    "                .drop_duplicates(subset=[\"Branch\", \"Latitude\", \"Longitude\", \"NodeType\"])\n",
    "                .reset_index(drop=True)\n",
    "            )\n",
    "\n",
    "            # scatter nodes\n",
    "            fig_inter = go.Figure()\n",
    "\n",
    "            for node_type, color in [\n",
    "                (\"Donor\", \"#1E88E5\"),\n",
    "                (\"OOS\", \"#E53935\"),\n",
    "            ]:\n",
    "                subset = nodes[nodes[\"NodeType\"] == node_type]\n",
    "                if subset.empty:\n",
    "                    continue\n",
    "                fig_inter.add_trace(\n",
    "                    go.Scattermapbox(\n",
    "                        lat=subset[\"Latitude\"],\n",
    "                        lon=subset[\"Longitude\"],\n",
    "                        mode=\"markers\",\n",
    "                        marker=dict(size=12, color=color),\n",
    "                        name=node_type,\n",
    "                        text=subset[\"Branch\"],\n",
    "                        hovertemplate=(\n",
    "                            \"<b>%{text}</b><br>\"\n",
    "                            f\"Type: {node_type}<br>\"\n",
    "                            f\"SKU: {sku_sel}\"\n",
    "                            \"<extra></extra>\"\n",
    "                        ),\n",
    "                    )\n",
    "                )\n",
    "\n",
    "            # edges from each donor to each OOS\n",
    "            if not donors.empty and not targets.empty:\n",
    "                edge_lats = []\n",
    "                edge_lons = []\n",
    "                for _, drow in donors.iterrows():\n",
    "                    for _, trow in targets.iterrows():\n",
    "                        edge_lats += [drow[\"Latitude\"], trow[\"Latitude\"], None]\n",
    "                        edge_lons += [drow[\"Longitude\"], trow[\"Longitude\"], None]\n",
    "\n",
    "                fig_inter.add_trace(\n",
    "                    go.Scattermapbox(\n",
    "                        lat=edge_lats,\n",
    "                        lon=edge_lons,\n",
    "                        mode=\"lines\",\n",
    "                        line=dict(width=2, color=\"#90A4AE\"),\n",
    "                        hoverinfo=\"skip\",\n",
    "                        showlegend=False,\n",
    "                    )\n",
    "                )\n",
    "\n",
    "            fig_inter.update_layout(\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                mapbox_zoom=4,\n",
    "                mapbox_center={\n",
    "                    \"lat\": nodes[\"Latitude\"].mean(),\n",
    "                    \"lon\": nodes[\"Longitude\"].mean(),\n",
    "                },\n",
    "                margin=dict(t=40, l=10, r=10, b=10),\n",
    "                title=f\"Inter-Rotation Network for SKU {sku_sel}\",\n",
    "            )\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "            fig_inter.update_layout(\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                mapbox_zoom=3,\n",
    "                margin=dict(t=40, l=10, r=10, b=10),\n",
    "                title=\"Inter-Rotation Network\",\n",
    "            )\n",
    "    else:\n",
    "        # default bubble map view\n",
    "        df_inter = explode_interrotation(dff_filtered)\n",
    "        if not df_inter.empty:\n",
    "            df_map = df_inter.merge(\n",
    "                df_coord, left_on=\"Branch\", right_on=\"AI_BRANCH\", how=\"left\"\n",
    "            ).dropna(subset=[\"Latitude\", \"Longitude\"])\n",
    "\n",
    "            df_map[\"Label\"] = df_map.apply(\n",
    "                lambda x: f\"{x['Branch']} ({x['Cases']} cs) – {x['Brand']}\", axis=1\n",
    "            )\n",
    "            fig_inter = px.scatter_mapbox(\n",
    "                df_map,\n",
    "                lat=\"Latitude\",\n",
    "                lon=\"Longitude\",\n",
    "                size=\"Cases\",\n",
    "                color=\"Brand\",\n",
    "                text=\"Branch\",\n",
    "                hover_name=\"Label\",\n",
    "                hover_data={\"Cases\": True, \"Latitude\": False, \"Longitude\": False},\n",
    "                zoom=4,\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                title=\"Inter-Rotation Map\",\n",
    "                size_max=28,\n",
    "            )\n",
    "            fig_inter.update_traces(\n",
    "                hovertemplate=(\n",
    "                    \"<b>%{hovertext}</b><br>\"\n",
    "                    \"Cases: %{marker.size:,.0f} cs\"\n",
    "                    \"<extra></extra>\"\n",
    "                )\n",
    "            )\n",
    "            fig_inter.update_layout(margin=dict(t=40, l=10, r=10, b=10))\n",
    "        else:\n",
    "            fig_inter = go.Figure()\n",
    "            fig_inter.update_layout(\n",
    "                mapbox_style=\"carto-positron\",\n",
    "                mapbox_zoom=3,\n",
    "                margin=dict(t=40, l=10, r=10, b=10),\n",
    "                title=\"Inter-Rotation Map\",\n",
    "            )\n",
    "\n",
    "    fig_inter = apply_theme(fig_inter)\n",
    "\n",
    "    last_refresh = \"Last refresh: \" + datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n",
    "\n",
    "    return (\n",
    "        cards,\n",
    "        fig_inv,\n",
    "        fig_bar,\n",
    "        fig_treemap,\n",
    "        info_columns,\n",
    "        info_data,\n",
    "        crit_columns,\n",
    "        crit_data,\n",
    "        style_data_conditional,\n",
    "        fig_inter,\n",
    "        last_refresh,\n",
    "    )\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# CRITICALITY EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"crit-download\", \"data\"),\n",
    "    Input(\"crit-export-btn\", \"n_clicks\"),\n",
    "    State(\"crit-table\", \"data\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_criticality(n_clicks, rows):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Criticality\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Stock_Criticality.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# INFORMATION EXPORT CALLBACK\n",
    "# =========================================================\n",
    "@app.callback(\n",
    "    Output(\"info-download\", \"data\"),\n",
    "    Input(\"info-export-btn\", \"n_clicks\"),\n",
    "    State(\"info-table\", \"data\"),\n",
    "    prevent_initial_call=True,\n",
    ")\n",
    "def export_information(n_clicks, rows):\n",
    "    if not n_clicks or not rows:\n",
    "        return dash.no_update\n",
    "\n",
    "    df = pd.DataFrame(rows)\n",
    "\n",
    "    def to_xlsx(bytes_io):\n",
    "        with pd.ExcelWriter(bytes_io, engine=\"xlsxwriter\") as writer:\n",
    "            df.to_excel(writer, index=False, sheet_name=\"Information\")\n",
    "\n",
    "    return send_bytes(to_xlsx, \"Information.xlsx\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# LABEL COUNTS\n",
    "# =========================================================\n",
    "@app.callback(Output(\"brand-count-label\", \"children\"), Input(\"brand-filter\", \"value\"))\n",
    "def _brand_count(v):\n",
    "    return _count_label(v, \"Brand\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"plant-count-label\", \"children\"), Input(\"plant-filter\", \"value\"))\n",
    "def _plant_count(v):\n",
    "    return _count_label(v, \"Plant\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"branch-count-label\", \"children\"), Input(\"branch-filter\", \"value\"))\n",
    "def _branch_count(v):\n",
    "    return _count_label(v, \"Branch\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"class-count-label\", \"children\"), Input(\"class-filter\", \"value\"))\n",
    "def _class_count(v):\n",
    "    return _count_label(v, \"Class\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"bu-count-label\", \"children\"), Input(\"busunit-filter\", \"value\"))\n",
    "def _bu_count(v):\n",
    "    return _count_label(v, \"BU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"sku-count-label\", \"children\"), Input(\"ai-sku-filter\", \"value\"))\n",
    "def _sku_count(v):\n",
    "    return _count_label(v, \"SKU\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"dc-count-label\", \"children\"), Input(\"branch-dc-filter\", \"value\"))\n",
    "def _dc_count(v):\n",
    "    return _count_label(v, \"DC Days\")\n",
    "\n",
    "\n",
    "@app.callback(\n",
    "    Output(\"oversell-count-label\", \"children\"), Input(\"oversell-filter\", \"value\")\n",
    ")\n",
    "def _oversell_count(v):\n",
    "    return _count_label(v, \"Oversell\")\n",
    "\n",
    "\n",
    "@app.callback(Output(\"risk-count-label\", \"children\"), Input(\"risk-filter\", \"value\"))\n",
    "def _risk_count(v):\n",
    "    return _count_label(v, \"Risk\")\n",
    "\n",
    "\n",
    "# =========================================================\n",
    "# RUN APP\n",
    "# =========================================================\n",
    "if __name__ == \"__main__\":\n",
    "    print(f\"Dashboard running at http://127.0.0.1:{SERVER_PORT}\")\n",
    "    app.run(port=SERVER_PORT, debug=True, host=\"127.0.0.1\")\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
